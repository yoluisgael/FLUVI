<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Simulador de Calles Dinámicas</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <link rel="stylesheet" href="estilos.css">
  <link rel="stylesheet" href="minimapa.css">
</head>

<body>
  <!-- ========== PANTALLA DE CARGA ========== -->
  <div id="loadingScreen">
    <div class="loading-content">
      <div class="loading-header">
        <h1>Simulador de Tráfico FLUVI</h1>
        <p>Cargando simulación...</p>
      </div>

      <div class="loading-spinner">
        <div class="spinner"></div>
      </div>

      <div class="instructions">
        <div class="instruction-card">
          <h3>🖱️ Controles Básicos</h3>
          <p>Usa la rueda del mouse para hacer zoom. Arrastra el canvas para moverte. Haz clic en las celdas para agregar/quitar vehículos.</p>
        </div>

        <div class="instruction-card">
          <h3>⚙️ Selección Rápida</h3>
          <p>Presiona Ctrl+Clic (⌘+Clic en Mac) sobre calles o edificios en el canvas para seleccionarlos al instante. También puedes usar los menús desplegables.</p>
        </div>

        <div class="instruction-card">
          <h3>⏸️ Simulación</h3>
          <p>Pausa, avanza paso a paso, ajusta la velocidad y visualiza métricas de tu simulación.</p>
        </div>

        <div class="instruction-card">
          <h3>✏️ Modo Edición</h3>
          <p>Selecciona una calle o edificio y activa el modo edición para reposicionar y rotar visualmente.</p>
        </div>

        <div class="instruction-card">
          <h3>🌊 Curvas en Calles</h3>
          <p>Activa el modo curva y arrastra los vértices perpendiculares a la calle para crear curvaturas suaves.</p>
        </div>

        <div class="instruction-card">
          <h3>🚦 Intersecciones</h3>
          <p>Activa la visualización de intersecciones para ver conflictos de tráfico entre calles.</p>
        </div>

        <div class="instruction-card">
          <h3>🔗 Conexiones</h3>
          <p>Muestra las conexiones entre calles: lineales (verde), incorporación (naranja) y probabilísticas (morado).</p>
        </div>

        <div class="instruction-card">
          <h3>🏗️ Constructor de Mapas</h3>
          <p>Crea tus propias simulaciones desde cero, guárdalas como JSON y carga mapas personalizados.</p>
        </div>
      </div>

      <div class="loading-progress">
        <div class="progress-bar-custom">
          <div class="progress-fill" id="progressFill"></div>
        </div>
        <div class="loading-status" id="loadingStatus">Inicializando recursos...</div>
      </div>
    </div>
  </div>

  <!-- Toggle button for mobile -->
  <button class="sidebar-toggle" id="sidebarToggle" data-bs-toggle="tooltip" data-bs-placement="left" data-bs-title="Mostrar/Ocultar panel de control">
    <span id="toggleIcon">📊</span>
  </button>

  <!-- Handles de edición (se posicionan dinámicamente) -->
  <div id="moveHandle" class="edit-handle move-handle"></div>
  <div id="rotateHandle" class="edit-handle rotate-handle"></div>

  <!-- Sidebar Panel -->
  <div class="sidebar" id="sidebar">
    <h4>Panel de Control</h4>

    <!-- Indicador de modo edición -->
    <div id="editModeBadge" class="edit-mode-badge">
      🔧 MODO EDICIÓN ACTIVO
    </div>

    <!-- ========= ACCORDIONS ========== -->
    <div class="accordion" id="controlPanelAccordion">

      <!-- Accordion 1: Instrucciones -->
      <div class="accordion-item">
        <h2 class="accordion-header" id="headingInstrucciones">
          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseInstrucciones" aria-expanded="false" aria-controls="collapseInstrucciones">
            📖 Instrucciones
          </button>
        </h2>
        <div id="collapseInstrucciones" class="accordion-collapse collapse" aria-labelledby="headingInstrucciones" data-bs-parent="#controlPanelAccordion">
          <div class="accordion-body">
            <p class="text-muted small mb-3">Aprende a usar el simulador de tráfico</p>
            <button class="btn btn-info w-100" data-bs-toggle="modal" data-bs-target="#instructionsModal" data-bs-title="Abrir la guía completa del simulador con instrucciones detalladas">
              📚 Ver Guía Completa
            </button>
          </div>
        </div>
      </div>

      <!-- Accordion 2: Configuración de Calles -->
      <div class="accordion-item">
        <h2 class="accordion-header" id="headingConfig">
          <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseConfig" aria-expanded="true" aria-controls="collapseConfig">
            ⚙️ Configuración de Calles
          </button>
        </h2>
        <div id="collapseConfig" class="accordion-collapse collapse show" aria-labelledby="headingConfig" data-bs-parent="#controlPanelAccordion">
          <div class="accordion-body">

            <!-- Selector de Calle -->
            <label for="selectCalle" class="form-label">Seleccionar Calle:</label>
            <select id="selectCalle" class="form-select mb-3">
              <option value="">Seleccione una calle...</option>
            </select>

            <!-- Campos de probabilidad -->
            <div id="calleConfigFields">
              <label for="inputProbabilidadGeneracion" class="form-label">Probabilidad de Generación (%):</label>
              <input type="number" id="inputProbabilidadGeneracion" class="form-control mb-3" min="0" max="100" step="1" placeholder="0-100">

              <label for="inputProbabilidadSalto" class="form-label">Probabilidad de Cambio de Carril (%):</label>
              <input type="number" id="inputProbabilidadSalto" class="form-control mb-3" min="0" max="100" step="1" placeholder="0-100">
            </div>

            <!-- Botón aplicar cambios -->
            <div id="calleApplyButton">
              <button id="btnActualizarCalle" class="btn btn-primary w-100" data-bs-toggle="tooltip" data-bs-title="Aplicar las probabilidades configuradas a la calle seleccionada">✓ Aplicar Cambios</button>
            </div>

            <div class="alert alert-info p-2 small mt-3 mb-0">
              <strong>💡 Atajo rápido:</strong> Presiona <kbd>Ctrl</kbd> (o <kbd>⌘ Cmd</kbd> en Mac) + clic sobre cualquier calle en el canvas para seleccionarla rápidamente.
            </div>

          </div>
        </div>
      </div>

      <!-- Accordion 3: Constructor de Mapas -->
      <div class="accordion-item">
        <h2 class="accordion-header" id="headingConstructor">
          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseConstructor" aria-expanded="false" aria-controls="collapseConstructor">
            🏗️ Constructor de Mapas
          </button>
        </h2>
        <div id="collapseConstructor" class="accordion-collapse collapse" aria-labelledby="headingConstructor" data-bs-parent="#controlPanelAccordion">
          <div class="accordion-body">
            <h6 class="mb-3">🗺️ Gestión de Simulación</h6>

            <!-- Botones de gestión de archivo -->
            <div class="d-grid gap-2 mb-3">
              <button id="btnNuevaSimulacion" class="btn btn-success btn-sm" data-bs-toggle="tooltip" data-bs-title="Crear una nueva simulación desde cero, borrando todo el contenido actual">
                ➕ Nueva Simulación
              </button>
              <button id="btnGuardarSimulacion" class="btn btn-primary btn-sm" data-bs-toggle="tooltip" data-bs-title="Guardar la simulación actual como archivo JSON">
                💾 Guardar Simulación
              </button>
              <button id="btnCargarSimulacion" class="btn btn-info btn-sm" data-bs-toggle="tooltip" data-bs-title="Cargar una simulación desde un archivo JSON guardado previamente">
                📂 Cargar Simulación
              </button>
              <input type="file" id="inputCargarSimulacion" accept=".json" style="display: none;">
            </div>

            <hr class="my-3">

            <h6 class="mb-3">🛠️ Modo Edición Visual</h6>

            <!-- Selector de tipo de objeto -->
            <label for="selectTipoObjeto" class="form-label">Tipo de Objeto:</label>
            <select id="selectTipoObjeto" class="form-select mb-3">
              <option value="">Selecciona tipo...</option>
              <option value="calle">🛣️ Calle</option>
              <option value="edificio">🏢 Edificio</option>
            </select>

            <!-- Selector de Calle -->
            <div id="calleEditorSelector" style="display: none;">
              <label for="selectCalleEditor" class="form-label">Calle:</label>
              <select id="selectCalleEditor" class="form-select mb-3">
                <option value="">Seleccione una calle...</option>
              </select>
            </div>

            <!-- Selector de Edificio -->
            <div id="edificioSelector" style="display: none;">
              <label for="selectEdificio" class="form-label">Edificio:</label>
              <select id="selectEdificio" class="form-select mb-3">
                <option value="">Seleccione un edificio...</option>
              </select>
            </div>

            <!-- Botón de modo edición -->
            <button id="btnModoEdicion" class="btn btn-warning w-100 mb-2" disabled data-bs-toggle="tooltip" data-bs-title="Activar modo edición para mover y rotar el objeto seleccionado visualmente">
              ✏️ Modo Edición
            </button>

            <!-- Botones de guardar/cancelar (solo visibles en modo edición) -->
            <div id="editActionButtons" style="display: none;">
              <div class="d-flex gap-2 mb-2">
                <button id="btnGuardarEdicion" class="btn btn-success flex-fill" data-bs-toggle="tooltip" data-bs-title="Guardar los cambios realizados en el modo edición">
                  💾 Guardar
                </button>
                <button id="btnCancelarEdicion" class="btn btn-secondary flex-fill" data-bs-toggle="tooltip" data-bs-title="Cancelar los cambios y restaurar la posición original">
                  ❌ Cancelar
                </button>
              </div>
            </div>

            <!-- Dropdown de Ajustes Avanzados -->
            <div class="mt-3">
              <button class="btn btn-outline-primary w-100" type="button" id="btnAjustesAvanzados" data-bs-toggle="tooltip" data-bs-title="Mostrar/ocultar ajustes avanzados de posición, rotación y dimensiones">
                🔧 Ajustes Avanzados <span id="advancedArrow">▼</span>
              </button>

              <div class="advanced-settings" id="advancedSettings">
                <div class="mt-3">
                  <h6>📍 Posición y Rotación Manual</h6>

                  <div class="coordinate-input">
                    <label for="inputPosX">X:</label>
                    <input type="number" id="inputPosX" class="form-control" step="1" placeholder="Posición X">
                  </div>

                  <div class="coordinate-input">
                    <label for="inputPosY">Y:</label>
                    <input type="number" id="inputPosY" class="form-control" step="1" placeholder="Posición Y">
                  </div>

                  <div class="coordinate-input">
                    <label for="inputAngulo">Ángulo:</label>
                    <input type="number" id="inputAngulo" class="form-control" min="0" max="360" step="1" placeholder="0-360°">
                    <span>°</span>
                  </div>

                  <!-- Nuevos campos para dimensiones de calles -->
                  <div id="dimensionesCalleSection" style="display: none;">
                    <hr class="my-3">
                    <h6>📏 Dimensiones de Calle</h6>

                    <div class="coordinate-input">
                      <label for="inputTamanoEditar">Tamaño:</label>
                      <input type="number" id="inputTamanoEditar" class="form-control" min="10" max="500" step="1" placeholder="Tamaño en celdas">
                      <span>celdas</span>
                    </div>

                    <div class="coordinate-input">
                      <label for="inputCarrilesEditar">Carriles:</label>
                      <input type="number" id="inputCarrilesEditar" class="form-control" min="1" max="10" step="1" placeholder="Número de carriles">
                      <span>carriles</span>
                    </div>

                    <button id="btnAplicarDimensiones" class="btn btn-sm btn-warning mt-2 w-100" data-bs-toggle="tooltip" data-bs-title="Aplicar cambios de tamaño y número de carriles (elimina vehículos)">
                      📏 Aplicar Dimensiones
                    </button>

                    <div class="alert alert-warning p-2 small mt-2">
                      <strong>⚠️ Advertencia:</strong> Cambiar las dimensiones reiniciará el contenido de la calle (elimina vehículos existentes).
                    </div>
                  </div>

                  <button id="btnAplicarPosicion" class="btn btn-sm btn-success mt-2 w-100" data-bs-toggle="tooltip" data-bs-title="Aplicar la posición (X, Y) y ángulo de rotación ingresados manualmente">
                    ✓ Aplicar Posición
                  </button>

                  <div class="mt-3 p-2 bg-light rounded">
                    <small class="text-muted">
                      <strong>💡 Consejo:</strong> Usa el modo edición para arrastrar y rotar visualmente el objeto.
                    </small>
                  </div>
                </div>
              </div>
            </div>

            <!-- NUEVO: Sección de Modo Curva (solo para calles) -->
            <div id="curvaModeSection" style="display: none;">
              <div class="mt-3 border-top pt-3">
                <h6>🌊 Modo Curva</h6>
                <small class="text-muted d-block mt-2">
                  💡 <strong>Haz clic en un vértice</strong> y arrástralo perpendicular a la calle para curvarlo (máx ±30°)
                </small>
                <small class="text-muted d-block mt-1">
                  🎯 Aparecerá una guía visual azul mostrando la dirección de arrastre
                </small>
              </div>
            </div>

            <hr class="my-3">

            <h6 class="mb-3">🛣️ Agregar Elementos</h6>

            <!-- Botones de agregar -->
            <div class="d-grid gap-2 mb-3">
              <button id="btnAgregarCalle" class="btn btn-outline-primary btn-sm" data-bs-toggle="tooltip" data-bs-title="Abrir formulario para crear una nueva calle en el mapa">
                ➕ Agregar Calle
              </button>
              <button id="btnAgregarEdificio" class="btn btn-outline-success btn-sm" data-bs-toggle="tooltip" data-bs-title="Abrir formulario para crear un nuevo edificio en el mapa">
                🏢 Agregar Edificio
              </button>
              <button id="btnAgregarConexion" class="btn btn-outline-secondary btn-sm" data-bs-toggle="tooltip" data-bs-title="Crear una conexión entre dos calles para flujo de tráfico">
                🔗 Agregar Conexión
              </button>
              <button id="btnEliminarObjeto" class="btn btn-outline-danger btn-sm" data-bs-toggle="tooltip" data-bs-title="Eliminar permanentemente la calle o edificio seleccionado">
                🗑️ Eliminar Objeto Seleccionado
              </button>
            </div>

            <hr class="my-3">

            <h6 class="mb-3">🔗 Gestión de Conexiones</h6>

            <!-- Botón para mostrar lista de conexiones -->
            <button id="btnMostrarListaConexiones" class="btn btn-outline-info w-100 mb-2" data-bs-toggle="tooltip" data-bs-title="Mostrar/ocultar lista de todas las conexiones entre calles creadas">
              📋 Ver Conexiones Existentes
            </button>

            <!-- Lista de conexiones (inicialmente oculta) -->
            <div id="listaConexionesContainer" style="display: none;" class="mt-2">
              <div id="listaConexiones" class="list-group small" style="max-height: 300px; overflow-y: auto;">
                <!-- Las conexiones se insertarán aquí dinámicamente -->
              </div>
            </div>

            <hr class="my-3">

            <div class="alert alert-info p-2 small mb-0">
              <strong>💡 Cómo usar:</strong>
              <ul class="mb-0 mt-1 ps-3">
                <li>Crea calles y edificios con los botones</li>
                <li><kbd>Ctrl</kbd>+Clic en el canvas para seleccionar objetos rápidamente</li>
                <li>Usa el modo edición para posicionarlos</li>
                <li>Conecta calles con "Agregar Conexión"</li>
                <li>Gestiona conexiones existentes con "Ver Conexiones"</li>
                <li>Guarda tu mapa como archivo JSON</li>
                <li>Carga mapas guardados anteriormente</li>
              </ul>
            </div>
          </div>
        </div>
      </div>

      <!-- Accordion 4: Métricas en Tiempo Real -->
      <div class="accordion-item">
        <h2 class="accordion-header" id="headingMetrics">
          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseMetrics" aria-expanded="false" aria-controls="collapseMetrics">
            📈 Métricas de la Simulación
          </button>
        </h2>
        <div id="collapseMetrics" class="accordion-collapse collapse" aria-labelledby="headingMetrics" data-bs-parent="#controlPanelAccordion">
          <div class="accordion-body p-2">
            <div class="chart-container mb-3">
              <h6>🚗 Densidad de Tráfico</h6>
              <div style="position: relative; height: 180px;">
                <canvas id="densityChart"></canvas>
              </div>
            </div>

            <div class="chart-container mb-3">
              <h6>🌊 Flujo Vehicular</h6>
              <div style="position: relative; height: 180px;">
                <canvas id="flowChart"></canvas>
              </div>
            </div>

            <div class="chart-container mb-3">
              <h6>⚡ Velocidad Promedio</h6>
              <div style="position: relative; height: 180px;">
                <canvas id="speedChart"></canvas>
              </div>
            </div>

            <hr class="my-3">

            <h6 class="mb-3">💾 Exportar Métricas</h6>
            <div class="d-grid gap-2">
              <button id="btnDescargarCSV" class="btn btn-success btn-sm" data-bs-toggle="tooltip" data-bs-title="Exportar todas las métricas recolectadas en formato CSV">
                Descargar CSV
              </button>
              <button id="btnDescargarJSON" class="btn btn-info btn-sm" data-bs-toggle="tooltip" data-bs-title="Exportar todas las métricas recolectadas en formato JSON">
                Descargar JSON
              </button>
              <button id="btnLimpiarMetricas" class="btn btn-danger btn-sm" data-bs-toggle="tooltip" data-bs-title="Borrar todos los datos de métricas recolectados y reiniciar gráficas">
                Limpiar Métricas
              </button>
            </div>
          </div>
        </div>
      </div>

    </div>
    <!-- FIN ACCORDIONS -->
  </div>

  <!-- Modal de Instrucciones -->
  <div class="modal fade" id="instructionsModal" tabindex="-1" aria-labelledby="instructionsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title" id="instructionsModalLabel">📚 Guía del Simulador de Tráfico FLUVI</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="row">
            <div class="col-md-6 mb-4">
              <div class="card border-primary">
                <div class="card-body">
                  <h5 class="card-title text-primary">🖱️ Controles Básicos</h5>
                  <ul class="list-unstyled">
                    <li><strong>Zoom:</strong> Rueda del mouse</li>
                    <li><strong>Mover vista:</strong> Arrastrar con el mouse</li>
                    <li><strong>Agregar/quitar vehículos:</strong> Clic en celdas</li>
                    <li><strong>Minimapa:</strong> Clic para teletransportarse</li>
                  </ul>
                </div>
              </div>
            </div>

            <div class="col-md-6 mb-4">
              <div class="card border-success">
                <div class="card-body">
                  <h5 class="card-title text-success">⚙️ Panel de Control</h5>
                  <ul class="list-unstyled">
                    <li><strong>Selección rápida:</strong> Ctrl+Clic sobre calles o edificios en el canvas</li>
                    <li><strong>Menú desplegable:</strong> Selecciona objetos manualmente</li>
                    <li><strong>Probabilidades:</strong> Ajusta generación y cambio de carril</li>
                    <li><strong>Aplicar cambios:</strong> Botón azul al final</li>
                  </ul>
                </div>
              </div>
            </div>

            <div class="col-md-6 mb-4">
              <div class="card border-warning">
                <div class="card-body">
                  <h5 class="card-title text-warning">✏️ Modo Edición</h5>
                  <ul class="list-unstyled">
                    <li>1. Selecciona una calle o edificio</li>
                    <li>2. Activa "Modo Edición"</li>
                    <li>3. Arrastra el handle azul para mover</li>
                    <li>4. Arrastra el handle verde para rotar</li>
                    <li>5. Guarda o cancela los cambios</li>
                  </ul>
                </div>
              </div>
            </div>

            <div class="col-md-6 mb-4">
              <div class="card border-info">
                <div class="card-body">
                  <h5 class="card-title text-info">🌊 Modo Curva</h5>
                  <ul class="list-unstyled">
                    <li>1. Selecciona una calle</li>
                    <li>2. Activa "Mostrar Conexiones"</li>
                    <li>3. Haz clic en "Activar Curvas"</li>
                    <li>4. Arrastra vértices perpendicular a la calle</li>
                    <li>5. Curva máxima: ±30°</li>
                    <li>6. Usa "Resetear" para restaurar</li>
                  </ul>
                </div>
              </div>
            </div>

            <div class="col-md-6 mb-4">
              <div class="card border-info">
                <div class="card-body">
                  <h5 class="card-title text-info">⏸️ Simulación</h5>
                  <ul class="list-unstyled">
                    <li><strong>Pause/Resume:</strong> Detener/continuar</li>
                    <li><strong>Paso:</strong> Avanzar frame por frame</li>
                    <li><strong>Velocidad:</strong> Slider de velocidad</li>
                    <li><strong>Generación:</strong> % global de vehículos</li>
                  </ul>
                </div>
              </div>
            </div>

            <div class="col-md-6 mb-4">
              <div class="card border-danger">
                <div class="card-body">
                  <h5 class="card-title text-danger">🚦 Intersecciones</h5>
                  <p>Las intersecciones detectan colisiones entre calles. Al activar la visualización verás:</p>
                  <ul class="list-unstyled">
                    <li>🟣 <strong>Círculos morados:</strong> Puntos de intersección</li>
                    <li>🚗 Sistema de prioridad alternada</li>
                    <li>⏱️ Los vehículos esperan su turno</li>
                  </ul>
                </div>
              </div>
            </div>

            <div class="col-md-6 mb-4">
              <div class="card border-secondary">
                <div class="card-body">
                  <h5 class="card-title text-secondary">🔗 Conexiones</h5>
                  <p>Tipos de conexiones entre calles:</p>
                  <ul class="list-unstyled">
                    <li>🟢 <strong>Verde (Lineal):</strong> 1 a 1 entre carriles</li>
                    <li>🟠 <strong>Naranja (Incorporación):</strong> Varios a uno</li>
                    <li>🟣 <strong>Morado (Probabilística):</strong> Con probabilidad</li>
                    <li>🔴 <strong>Roja:</strong> Conexión bloqueada</li>
                  </ul>
                </div>
              </div>
            </div>

            <div class="col-md-6 mb-4">
              <div class="card border-success">
                <div class="card-body">
                  <h5 class="card-title text-success">🏗️ Constructor de Mapas</h5>
                  <ul class="list-unstyled">
                    <li><strong>Ctrl+Clic:</strong> Selecciona calles y edificios directamente en el canvas</li>
                    <li><strong>Agregar objetos:</strong> Usa los botones para crear calles y edificios</li>
                    <li><strong>Modo edición:</strong> Arrastra y rota objetos visualmente</li>
                    <li><strong>Conexiones:</strong> Conecta calles para crear flujo de tráfico</li>
                    <li><strong>Guardar/Cargar:</strong> Exporta e importa simulaciones como JSON</li>
                  </ul>
                </div>
              </div>
            </div>

            <div class="col-12">
              <div class="card bg-light">
                <div class="card-body">
                  <h5 class="card-title">📊 Métricas del Simulador</h5>
                  <ul class="list-unstyled">
                    <li><strong>Densidad de Tráfico:</strong> % de ocupación de las calles</li>
                    <li><strong>Flujo Vehicular:</strong> Carros por segundo moviéndose</li>
                    <li><strong>Velocidad Promedio:</strong> % de vehículos en movimiento</li>
                  </ul>
                  <div class="alert alert-info mb-0 mt-3">
                    <small><strong>💡 Tip:</strong> Las métricas se actualizan cada 5 frames de simulación para optimizar el rendimiento.</small>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Nueva Calle -->
  <div class="modal fade" id="modalNuevaCalle" tabindex="-1" aria-labelledby="modalNuevaCalleLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title" id="modalNuevaCalleLabel">➕ Agregar Nueva Calle</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="inputNombreCalle" class="form-label">Nombre:</label>
            <input type="text" class="form-control" id="inputNombreCalle" placeholder="Ej: Calle Principal">
          </div>
          <div class="mb-3">
            <label for="inputTamanoCalle" class="form-label">Tamaño (celdas):</label>
            <input type="number" class="form-control" id="inputTamanoCalle" placeholder="100" min="1" value="100">
          </div>
          <div class="mb-3">
            <label for="selectTipoCalle" class="form-label">Tipo:</label>
            <select class="form-select" id="selectTipoCalle">
              <option value="GENERADOR">🚗 Generador</option>
              <option value="CONEXION" selected>🛣️ Conexión</option>
              <option value="DEVORADOR">🏁 Devorador</option>
            </select>
          </div>
          <div class="mb-3">
            <label for="inputCarrilesCalle" class="form-label">Número de Carriles:</label>
            <input type="number" class="form-control" id="inputCarrilesCalle" placeholder="3" min="1" value="3">
          </div>
          <div class="row">
            <div class="col-md-4 mb-3">
              <label for="inputXCalle" class="form-label">Posición X:</label>
              <input type="number" class="form-control" id="inputXCalle" placeholder="500" value="500">
            </div>
            <div class="col-md-4 mb-3">
              <label for="inputYCalle" class="form-label">Posición Y:</label>
              <input type="number" class="form-control" id="inputYCalle" placeholder="500" value="500">
            </div>
            <div class="col-md-4 mb-3">
              <label for="inputAnguloCalle" class="form-label">Ángulo (°):</label>
              <input type="number" class="form-control" id="inputAnguloCalle" placeholder="0" min="0" max="360" value="0">
            </div>
          </div>
          <div class="mb-3">
            <label for="inputProbGenCalle" class="form-label">Probabilidad de Generación (0-1):</label>
            <input type="number" class="form-control" id="inputProbGenCalle" placeholder="0.5" min="0" max="1" step="0.01" value="0.5">
          </div>
          <div class="mb-3">
            <label for="inputProbSaltoCalle" class="form-label">Probabilidad de Cambio de Carril (0-1):</label>
            <input type="number" class="form-control" id="inputProbSaltoCalle" placeholder="0.02" min="0" max="1" step="0.01" value="0.02">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-bs-toggle="tooltip" data-bs-title="Cerrar sin crear la calle">Cancelar</button>
          <button type="button" class="btn btn-primary" id="btnConfirmarNuevaCalle" data-bs-toggle="tooltip" data-bs-title="Crear la calle con los parámetros ingresados">✓ Crear Calle</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Nuevo Edificio -->
  <div class="modal fade" id="modalNuevoEdificio" tabindex="-1" aria-labelledby="modalNuevoEdificioLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header bg-success text-white">
          <h5 class="modal-title" id="modalNuevoEdificioLabel">🏢 Agregar Nuevo Edificio</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="inputNombreEdificio" class="form-label">Nombre:</label>
            <input type="text" class="form-control" id="inputNombreEdificio" placeholder="Ej: Edificio Central">
          </div>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="inputXEdificio" class="form-label">Posición X:</label>
              <input type="number" class="form-control" id="inputXEdificio" placeholder="500" value="500">
            </div>
            <div class="col-md-6 mb-3">
              <label for="inputYEdificio" class="form-label">Posición Y:</label>
              <input type="number" class="form-control" id="inputYEdificio" placeholder="500" value="500">
            </div>
          </div>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="inputWidthEdificio" class="form-label">Ancho:</label>
              <input type="number" class="form-control" id="inputWidthEdificio" placeholder="100" min="1" value="100">
            </div>
            <div class="col-md-6 mb-3">
              <label for="inputHeightEdificio" class="form-label">Alto:</label>
              <input type="number" class="form-control" id="inputHeightEdificio" placeholder="100" min="1" value="100">
            </div>
          </div>
          <div class="mb-3">
            <label for="inputAnguloEdificio" class="form-label">Ángulo (°):</label>
            <input type="number" class="form-control" id="inputAnguloEdificio" placeholder="0" min="0" max="360" value="0">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-bs-toggle="tooltip" data-bs-title="Cerrar sin crear el edificio">Cancelar</button>
          <button type="button" class="btn btn-success" id="btnConfirmarNuevoEdificio" data-bs-toggle="tooltip" data-bs-title="Crear el edificio con los parámetros ingresados">✓ Crear Edificio</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Nueva Conexión -->
  <div class="modal fade" id="modalNuevaConexion" tabindex="-1" aria-labelledby="modalNuevaConexionLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header bg-secondary text-white">
          <h5 class="modal-title" id="modalNuevaConexionLabel">🔗 Agregar Nueva Conexión</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="selectCalleOrigen" class="form-label">Calle Origen:</label>
            <select class="form-select" id="selectCalleOrigen">
              <option value="">Selecciona calle origen...</option>
            </select>
          </div>
          <div class="mb-3">
            <label for="selectCalleDestino" class="form-label">Calle Destino:</label>
            <select class="form-select" id="selectCalleDestino">
              <option value="">Selecciona calle destino...</option>
            </select>
          </div>
          <div class="mb-3">
            <label for="selectTipoConexion" class="form-label">Tipo de Conexión:</label>
            <select class="form-select" id="selectTipoConexion">
              <option value="LINEAL" selected>🟢 Lineal (1 a 1)</option>
              <option value="INCORPORACION">🟠 Incorporación (varios a uno)</option>
              <option value="PROBABILISTICA">🟣 Probabilística</option>
            </select>
          </div>

          <!-- Campos específicos para INCORPORACION -->
          <div id="camposIncorporacion" style="display: none;">
            <div class="mb-3">
              <label for="inputCarrilDestino" class="form-label">Carril Destino:</label>
              <input type="number" class="form-control" id="inputCarrilDestino" placeholder="0" min="0" value="0">
            </div>
            <div class="mb-3">
              <label for="inputPosInicial" class="form-label">Posición Inicial:</label>
              <input type="number" class="form-control" id="inputPosInicial" placeholder="0" min="0" value="0">
            </div>
          </div>

          <!-- Campos específicos para PROBABILISTICA -->
          <div id="camposProbabilistica" style="display: none;">
            <div class="mb-3">
              <label for="inputCarrilOrigen" class="form-label">Carril Origen:</label>
              <input type="number" class="form-control" id="inputCarrilOrigen" placeholder="0" min="0" value="0">
            </div>
            <div class="mb-3">
              <label for="inputCarrilDestinoProb" class="form-label">Carril Destino:</label>
              <input type="number" class="form-control" id="inputCarrilDestinoProb" placeholder="0" min="0" value="0">
            </div>
            <div class="mb-3">
              <label for="inputProbabilidad" class="form-label">Probabilidad (0-1):</label>
              <input type="number" class="form-control" id="inputProbabilidad" placeholder="0.5" min="0" max="1" step="0.01" value="0.5">
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-bs-toggle="tooltip" data-bs-title="Cerrar sin crear la conexión">Cancelar</button>
          <button type="button" class="btn btn-primary" id="btnConfirmarNuevaConexion" data-bs-toggle="tooltip" data-bs-title="Crear la conexión entre las calles con los parámetros ingresados">✓ Crear Conexión</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Editar Conexión -->
  <div class="modal fade" id="modalEditarConexion" tabindex="-1" aria-labelledby="modalEditarConexionLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header bg-warning text-dark">
          <h5 class="modal-title" id="modalEditarConexionLabel">✏️ Editar Conexión</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="alert alert-info small mb-3">
            <strong>Conexión:</strong> <span id="editConexionInfo"></span>
          </div>

          <div class="mb-3">
            <label for="editSelectTipoConexion" class="form-label">Tipo de Conexión:</label>
            <select class="form-select" id="editSelectTipoConexion">
              <option value="LINEAL">🟢 Lineal (1 a 1)</option>
              <option value="INCORPORACION">🟠 Incorporación (varios a uno)</option>
              <option value="PROBABILISTICA">🟣 Probabilística</option>
            </select>
          </div>

          <!-- Campos específicos para INCORPORACION -->
          <div id="editCamposIncorporacion" style="display: none;">
            <div class="mb-3">
              <label for="editInputCarrilDestino" class="form-label">Carril Destino:</label>
              <input type="number" class="form-control" id="editInputCarrilDestino" placeholder="0" min="0" value="0">
            </div>
            <div class="mb-3">
              <label for="editInputPosInicial" class="form-label">Posición Inicial:</label>
              <input type="number" class="form-control" id="editInputPosInicial" placeholder="0" min="0" value="0">
            </div>
          </div>

          <!-- Campos específicos para PROBABILISTICA -->
          <div id="editCamposProbabilistica" style="display: none;">
            <div class="mb-3">
              <label for="editInputCarrilOrigen" class="form-label">Carril Origen:</label>
              <input type="number" class="form-control" id="editInputCarrilOrigen" placeholder="0" min="0" value="0">
            </div>
            <div class="mb-3">
              <label for="editInputCarrilDestinoProb" class="form-label">Carril Destino:</label>
              <input type="number" class="form-control" id="editInputCarrilDestinoProb" placeholder="0" min="0" value="0">
            </div>
            <div class="mb-3">
              <label for="editInputProbabilidad" class="form-label">Probabilidad (0-1):</label>
              <input type="number" class="form-control" id="editInputProbabilidad" placeholder="0.5" min="0" max="1" step="0.01" value="0.5">
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-bs-toggle="tooltip" data-bs-title="Cerrar sin guardar los cambios">Cancelar</button>
          <button type="button" class="btn btn-warning" id="btnConfirmarEditarConexion" data-bs-toggle="tooltip" data-bs-title="Guardar los cambios realizados en la conexión">✓ Guardar Cambios</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <div class="main-content">
    <div class="header">
      <h1>🚦 Simulador de Tráfico FLUVI</h1>
    </div>

    <div class="canvas-wrapper">
      <canvas id="simuladorCanvas"></canvas>
      <canvas id="minimapa"></canvas>

      <!-- Control Bar -->
      <div id="canvasControlBar">
        <div id="controlBar" class="d-flex align-items-center">
          <button id="btnConexiones" class="btn btn-info" data-bs-toggle="tooltip" data-bs-title="Mostrar/ocultar las conexiones entre calles en el canvas">Mostrar Conexiones</button>
          <button id="btnPauseResume" class="btn btn-secondary me-2" data-bs-toggle="tooltip" data-bs-title="Pausar o reanudar la simulación de tráfico">⏸</button>
          <button id="btnPaso" class="btn btn-success me-2" disabled data-bs-toggle="tooltip" data-bs-title="Avanzar un paso de la simulación (solo disponible cuando está en pausa)">⏭</button>
          <button id="btnIntersecciones" class="btn btn-info me-2" data-bs-toggle="tooltip" data-bs-title="Mostrar/ocultar los puntos de intersección entre calles">Intersecciones</button>
          <button id="btnEtiquetas" class="btn btn-info me-2" data-bs-toggle="tooltip" data-bs-title="Mostrar/ocultar las etiquetas con nombres de calles y edificios">🏷️ Ocultar Etiquetas</button>
          <button id="btnBorrar" class="btn btn-danger me-2" data-bs-toggle="tooltip" data-bs-title="Borrar todos los vehículos de todas las calles">🗑️</button>
          <button id="btnRandom" class="btn btn-warning me-3" data-bs-toggle="tooltip" data-bs-title="Llenar las calles con vehículos aleatorios">Aleatorio</button>
          <label for="velocidadSlider" class="form-label me-2 mb-0">Velocidad:</label>
          <input type="range" class="form-range me-2" id="velocidadSlider" min="1" max="100" step="1" style="width: 100px;">
          <span id="velocidadValor" class="badge bg-primary">10</span>
          <label for="probabilidadSlider" class="form-label ms-3 me-2 mb-0">Generación:</label>
          <input type="range" class="form-range me-2" id="probabilidadSlider" min="0" max="100" step="1" style="width: 100px;">
          <span id="probabilidadValor" class="badge bg-primary">10</span>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ========== SISTEMA DE CARGA ==========
    (function() {
      const loadingScreen = document.getElementById('loadingScreen');
      const progressFill = document.getElementById('progressFill');
      const loadingStatus = document.getElementById('loadingStatus');

      let progress = 0;
      const statusMessages = [
        'Inicializando recursos...',
        'Cargando librerías...',
        'Preparando canvas...',
        'Generando calles...',
        'Calculando intersecciones...',
        'Creando conexiones...',
        'Iniciando simulación...',
        'Listo!'
      ];

      let messageIndex = 0;

      // Simular progreso de carga
      const progressInterval = setInterval(() => {
        progress += Math.random() * 15;

        if (progress >= 100) {
          progress = 100;
          clearInterval(progressInterval);
        }

        progressFill.style.width = progress + '%';

        // Cambiar mensaje según progreso
        const newMessageIndex = Math.floor((progress / 100) * statusMessages.length);
        if (newMessageIndex !== messageIndex && newMessageIndex < statusMessages.length) {
          messageIndex = newMessageIndex;
          loadingStatus.textContent = statusMessages[messageIndex];
        }
      }, 200);

      // Función para ocultar la pantalla de carga
      window.hideLoadingScreen = function() {
        clearInterval(progressInterval);
        progressFill.style.width = '100%';
        loadingStatus.textContent = 'Listo!';

        setTimeout(() => {
          loadingScreen.classList.add('fade-out');
          setTimeout(() => {
            loadingScreen.style.display = 'none';
          }, 500);
        }, 500);
      };

      // Ocultar pantalla cuando todo esté cargado
      window.addEventListener('load', () => {
        // Esperar un mínimo de 2 segundos para que se vean las instrucciones
        setTimeout(() => {
          // Verificar que los scripts principales estén cargados
          if (typeof iniciarSimulacion !== 'undefined') {
            hideLoadingScreen();
          } else {
            // Esperar un poco más si no está listo
            setTimeout(hideLoadingScreen, 1000);
          }
        }, 2000);
      });

      // Backup: ocultar después de 15 segundos máximo
      setTimeout(() => {
        if (loadingScreen && !loadingScreen.classList.contains('fade-out')) {
          console.warn('Forzando cierre de pantalla de carga');
          hideLoadingScreen();
        }
      }, 15000);
    })();

  </script>

  <!-- Scripts modulares del simulador -->
  <script src="curvas.js"></script>
  <script src="etiquetas.js"></script>
  <script src="trafico.js"></script>
  <script src="editor.js"></script>
  <script src="constructor.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Inicializar tooltips de Bootstrap 5 -->
  <script>
    // Inicializar todos los tooltips cuando el DOM esté listo
    document.addEventListener('DOMContentLoaded', function() {
      // Obtener todos los elementos con data-bs-toggle="tooltip"
      const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]');

      // Inicializar cada tooltip
      const tooltipList = [...tooltipTriggerList].map(tooltipTriggerEl => {
        return new bootstrap.Tooltip(tooltipTriggerEl, {
          trigger: 'hover focus', // Mostrar al pasar el mouse o enfocar
          delay: { show: 300, hide: 100 } // Pequeño delay para evitar tooltips molestos
        });
      });

      console.log(`✓ ${tooltipList.length} tooltips inicializados correctamente`);
    });
  </script>
</body>
</html>