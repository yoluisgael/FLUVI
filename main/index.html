<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Simulador de Calles DinÃ¡micas</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <link rel="stylesheet" href="estilos.css">
  <link rel="stylesheet" href="minimapa.css">
</head>

<body>
  <!-- ========== PANTALLA DE CARGA ========== -->
  <div id="loadingScreen">
    <div class="loading-content">
      <div class="loading-header">
        <h1>Simulador de TrÃ¡fico FLUVI</h1>
        <p>Cargando simulaciÃ³n...</p>
      </div>

      <div class="loading-spinner">
        <div class="spinner"></div>
      </div>

      <div class="instructions">
        <div class="instruction-card">
          <h3>ğŸ–±ï¸ Controles BÃ¡sicos</h3>
          <p>Usa la rueda del mouse para hacer zoom. Arrastra el canvas para moverte. Haz clic en las celdas para agregar/quitar vehÃ­culos.</p>
        </div>

        <div class="instruction-card">
          <h3>âš™ï¸ Panel de Control</h3>
          <p>Selecciona calles en el panel izquierdo para modificar probabilidades de generaciÃ³n y cambio de carril.</p>
        </div>

        <div class="instruction-card">
          <h3>â¸ï¸ SimulaciÃ³n</h3>
          <p>Pausa, avanza paso a paso, ajusta la velocidad y visualiza mÃ©tricas de tu simulaciÃ³n.</p>
        </div>

        <div class="instruction-card">
          <h3>âœï¸ Modo EdiciÃ³n</h3>
          <p>Selecciona una calle o edificio y activa el modo ediciÃ³n para reposicionar y rotar visualmente.</p>
        </div>

        <div class="instruction-card">
          <h3>ğŸŒŠ Curvas en Calles</h3>
          <p>Activa el modo curva y arrastra los vÃ©rtices perpendiculares a la calle para crear curvaturas suaves.</p>
        </div>

        <div class="instruction-card">
          <h3>ğŸš¦ Intersecciones</h3>
          <p>Activa la visualizaciÃ³n de intersecciones para ver conflictos de trÃ¡fico entre calles.</p>
        </div>

        <div class="instruction-card">
          <h3>ğŸ”— Conexiones</h3>
          <p>Muestra las conexiones entre calles: lineales (verde), incorporaciÃ³n (naranja) y probabilÃ­sticas (morado).</p>
        </div>

        <div class="instruction-card">
          <h3>ğŸ—ï¸ Constructor de Mapas</h3>
          <p>Crea tus propias simulaciones desde cero, guÃ¡rdalas como JSON y carga mapas personalizados.</p>
        </div>
      </div>

      <div class="loading-progress">
        <div class="progress-bar-custom">
          <div class="progress-fill" id="progressFill"></div>
        </div>
        <div class="loading-status" id="loadingStatus">Inicializando recursos...</div>
      </div>
    </div>
  </div>

  <!-- Toggle button for mobile -->
  <button class="sidebar-toggle" id="sidebarToggle">
    <span id="toggleIcon">ğŸ“Š</span>
  </button>

  <!-- Handles de ediciÃ³n (se posicionan dinÃ¡micamente) -->
  <div id="moveHandle" class="edit-handle move-handle"></div>
  <div id="rotateHandle" class="edit-handle rotate-handle"></div>

  <!-- Sidebar Panel -->
  <div class="sidebar" id="sidebar">
    <h4>Panel de Control</h4>

    <!-- Indicador de modo ediciÃ³n -->
    <div id="editModeBadge" class="edit-mode-badge">
      ğŸ”§ MODO EDICIÃ“N ACTIVO
    </div>

    <!-- ========= ACCORDIONS ========== -->
    <div class="accordion" id="controlPanelAccordion">

      <!-- Accordion 1: Instrucciones -->
      <div class="accordion-item">
        <h2 class="accordion-header" id="headingInstrucciones">
          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseInstrucciones" aria-expanded="false" aria-controls="collapseInstrucciones">
            ğŸ“– Instrucciones
          </button>
        </h2>
        <div id="collapseInstrucciones" class="accordion-collapse collapse" aria-labelledby="headingInstrucciones" data-bs-parent="#controlPanelAccordion">
          <div class="accordion-body">
            <p class="text-muted small mb-3">Aprende a usar el simulador de trÃ¡fico</p>
            <button class="btn btn-info w-100" data-bs-toggle="modal" data-bs-target="#instructionsModal">
              ğŸ“š Ver GuÃ­a Completa
            </button>
          </div>
        </div>
      </div>

      <!-- Accordion 2: ConfiguraciÃ³n de Calles -->
      <div class="accordion-item">
        <h2 class="accordion-header" id="headingConfig">
          <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseConfig" aria-expanded="true" aria-controls="collapseConfig">
            âš™ï¸ ConfiguraciÃ³n de Calles
          </button>
        </h2>
        <div id="collapseConfig" class="accordion-collapse collapse show" aria-labelledby="headingConfig" data-bs-parent="#controlPanelAccordion">
          <div class="accordion-body">

            <!-- Selector de Calle -->
            <label for="selectCalle" class="form-label">Seleccionar Calle:</label>
            <select id="selectCalle" class="form-select mb-3">
              <option value="">Seleccione una calle...</option>
            </select>

            <!-- Campos de probabilidad -->
            <div id="calleConfigFields">
              <label for="inputProbabilidadGeneracion" class="form-label">Probabilidad de GeneraciÃ³n (%):</label>
              <input type="number" id="inputProbabilidadGeneracion" class="form-control mb-3" min="0" max="100" step="1" placeholder="0-100">

              <label for="inputProbabilidadSalto" class="form-label">Probabilidad de Cambio de Carril (%):</label>
              <input type="number" id="inputProbabilidadSalto" class="form-control mb-3" min="0" max="100" step="1" placeholder="0-100">
            </div>

            <!-- BotÃ³n aplicar cambios -->
            <div id="calleApplyButton">
              <button id="btnActualizarCalle" class="btn btn-primary w-100">âœ“ Aplicar Cambios</button>
            </div>

            <div class="alert alert-info p-2 small mt-3 mb-0">
              <strong>ğŸ’¡ Nota:</strong> Selecciona una calle para modificar sus probabilidades de generaciÃ³n y cambio de carril.
            </div>

          </div>
        </div>
      </div>

      <!-- Accordion 3: Constructor de Mapas -->
      <div class="accordion-item">
        <h2 class="accordion-header" id="headingConstructor">
          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseConstructor" aria-expanded="false" aria-controls="collapseConstructor">
            ğŸ—ï¸ Constructor de Mapas
          </button>
        </h2>
        <div id="collapseConstructor" class="accordion-collapse collapse" aria-labelledby="headingConstructor" data-bs-parent="#controlPanelAccordion">
          <div class="accordion-body">
            <h6 class="mb-3">ğŸ—ºï¸ GestiÃ³n de SimulaciÃ³n</h6>

            <!-- Botones de gestiÃ³n de archivo -->
            <div class="d-grid gap-2 mb-3">
              <button id="btnNuevaSimulacion" class="btn btn-success btn-sm">
                â• Nueva SimulaciÃ³n
              </button>
              <button id="btnGuardarSimulacion" class="btn btn-primary btn-sm">
                ğŸ’¾ Guardar SimulaciÃ³n
              </button>
              <button id="btnCargarSimulacion" class="btn btn-info btn-sm">
                ğŸ“‚ Cargar SimulaciÃ³n
              </button>
              <input type="file" id="inputCargarSimulacion" accept=".json" style="display: none;">
            </div>

            <hr class="my-3">

            <h6 class="mb-3">ğŸ› ï¸ Modo EdiciÃ³n Visual</h6>

            <!-- Selector de tipo de objeto -->
            <label for="selectTipoObjeto" class="form-label">Tipo de Objeto:</label>
            <select id="selectTipoObjeto" class="form-select mb-3">
              <option value="">Selecciona tipo...</option>
              <option value="calle">ğŸ›£ï¸ Calle</option>
              <option value="edificio">ğŸ¢ Edificio</option>
            </select>

            <!-- Selector de Calle -->
            <div id="calleEditorSelector" style="display: none;">
              <label for="selectCalleEditor" class="form-label">Calle:</label>
              <select id="selectCalleEditor" class="form-select mb-3">
                <option value="">Seleccione una calle...</option>
              </select>
            </div>

            <!-- Selector de Edificio -->
            <div id="edificioSelector" style="display: none;">
              <label for="selectEdificio" class="form-label">Edificio:</label>
              <select id="selectEdificio" class="form-select mb-3">
                <option value="">Seleccione un edificio...</option>
              </select>
            </div>

            <!-- BotÃ³n de modo ediciÃ³n -->
            <button id="btnModoEdicion" class="btn btn-warning w-100 mb-2" disabled>
              âœï¸ Modo EdiciÃ³n
            </button>

            <!-- Botones de guardar/cancelar (solo visibles en modo ediciÃ³n) -->
            <div id="editActionButtons" style="display: none;">
              <div class="d-flex gap-2 mb-2">
                <button id="btnGuardarEdicion" class="btn btn-success flex-fill">
                  ğŸ’¾ Guardar
                </button>
                <button id="btnCancelarEdicion" class="btn btn-secondary flex-fill">
                  âŒ Cancelar
                </button>
              </div>
            </div>

            <!-- Dropdown de Ajustes Avanzados -->
            <div class="mt-3">
              <button class="btn btn-outline-primary w-100" type="button" id="btnAjustesAvanzados">
                ğŸ”§ Ajustes Avanzados <span id="advancedArrow">â–¼</span>
              </button>

              <div class="advanced-settings" id="advancedSettings">
                <div class="mt-3">
                  <h6>ğŸ“ PosiciÃ³n y RotaciÃ³n Manual</h6>

                  <div class="coordinate-input">
                    <label for="inputPosX">X:</label>
                    <input type="number" id="inputPosX" class="form-control" step="1" placeholder="PosiciÃ³n X">
                  </div>

                  <div class="coordinate-input">
                    <label for="inputPosY">Y:</label>
                    <input type="number" id="inputPosY" class="form-control" step="1" placeholder="PosiciÃ³n Y">
                  </div>

                  <div class="coordinate-input">
                    <label for="inputAngulo">Ãngulo:</label>
                    <input type="number" id="inputAngulo" class="form-control" min="0" max="360" step="1" placeholder="0-360Â°">
                    <span>Â°</span>
                  </div>

                  <button id="btnAplicarPosicion" class="btn btn-sm btn-success mt-2 w-100">
                    âœ“ Aplicar PosiciÃ³n
                  </button>

                  <div class="mt-3 p-2 bg-light rounded">
                    <small class="text-muted">
                      <strong>ğŸ’¡ Consejo:</strong> Usa el modo ediciÃ³n para arrastrar y rotar visualmente el objeto.
                    </small>
                  </div>
                </div>
              </div>
            </div>

            <!-- NUEVO: SecciÃ³n de Modo Curva (solo para calles) -->
            <div id="curvaModeSection" style="display: none;">
              <div class="mt-3 border-top pt-3">
                <h6>ğŸŒŠ Modo Curva</h6>
                <div class="d-flex gap-2">
                  <button id="btnToggleCurva" class="btn btn-outline-info flex-fill" disabled>
                    ğŸŒŠ Activar Curvas
                  </button>
                  <button id="btnResetVertices" class="btn btn-outline-secondary flex-fill" disabled>
                    ğŸ”„ Resetear
                  </button>
                </div>
                <small class="text-muted d-block mt-2">
                  ğŸ’¡ <strong>Haz clic en un vÃ©rtice</strong> y arrÃ¡stralo perpendicular a la calle para curvarlo (mÃ¡x Â±30Â°)
                </small>
                <small class="text-muted d-block mt-1">
                  ğŸ¯ AparecerÃ¡ una guÃ­a visual azul mostrando la direcciÃ³n de arrastre
                </small>
              </div>
            </div>

            <hr class="my-3">

            <h6 class="mb-3">ğŸ›£ï¸ Agregar Elementos</h6>

            <!-- Botones de agregar -->
            <div class="d-grid gap-2 mb-3">
              <button id="btnAgregarCalle" class="btn btn-outline-primary btn-sm">
                â• Agregar Calle
              </button>
              <button id="btnAgregarEdificio" class="btn btn-outline-success btn-sm">
                ğŸ¢ Agregar Edificio
              </button>
              <button id="btnAgregarConexion" class="btn btn-outline-secondary btn-sm">
                ğŸ”— Agregar ConexiÃ³n
              </button>
              <button id="btnEliminarObjeto" class="btn btn-outline-danger btn-sm">
                ğŸ—‘ï¸ Eliminar Objeto Seleccionado
              </button>
            </div>

            <hr class="my-3">

            <h6 class="mb-3">ğŸ”— GestiÃ³n de Conexiones</h6>

            <!-- BotÃ³n para mostrar lista de conexiones -->
            <button id="btnMostrarListaConexiones" class="btn btn-outline-info w-100 mb-2">
              ğŸ“‹ Ver Conexiones Existentes
            </button>

            <!-- Lista de conexiones (inicialmente oculta) -->
            <div id="listaConexionesContainer" style="display: none;" class="mt-2">
              <div id="listaConexiones" class="list-group small" style="max-height: 300px; overflow-y: auto;">
                <!-- Las conexiones se insertarÃ¡n aquÃ­ dinÃ¡micamente -->
              </div>
            </div>

            <hr class="my-3">

            <div class="alert alert-info p-2 small mb-0">
              <strong>ğŸ’¡ CÃ³mo usar:</strong>
              <ul class="mb-0 mt-1 ps-3">
                <li>Crea calles y edificios con los botones</li>
                <li>Usa el modo ediciÃ³n para posicionarlos</li>
                <li>Conecta calles con "Agregar ConexiÃ³n"</li>
                <li>Gestiona conexiones existentes con "Ver Conexiones"</li>
                <li>Guarda tu mapa como archivo JSON</li>
                <li>Carga mapas guardados anteriormente</li>
              </ul>
            </div>
          </div>
        </div>
      </div>

      <!-- Accordion 4: MÃ©tricas en Tiempo Real -->
      <div class="accordion-item">
        <h2 class="accordion-header" id="headingMetrics">
          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseMetrics" aria-expanded="false" aria-controls="collapseMetrics">
            ğŸ“ˆ MÃ©tricas de la SimulaciÃ³n
          </button>
        </h2>
        <div id="collapseMetrics" class="accordion-collapse collapse" aria-labelledby="headingMetrics" data-bs-parent="#controlPanelAccordion">
          <div class="accordion-body p-2">
            <div class="chart-container mb-3">
              <h6>ğŸš— Densidad de TrÃ¡fico</h6>
              <div style="position: relative; height: 180px;">
                <canvas id="densityChart"></canvas>
              </div>
            </div>

            <div class="chart-container mb-3">
              <h6>ğŸŒŠ Flujo Vehicular</h6>
              <div style="position: relative; height: 180px;">
                <canvas id="flowChart"></canvas>
              </div>
            </div>

            <div class="chart-container mb-3">
              <h6>âš¡ Velocidad Promedio</h6>
              <div style="position: relative; height: 180px;">
                <canvas id="speedChart"></canvas>
              </div>
            </div>

            <hr class="my-3">

            <h6 class="mb-3">ğŸ’¾ Exportar MÃ©tricas</h6>
            <div class="d-grid gap-2">
              <button id="btnDescargarCSV" class="btn btn-success btn-sm">
                Descargar CSV
              </button>
              <button id="btnDescargarJSON" class="btn btn-info btn-sm">
                Descargar JSON
              </button>
              <button id="btnLimpiarMetricas" class="btn btn-danger btn-sm">
                Limpiar MÃ©tricas
              </button>
            </div>
          </div>
        </div>
      </div>

    </div>
    <!-- FIN ACCORDIONS -->
  </div>

  <!-- Modal de Instrucciones -->
  <div class="modal fade" id="instructionsModal" tabindex="-1" aria-labelledby="instructionsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title" id="instructionsModalLabel">ğŸ“š GuÃ­a del Simulador de TrÃ¡fico FLUVI</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="row">
            <div class="col-md-6 mb-4">
              <div class="card border-primary">
                <div class="card-body">
                  <h5 class="card-title text-primary">ğŸ–±ï¸ Controles BÃ¡sicos</h5>
                  <ul class="list-unstyled">
                    <li><strong>Zoom:</strong> Rueda del mouse</li>
                    <li><strong>Mover vista:</strong> Arrastrar con el mouse</li>
                    <li><strong>Agregar/quitar vehÃ­culos:</strong> Clic en celdas</li>
                    <li><strong>Minimapa:</strong> Clic para teletransportarse</li>
                  </ul>
                </div>
              </div>
            </div>

            <div class="col-md-6 mb-4">
              <div class="card border-success">
                <div class="card-body">
                  <h5 class="card-title text-success">âš™ï¸ Panel de Control</h5>
                  <ul class="list-unstyled">
                    <li><strong>Tipo de objeto:</strong> Selecciona calle o edificio</li>
                    <li><strong>Probabilidad de generaciÃ³n:</strong> % de crear vehÃ­culos (calles)</li>
                    <li><strong>Cambio de carril:</strong> % de saltar de carril (calles)</li>
                    <li><strong>Aplicar cambios:</strong> BotÃ³n azul al final</li>
                  </ul>
                </div>
              </div>
            </div>

            <div class="col-md-6 mb-4">
              <div class="card border-warning">
                <div class="card-body">
                  <h5 class="card-title text-warning">âœï¸ Modo EdiciÃ³n</h5>
                  <ul class="list-unstyled">
                    <li>1. Selecciona una calle o edificio</li>
                    <li>2. Activa "Modo EdiciÃ³n"</li>
                    <li>3. Arrastra el handle azul para mover</li>
                    <li>4. Arrastra el handle verde para rotar</li>
                    <li>5. Guarda o cancela los cambios</li>
                  </ul>
                </div>
              </div>
            </div>

            <div class="col-md-6 mb-4">
              <div class="card border-info">
                <div class="card-body">
                  <h5 class="card-title text-info">ğŸŒŠ Modo Curva</h5>
                  <ul class="list-unstyled">
                    <li>1. Selecciona una calle</li>
                    <li>2. Activa "Mostrar Conexiones"</li>
                    <li>3. Haz clic en "Activar Curvas"</li>
                    <li>4. Arrastra vÃ©rtices perpendicular a la calle</li>
                    <li>5. Curva mÃ¡xima: Â±30Â°</li>
                    <li>6. Usa "Resetear" para restaurar</li>
                  </ul>
                </div>
              </div>
            </div>

            <div class="col-md-6 mb-4">
              <div class="card border-info">
                <div class="card-body">
                  <h5 class="card-title text-info">â¸ï¸ SimulaciÃ³n</h5>
                  <ul class="list-unstyled">
                    <li><strong>Pause/Resume:</strong> Detener/continuar</li>
                    <li><strong>Paso:</strong> Avanzar frame por frame</li>
                    <li><strong>Velocidad:</strong> Slider de velocidad</li>
                    <li><strong>GeneraciÃ³n:</strong> % global de vehÃ­culos</li>
                  </ul>
                </div>
              </div>
            </div>

            <div class="col-md-6 mb-4">
              <div class="card border-danger">
                <div class="card-body">
                  <h5 class="card-title text-danger">ğŸš¦ Intersecciones</h5>
                  <p>Las intersecciones detectan colisiones entre calles. Al activar la visualizaciÃ³n verÃ¡s:</p>
                  <ul class="list-unstyled">
                    <li>ğŸŸ£ <strong>CÃ­rculos morados:</strong> Puntos de intersecciÃ³n</li>
                    <li>ğŸš— Sistema de prioridad alternada</li>
                    <li>â±ï¸ Los vehÃ­culos esperan su turno</li>
                  </ul>
                </div>
              </div>
            </div>

            <div class="col-md-6 mb-4">
              <div class="card border-secondary">
                <div class="card-body">
                  <h5 class="card-title text-secondary">ğŸ”— Conexiones</h5>
                  <p>Tipos de conexiones entre calles:</p>
                  <ul class="list-unstyled">
                    <li>ğŸŸ¢ <strong>Verde (Lineal):</strong> 1 a 1 entre carriles</li>
                    <li>ğŸŸ  <strong>Naranja (IncorporaciÃ³n):</strong> Varios a uno</li>
                    <li>ğŸŸ£ <strong>Morado (ProbabilÃ­stica):</strong> Con probabilidad</li>
                    <li>ğŸ”´ <strong>Roja:</strong> ConexiÃ³n bloqueada</li>
                  </ul>
                </div>
              </div>
            </div>

            <div class="col-md-6 mb-4">
              <div class="card border-success">
                <div class="card-body">
                  <h5 class="card-title text-success">ğŸ—ï¸ Constructor de Mapas</h5>
                  <ul class="list-unstyled">
                    <li>1. Usa "Agregar Calle" para crear calles</li>
                    <li>2. Usa "Agregar ConexiÃ³n" para conectar calles</li>
                    <li>3. Guarda tu mapa como archivo JSON</li>
                    <li>4. Carga mapas guardados con "Cargar SimulaciÃ³n"</li>
                    <li>5. Crea simulaciones personalizadas desde cero</li>
                  </ul>
                </div>
              </div>
            </div>

            <div class="col-12">
              <div class="card bg-light">
                <div class="card-body">
                  <h5 class="card-title">ğŸ“Š MÃ©tricas del Simulador</h5>
                  <ul class="list-unstyled">
                    <li><strong>Densidad de TrÃ¡fico:</strong> % de ocupaciÃ³n de las calles</li>
                    <li><strong>Flujo Vehicular:</strong> Carros por segundo moviÃ©ndose</li>
                    <li><strong>Velocidad Promedio:</strong> % de vehÃ­culos en movimiento</li>
                  </ul>
                  <div class="alert alert-info mb-0 mt-3">
                    <small><strong>ğŸ’¡ Tip:</strong> Las mÃ©tricas se actualizan cada 5 frames de simulaciÃ³n para optimizar el rendimiento.</small>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Nueva Calle -->
  <div class="modal fade" id="modalNuevaCalle" tabindex="-1" aria-labelledby="modalNuevaCalleLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title" id="modalNuevaCalleLabel">â• Agregar Nueva Calle</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="inputNombreCalle" class="form-label">Nombre:</label>
            <input type="text" class="form-control" id="inputNombreCalle" placeholder="Ej: Calle Principal">
          </div>
          <div class="mb-3">
            <label for="inputTamanoCalle" class="form-label">TamaÃ±o (celdas):</label>
            <input type="number" class="form-control" id="inputTamanoCalle" placeholder="100" min="1" value="100">
          </div>
          <div class="mb-3">
            <label for="selectTipoCalle" class="form-label">Tipo:</label>
            <select class="form-select" id="selectTipoCalle">
              <option value="GENERADOR">ğŸš— Generador</option>
              <option value="CONEXION" selected>ğŸ›£ï¸ ConexiÃ³n</option>
              <option value="DEVORADOR">ğŸ Devorador</option>
            </select>
          </div>
          <div class="mb-3">
            <label for="inputCarrilesCalle" class="form-label">NÃºmero de Carriles:</label>
            <input type="number" class="form-control" id="inputCarrilesCalle" placeholder="3" min="1" value="3">
          </div>
          <div class="row">
            <div class="col-md-4 mb-3">
              <label for="inputXCalle" class="form-label">PosiciÃ³n X:</label>
              <input type="number" class="form-control" id="inputXCalle" placeholder="500" value="500">
            </div>
            <div class="col-md-4 mb-3">
              <label for="inputYCalle" class="form-label">PosiciÃ³n Y:</label>
              <input type="number" class="form-control" id="inputYCalle" placeholder="500" value="500">
            </div>
            <div class="col-md-4 mb-3">
              <label for="inputAnguloCalle" class="form-label">Ãngulo (Â°):</label>
              <input type="number" class="form-control" id="inputAnguloCalle" placeholder="0" min="0" max="360" value="0">
            </div>
          </div>
          <div class="mb-3">
            <label for="inputProbGenCalle" class="form-label">Probabilidad de GeneraciÃ³n (0-1):</label>
            <input type="number" class="form-control" id="inputProbGenCalle" placeholder="0.5" min="0" max="1" step="0.01" value="0.5">
          </div>
          <div class="mb-3">
            <label for="inputProbSaltoCalle" class="form-label">Probabilidad de Cambio de Carril (0-1):</label>
            <input type="number" class="form-control" id="inputProbSaltoCalle" placeholder="0.02" min="0" max="1" step="0.01" value="0.02">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="button" class="btn btn-primary" id="btnConfirmarNuevaCalle">âœ“ Crear Calle</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Nuevo Edificio -->
  <div class="modal fade" id="modalNuevoEdificio" tabindex="-1" aria-labelledby="modalNuevoEdificioLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header bg-success text-white">
          <h5 class="modal-title" id="modalNuevoEdificioLabel">ğŸ¢ Agregar Nuevo Edificio</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="inputNombreEdificio" class="form-label">Nombre:</label>
            <input type="text" class="form-control" id="inputNombreEdificio" placeholder="Ej: Edificio Central">
          </div>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="inputXEdificio" class="form-label">PosiciÃ³n X:</label>
              <input type="number" class="form-control" id="inputXEdificio" placeholder="500" value="500">
            </div>
            <div class="col-md-6 mb-3">
              <label for="inputYEdificio" class="form-label">PosiciÃ³n Y:</label>
              <input type="number" class="form-control" id="inputYEdificio" placeholder="500" value="500">
            </div>
          </div>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="inputWidthEdificio" class="form-label">Ancho:</label>
              <input type="number" class="form-control" id="inputWidthEdificio" placeholder="100" min="1" value="100">
            </div>
            <div class="col-md-6 mb-3">
              <label for="inputHeightEdificio" class="form-label">Alto:</label>
              <input type="number" class="form-control" id="inputHeightEdificio" placeholder="100" min="1" value="100">
            </div>
          </div>
          <div class="mb-3">
            <label for="inputAnguloEdificio" class="form-label">Ãngulo (Â°):</label>
            <input type="number" class="form-control" id="inputAnguloEdificio" placeholder="0" min="0" max="360" value="0">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="button" class="btn btn-success" id="btnConfirmarNuevoEdificio">âœ“ Crear Edificio</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Nueva ConexiÃ³n -->
  <div class="modal fade" id="modalNuevaConexion" tabindex="-1" aria-labelledby="modalNuevaConexionLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header bg-secondary text-white">
          <h5 class="modal-title" id="modalNuevaConexionLabel">ğŸ”— Agregar Nueva ConexiÃ³n</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="selectCalleOrigen" class="form-label">Calle Origen:</label>
            <select class="form-select" id="selectCalleOrigen">
              <option value="">Selecciona calle origen...</option>
            </select>
          </div>
          <div class="mb-3">
            <label for="selectCalleDestino" class="form-label">Calle Destino:</label>
            <select class="form-select" id="selectCalleDestino">
              <option value="">Selecciona calle destino...</option>
            </select>
          </div>
          <div class="mb-3">
            <label for="selectTipoConexion" class="form-label">Tipo de ConexiÃ³n:</label>
            <select class="form-select" id="selectTipoConexion">
              <option value="LINEAL" selected>ğŸŸ¢ Lineal (1 a 1)</option>
              <option value="INCORPORACION">ğŸŸ  IncorporaciÃ³n (varios a uno)</option>
              <option value="PROBABILISTICA">ğŸŸ£ ProbabilÃ­stica</option>
            </select>
          </div>

          <!-- Campos especÃ­ficos para INCORPORACION -->
          <div id="camposIncorporacion" style="display: none;">
            <div class="mb-3">
              <label for="inputCarrilDestino" class="form-label">Carril Destino:</label>
              <input type="number" class="form-control" id="inputCarrilDestino" placeholder="0" min="0" value="0">
            </div>
            <div class="mb-3">
              <label for="inputPosInicial" class="form-label">PosiciÃ³n Inicial:</label>
              <input type="number" class="form-control" id="inputPosInicial" placeholder="0" min="0" value="0">
            </div>
          </div>

          <!-- Campos especÃ­ficos para PROBABILISTICA -->
          <div id="camposProbabilistica" style="display: none;">
            <div class="mb-3">
              <label for="inputCarrilOrigen" class="form-label">Carril Origen:</label>
              <input type="number" class="form-control" id="inputCarrilOrigen" placeholder="0" min="0" value="0">
            </div>
            <div class="mb-3">
              <label for="inputCarrilDestinoPro b" class="form-label">Carril Destino:</label>
              <input type="number" class="form-control" id="inputCarrilDestinoProb" placeholder="0" min="0" value="0">
            </div>
            <div class="mb-3">
              <label for="inputProbabilidad" class="form-label">Probabilidad (0-1):</label>
              <input type="number" class="form-control" id="inputProbabilidad" placeholder="0.5" min="0" max="1" step="0.01" value="0.5">
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="button" class="btn btn-primary" id="btnConfirmarNuevaConexion">âœ“ Crear ConexiÃ³n</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Editar ConexiÃ³n -->
  <div class="modal fade" id="modalEditarConexion" tabindex="-1" aria-labelledby="modalEditarConexionLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header bg-warning text-dark">
          <h5 class="modal-title" id="modalEditarConexionLabel">âœï¸ Editar ConexiÃ³n</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="alert alert-info small mb-3">
            <strong>ConexiÃ³n:</strong> <span id="editConexionInfo"></span>
          </div>

          <div class="mb-3">
            <label for="editSelectTipoConexion" class="form-label">Tipo de ConexiÃ³n:</label>
            <select class="form-select" id="editSelectTipoConexion">
              <option value="LINEAL">ğŸŸ¢ Lineal (1 a 1)</option>
              <option value="INCORPORACION">ğŸŸ  IncorporaciÃ³n (varios a uno)</option>
              <option value="PROBABILISTICA">ğŸŸ£ ProbabilÃ­stica</option>
            </select>
          </div>

          <!-- Campos especÃ­ficos para INCORPORACION -->
          <div id="editCamposIncorporacion" style="display: none;">
            <div class="mb-3">
              <label for="editInputCarrilDestino" class="form-label">Carril Destino:</label>
              <input type="number" class="form-control" id="editInputCarrilDestino" placeholder="0" min="0" value="0">
            </div>
            <div class="mb-3">
              <label for="editInputPosInicial" class="form-label">PosiciÃ³n Inicial:</label>
              <input type="number" class="form-control" id="editInputPosInicial" placeholder="0" min="0" value="0">
            </div>
          </div>

          <!-- Campos especÃ­ficos para PROBABILISTICA -->
          <div id="editCamposProbabilistica" style="display: none;">
            <div class="mb-3">
              <label for="editInputCarrilOrigen" class="form-label">Carril Origen:</label>
              <input type="number" class="form-control" id="editInputCarrilOrigen" placeholder="0" min="0" value="0">
            </div>
            <div class="mb-3">
              <label for="editInputCarrilDestinoProb" class="form-label">Carril Destino:</label>
              <input type="number" class="form-control" id="editInputCarrilDestinoProb" placeholder="0" min="0" value="0">
            </div>
            <div class="mb-3">
              <label for="editInputProbabilidad" class="form-label">Probabilidad (0-1):</label>
              <input type="number" class="form-control" id="editInputProbabilidad" placeholder="0.5" min="0" max="1" step="0.01" value="0.5">
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="button" class="btn btn-warning" id="btnConfirmarEditarConexion">âœ“ Guardar Cambios</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <div class="main-content">
    <div class="header">
      <h1>ğŸš¦ Simulador de TrÃ¡fico FLUVI</h1>
    </div>

    <div class="canvas-wrapper">
      <canvas id="simuladorCanvas"></canvas>
      <canvas id="minimapa"></canvas>

      <!-- Control Bar -->
      <div id="canvasControlBar">
        <div id="controlBar" class="d-flex align-items-center">
          <button id="btnConexiones" class="btn btn-info">Mostrar Conexiones</button>
          <button id="btnPauseResume" class="btn btn-secondary me-2">â¸</button>
          <button id="btnPaso" class="btn btn-success me-2" disabled>â­</button>
          <button id="btnIntersecciones" class="btn btn-info me-2">Intersecciones</button>
          <button id="btnBorrar" class="btn btn-danger me-2">ğŸ—‘ï¸</button>
          <button id="btnRandom" class="btn btn-warning me-3">Aleatorio</button>
          <label for="velocidadSlider" class="form-label me-2 mb-0">Velocidad:</label>
          <input type="range" class="form-range me-2" id="velocidadSlider" min="1" max="100" step="1" style="width: 100px;">
          <span id="velocidadValor" class="badge bg-primary">10</span>
          <label for="probabilidadSlider" class="form-label ms-3 me-2 mb-0">GeneraciÃ³n:</label>
          <input type="range" class="form-range me-2" id="probabilidadSlider" min="0" max="100" step="1" style="width: 100px;">
          <span id="probabilidadValor" class="badge bg-primary">10</span>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ========== SISTEMA DE CARGA ==========
    (function() {
      const loadingScreen = document.getElementById('loadingScreen');
      const progressFill = document.getElementById('progressFill');
      const loadingStatus = document.getElementById('loadingStatus');

      let progress = 0;
      const statusMessages = [
        'Inicializando recursos...',
        'Cargando librerÃ­as...',
        'Preparando canvas...',
        'Generando calles...',
        'Calculando intersecciones...',
        'Creando conexiones...',
        'Iniciando simulaciÃ³n...',
        'Listo!'
      ];

      let messageIndex = 0;

      // Simular progreso de carga
      const progressInterval = setInterval(() => {
        progress += Math.random() * 15;

        if (progress >= 100) {
          progress = 100;
          clearInterval(progressInterval);
        }

        progressFill.style.width = progress + '%';

        // Cambiar mensaje segÃºn progreso
        const newMessageIndex = Math.floor((progress / 100) * statusMessages.length);
        if (newMessageIndex !== messageIndex && newMessageIndex < statusMessages.length) {
          messageIndex = newMessageIndex;
          loadingStatus.textContent = statusMessages[messageIndex];
        }
      }, 200);

      // FunciÃ³n para ocultar la pantalla de carga
      window.hideLoadingScreen = function() {
        clearInterval(progressInterval);
        progressFill.style.width = '100%';
        loadingStatus.textContent = 'Listo!';

        setTimeout(() => {
          loadingScreen.classList.add('fade-out');
          setTimeout(() => {
            loadingScreen.style.display = 'none';
          }, 500);
        }, 500);
      };

      // Ocultar pantalla cuando todo estÃ© cargado
      window.addEventListener('load', () => {
        // Esperar un mÃ­nimo de 2 segundos para que se vean las instrucciones
        setTimeout(() => {
          // Verificar que los scripts principales estÃ©n cargados
          if (typeof iniciarSimulacion !== 'undefined') {
            hideLoadingScreen();
          } else {
            // Esperar un poco mÃ¡s si no estÃ¡ listo
            setTimeout(hideLoadingScreen, 1000);
          }
        }, 2000);
      });

      // Backup: ocultar despuÃ©s de 15 segundos mÃ¡ximo
      setTimeout(() => {
        if (loadingScreen && !loadingScreen.classList.contains('fade-out')) {
          console.warn('Forzando cierre de pantalla de carga');
          hideLoadingScreen();
        }
      }, 15000);
    })();

  </script>

  <script src="trafico.js"></script>
  <script src="editor.js"></script>
  <script src="constructor.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>