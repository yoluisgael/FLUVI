<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Simulador de Calles Din√°micas</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.plot.ly/plotly-2.27.0.min.js" charset="utf-8"></script>
  <link rel="stylesheet" href="estilos.css">
  <link rel="stylesheet" href="minimapa.css">
</head>

<body>
  <!-- ========== PANTALLA DE CARGA ========== -->
  <div id="loadingScreen">
    <div class="loading-content">
      <div class="loading-header">
        <h1>üö¶ Simulador de Tr√°fico FLUVI</h1>
        <p>Cargando simulaci√≥n...</p>
      </div>

      <div class="loading-spinner">
        <div class="spinner"></div>
      </div>

      <div class="instructions">
        <div class="instruction-card">
          <h3>üñ±Ô∏è Controles B√°sicos</h3>
          <p>Usa la rueda del mouse para hacer zoom. Arrastra el canvas para moverte. Haz clic en las celdas para agregar/quitar veh√≠culos.</p>
        </div>

        <div class="instruction-card">
          <h3>‚öôÔ∏è Panel de Control</h3>
          <p>Selecciona calles en el panel izquierdo para modificar probabilidades de generaci√≥n y cambio de carril.</p>
        </div>

        <div class="instruction-card">
          <h3>‚è∏Ô∏è Simulaci√≥n</h3>
          <p>Pausa, avanza paso a paso, ajusta la velocidad y visualiza m√©tricas de tu simulaci√≥n.</p>
        </div>

        <div class="instruction-card">
          <h3>‚úèÔ∏è Modo Edici√≥n</h3>
          <p>Selecciona una calle o edificio y activa el modo edici√≥n para reposicionar y rotar visualmente.</p>
        </div>

        <div class="instruction-card">
          <h3>üåä Curvas en Calles</h3>
          <p>Activa el modo curva y arrastra los v√©rtices perpendiculares a la calle para crear curvaturas suaves.</p>
        </div>

        <div class="instruction-card">
          <h3>üö¶ Intersecciones</h3>
          <p>Activa la visualizaci√≥n de intersecciones para ver conflictos de tr√°fico entre calles.</p>
        </div>

        <div class="instruction-card">
          <h3>üîó Conexiones</h3>
          <p>Muestra las conexiones entre calles: lineales (verde), incorporaci√≥n (naranja) y probabil√≠sticas (morado).</p>
        </div>
      </div>

      <div class="loading-progress">
        <div class="progress-bar-custom">
          <div class="progress-fill" id="progressFill"></div>
        </div>
        <div class="loading-status" id="loadingStatus">Inicializando recursos...</div>
      </div>
    </div>
  </div>

  <!-- Toggle button for mobile -->
  <button class="sidebar-toggle" id="sidebarToggle">
    <span id="toggleIcon">üìä</span>
  </button>

  <!-- Handles de edici√≥n (se posicionan din√°micamente) -->
  <div id="moveHandle" class="edit-handle move-handle"></div>
  <div id="rotateHandle" class="edit-handle rotate-handle"></div>

  <!-- Sidebar Panel -->
  <div class="sidebar" id="sidebar">
    <h4>üìä Panel de Control</h4>

    <!-- Indicador de modo edici√≥n -->
    <div id="editModeBadge" class="edit-mode-badge">
      üîß MODO EDICI√ìN ACTIVO
    </div>

    <!-- ========== ACCORDIONS ========== -->
    <div class="accordion" id="controlPanelAccordion">

      <!-- Accordion 1: Instrucciones -->
      <div class="accordion-item">
        <h2 class="accordion-header" id="headingInstrucciones">
          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseInstrucciones" aria-expanded="false" aria-controls="collapseInstrucciones">
            üìñ Instrucciones
          </button>
        </h2>
        <div id="collapseInstrucciones" class="accordion-collapse collapse" aria-labelledby="headingInstrucciones" data-bs-parent="#controlPanelAccordion">
          <div class="accordion-body">
            <p class="text-muted small mb-3">Aprende a usar el simulador de tr√°fico</p>
            <button class="btn btn-info w-100" data-bs-toggle="modal" data-bs-target="#instructionsModal">
              üìö Ver Gu√≠a Completa
            </button>
          </div>
        </div>
      </div>

      <!-- Accordion 2: Configuraci√≥n de Objetos -->
      <div class="accordion-item">
        <h2 class="accordion-header" id="headingConfig">
          <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseConfig" aria-expanded="true" aria-controls="collapseConfig">
            ‚öôÔ∏è Configuraci√≥n de Objetos
          </button>
        </h2>
        <div id="collapseConfig" class="accordion-collapse collapse show" aria-labelledby="headingConfig" data-bs-parent="#controlPanelAccordion">
          <div class="accordion-body">
            
            <!-- Selector de tipo de objeto -->
            <label for="selectTipoObjeto" class="form-label">Tipo de Objeto:</label>
            <select id="selectTipoObjeto" class="form-select mb-3">
              <option value="">Selecciona tipo...</option>
              <option value="calle">üõ£Ô∏è Calle</option>
              <option value="edificio">üè¢ Edificio</option>
            </select>

            <!-- Selector de Calle -->
            <div id="calleSelector" style="display: none;">
              <label for="selectCalle" class="form-label">Calle:</label>
              <select id="selectCalle" class="form-select mb-3">
                <option value="">Seleccione una calle...</option>
              </select>
            </div>

            <!-- Selector de Edificio -->
            <div id="edificioSelector" style="display: none;">
              <label for="selectEdificio" class="form-label">Edificio:</label>
              <select id="selectEdificio" class="form-select mb-3">
                <option value="">Seleccione un edificio...</option>
              </select>
            </div>

            <!-- Campos de probabilidad (solo para calles) -->
            <div id="calleConfigFields" style="display: none;">
              <label for="inputProbabilidadGeneracion" class="form-label">Probabilidad de Generaci√≥n (%):</label>
              <input type="number" id="inputProbabilidadGeneracion" class="form-control mb-3" min="0" max="100" step="1" placeholder="0-100">

              <label for="inputProbabilidadSalto" class="form-label">Probabilidad de Cambio de Carril (%):</label>
              <input type="number" id="inputProbabilidadSalto" class="form-control mb-3" min="0" max="100" step="1" placeholder="0-100">
            </div>

            <!-- Bot√≥n de modo edici√≥n -->
            <button id="btnModoEdicion" class="btn btn-warning w-100 mb-2" disabled>
              ‚úèÔ∏è Modo Edici√≥n
            </button>

            <!-- Botones de guardar/cancelar (solo visibles en modo edici√≥n) -->
            <div id="editActionButtons" style="display: none;">
              <div class="d-flex gap-2 mb-2">
                <button id="btnGuardarEdicion" class="btn btn-success flex-fill">
                  üíæ Guardar
                </button>
                <button id="btnCancelarEdicion" class="btn btn-secondary flex-fill">
                  ‚ùå Cancelar
                </button>
              </div>
            </div>

            <!-- Dropdown de Ajustes Avanzados -->
            <div class="mt-3">
              <button class="btn btn-outline-primary w-100" type="button" id="btnAjustesAvanzados">
                üîß Ajustes Avanzados <span id="advancedArrow">‚ñº</span>
              </button>

              <div class="advanced-settings" id="advancedSettings">
                <div class="mt-3">
                  <h6>üìç Posici√≥n y Rotaci√≥n Manual</h6>

                  <div class="coordinate-input">
                    <label for="inputPosX">X:</label>
                    <input type="number" id="inputPosX" class="form-control" step="1" placeholder="Posici√≥n X">
                  </div>

                  <div class="coordinate-input">
                    <label for="inputPosY">Y:</label>
                    <input type="number" id="inputPosY" class="form-control" step="1" placeholder="Posici√≥n Y">
                  </div>

                  <div class="coordinate-input">
                    <label for="inputAngulo">√Ångulo:</label>
                    <input type="number" id="inputAngulo" class="form-control" min="0" max="360" step="1" placeholder="0-360¬∞">
                    <span>¬∞</span>
                  </div>

                  <button id="btnAplicarPosicion" class="btn btn-sm btn-success mt-2 w-100">
                    ‚úì Aplicar Posici√≥n
                  </button>

                  <div class="mt-3 p-2 bg-light rounded">
                    <small class="text-muted">
                      <strong>üí° Consejo:</strong> Usa el modo edici√≥n para arrastrar y rotar visualmente el objeto.
                    </small>
                  </div>
                </div>
              </div>
            </div>

            <!-- Bot√≥n aplicar cambios (solo para calles) -->
            <div id="calleApplyButton" style="display: none;">
              <button id="btnActualizarCalle" class="btn btn-primary mt-3 w-100">‚úì Aplicar Cambios</button>
            </div>

            <!-- NUEVO: Secci√≥n de Modo Curva (solo para calles) -->
            <div id="curvaModeSection" style="display: none;">
              <div class="mt-3 border-top pt-3">
                <h6>üåä Modo Curva</h6>
                <div class="d-flex gap-2">
                  <button id="btnToggleCurva" class="btn btn-outline-info flex-fill" disabled>
                    üåä Activar Curvas
                  </button>
                  <button id="btnResetVertices" class="btn btn-outline-secondary flex-fill" disabled>
                    üîÑ Resetear
                  </button>
                </div>
                <small class="text-muted d-block mt-2">
                  üí° <strong>Haz clic en un v√©rtice</strong> y arr√°stralo perpendicular a la calle para curvarlo (m√°x ¬±30¬∞)
                </small>
                <small class="text-muted d-block mt-1">
                  üéØ Aparecer√° una gu√≠a visual azul mostrando la direcci√≥n de arrastre
                </small>
              </div>
            </div>

          </div>
        </div>
      </div>

      <!-- Accordion 3: M√©tricas en Tiempo Real -->
      <div class="accordion-item">
        <h2 class="accordion-header" id="headingMetrics">
          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseMetrics" aria-expanded="false" aria-controls="collapseMetrics">
            üìà M√©tricas de la Simulaci√≥n
          </button>
        </h2>
        <div id="collapseMetrics" class="accordion-collapse collapse" aria-labelledby="headingMetrics" data-bs-parent="#controlPanelAccordion">
          <div class="accordion-body p-2">
            <div class="chart-container mb-3">
              <h6>üöó Densidad de Tr√°fico</h6>
              <div id="densityChart" style="height: 180px;"></div>
            </div>

            <div class="chart-container mb-3">
              <h6>üåä Flujo Vehicular</h6>
              <div id="flowChart" style="height: 180px;"></div>
            </div>

            <div class="chart-container">
              <h6>‚ö° Velocidad Promedio</h6>
              <div id="speedChart" style="height: 180px;"></div>
            </div>
          </div>
        </div>
      </div>

    </div>
    <!-- FIN ACCORDIONS -->
  </div>

  <!-- Modal de Instrucciones -->
  <div class="modal fade" id="instructionsModal" tabindex="-1" aria-labelledby="instructionsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title" id="instructionsModalLabel">üìö Gu√≠a del Simulador de Tr√°fico FLUVI</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="row">
            <div class="col-md-6 mb-4">
              <div class="card border-primary">
                <div class="card-body">
                  <h5 class="card-title text-primary">üñ±Ô∏è Controles B√°sicos</h5>
                  <ul class="list-unstyled">
                    <li><strong>Zoom:</strong> Rueda del mouse</li>
                    <li><strong>Mover vista:</strong> Arrastrar con el mouse</li>
                    <li><strong>Agregar/quitar veh√≠culos:</strong> Clic en celdas</li>
                    <li><strong>Minimapa:</strong> Clic para teletransportarse</li>
                  </ul>
                </div>
              </div>
            </div>

            <div class="col-md-6 mb-4">
              <div class="card border-success">
                <div class="card-body">
                  <h5 class="card-title text-success">‚öôÔ∏è Panel de Control</h5>
                  <ul class="list-unstyled">
                    <li><strong>Tipo de objeto:</strong> Selecciona calle o edificio</li>
                    <li><strong>Probabilidad de generaci√≥n:</strong> % de crear veh√≠culos (calles)</li>
                    <li><strong>Cambio de carril:</strong> % de saltar de carril (calles)</li>
                    <li><strong>Aplicar cambios:</strong> Bot√≥n azul al final</li>
                  </ul>
                </div>
              </div>
            </div>

            <div class="col-md-6 mb-4">
              <div class="card border-warning">
                <div class="card-body">
                  <h5 class="card-title text-warning">‚úèÔ∏è Modo Edici√≥n</h5>
                  <ul class="list-unstyled">
                    <li>1. Selecciona una calle o edificio</li>
                    <li>2. Activa "Modo Edici√≥n"</li>
                    <li>3. Arrastra el handle azul para mover</li>
                    <li>4. Arrastra el handle verde para rotar</li>
                    <li>5. Guarda o cancela los cambios</li>
                  </ul>
                </div>
              </div>
            </div>

            <div class="col-md-6 mb-4">
              <div class="card border-info">
                <div class="card-body">
                  <h5 class="card-title text-info">üåä Modo Curva</h5>
                  <ul class="list-unstyled">
                    <li>1. Selecciona una calle</li>
                    <li>2. Activa "Mostrar Conexiones"</li>
                    <li>3. Haz clic en "Activar Curvas"</li>
                    <li>4. Arrastra v√©rtices perpendicular a la calle</li>
                    <li>5. Curva m√°xima: ¬±30¬∞</li>
                    <li>6. Usa "Resetear" para restaurar</li>
                  </ul>
                </div>
              </div>
            </div>

            <div class="col-md-6 mb-4">
              <div class="card border-info">
                <div class="card-body">
                  <h5 class="card-title text-info">‚è∏Ô∏è Simulaci√≥n</h5>
                  <ul class="list-unstyled">
                    <li><strong>Pause/Resume:</strong> Detener/continuar</li>
                    <li><strong>Paso:</strong> Avanzar frame por frame</li>
                    <li><strong>Velocidad:</strong> Slider de velocidad</li>
                    <li><strong>Generaci√≥n:</strong> % global de veh√≠culos</li>
                  </ul>
                </div>
              </div>
            </div>

            <div class="col-md-6 mb-4">
              <div class="card border-danger">
                <div class="card-body">
                  <h5 class="card-title text-danger">üö¶ Intersecciones</h5>
                  <p>Las intersecciones detectan colisiones entre calles. Al activar la visualizaci√≥n ver√°s:</p>
                  <ul class="list-unstyled">
                    <li>üü£ <strong>C√≠rculos morados:</strong> Puntos de intersecci√≥n</li>
                    <li>üöó Sistema de prioridad alternada</li>
                    <li>‚è±Ô∏è Los veh√≠culos esperan su turno</li>
                  </ul>
                </div>
              </div>
            </div>

            <div class="col-md-6 mb-4">
              <div class="card border-secondary">
                <div class="card-body">
                  <h5 class="card-title text-secondary">üîó Conexiones</h5>
                  <p>Tipos de conexiones entre calles:</p>
                  <ul class="list-unstyled">
                    <li>üü¢ <strong>Verde (Lineal):</strong> 1 a 1 entre carriles</li>
                    <li>üü† <strong>Naranja (Incorporaci√≥n):</strong> Varios a uno</li>
                    <li>üü£ <strong>Morado (Probabil√≠stica):</strong> Con probabilidad</li>
                    <li>üî¥ <strong>Roja:</strong> Conexi√≥n bloqueada</li>
                  </ul>
                </div>
              </div>
            </div>

            <div class="col-12">
              <div class="card bg-light">
                <div class="card-body">
                  <h5 class="card-title">üìä M√©tricas del Simulador</h5>
                  <ul class="list-unstyled">
                    <li><strong>Densidad de Tr√°fico:</strong> % de ocupaci√≥n de las calles</li>
                    <li><strong>Flujo Vehicular:</strong> Carros por segundo movi√©ndose</li>
                    <li><strong>Velocidad Promedio:</strong> % de veh√≠culos en movimiento</li>
                  </ul>
                  <div class="alert alert-info mb-0 mt-3">
                    <small><strong>üí° Tip:</strong> Las m√©tricas se actualizan cada 5 frames de simulaci√≥n para optimizar el rendimiento.</small>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <div class="main-content">
    <div class="header">
      <h1>üö¶ Simulador de Tr√°fico FLUVI</h1>
    </div>

    <div class="canvas-wrapper">
      <canvas id="simuladorCanvas"></canvas>
      <canvas id="minimapa"></canvas>

      <!-- Control Bar -->
      <div id="canvasControlBar">
        <div id="controlBar" class="d-flex align-items-center">
          <button id="btnConexiones" class="btn btn-info">Mostrar Conexiones</button>
          <button id="btnPauseResume" class="btn btn-secondary me-2">‚è∏ Pause</button>
          <button id="btnPaso" class="btn btn-success me-2" disabled>‚è≠ Paso</button>
          <button id="btnIntersecciones" class="btn btn-info me-2">üö¶ Intersecciones</button>
          <button id="btnBorrar" class="btn btn-danger me-2">üóëÔ∏è Borrar</button>
          <button id="btnRandom" class="btn btn-warning me-3">üé≤ Aleatorio</button>
          <label for="velocidadSlider" class="form-label me-2 mb-0">Velocidad:</label>
          <input type="range" class="form-range me-2" id="velocidadSlider" min="1" max="100" step="1" style="width: 100px;">
          <span id="velocidadValor" class="badge bg-primary">10</span>
          <label for="probabilidadSlider" class="form-label ms-3 me-2 mb-0">Generaci√≥n:</label>
          <input type="range" class="form-range me-2" id="probabilidadSlider" min="0" max="100" step="1" style="width: 100px;">
          <span id="probabilidadValor" class="badge bg-primary">10</span>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ========== SISTEMA DE CARGA ==========
    (function() {
      const loadingScreen = document.getElementById('loadingScreen');
      const progressFill = document.getElementById('progressFill');
      const loadingStatus = document.getElementById('loadingStatus');

      let progress = 0;
      const statusMessages = [
        'Inicializando recursos...',
        'Cargando librer√≠as...',
        'Preparando canvas...',
        'Generando calles...',
        'Calculando intersecciones...',
        'Creando conexiones...',
        'Iniciando simulaci√≥n...',
        'Listo!'
      ];

      let messageIndex = 0;

      // Simular progreso de carga
      const progressInterval = setInterval(() => {
        progress += Math.random() * 15;

        if (progress >= 100) {
          progress = 100;
          clearInterval(progressInterval);
        }

        progressFill.style.width = progress + '%';

        // Cambiar mensaje seg√∫n progreso
        const newMessageIndex = Math.floor((progress / 100) * statusMessages.length);
        if (newMessageIndex !== messageIndex && newMessageIndex < statusMessages.length) {
          messageIndex = newMessageIndex;
          loadingStatus.textContent = statusMessages[messageIndex];
        }
      }, 200);

      // Funci√≥n para ocultar la pantalla de carga
      window.hideLoadingScreen = function() {
        clearInterval(progressInterval);
        progressFill.style.width = '100%';
        loadingStatus.textContent = 'Listo!';

        setTimeout(() => {
          loadingScreen.classList.add('fade-out');
          setTimeout(() => {
            loadingScreen.style.display = 'none';
          }, 500);
        }, 500);
      };

      // Ocultar pantalla cuando todo est√© cargado
      window.addEventListener('load', () => {
        // Esperar un m√≠nimo de 2 segundos para que se vean las instrucciones
        setTimeout(() => {
          // Verificar que los scripts principales est√©n cargados
          if (typeof iniciarSimulacion !== 'undefined') {
            hideLoadingScreen();
          } else {
            // Esperar un poco m√°s si no est√° listo
            setTimeout(hideLoadingScreen, 1000);
          }
        }, 2000);
      });

      // Backup: ocultar despu√©s de 15 segundos m√°ximo
      setTimeout(() => {
        if (loadingScreen && !loadingScreen.classList.contains('fade-out')) {
          console.warn('Forzando cierre de pantalla de carga');
          hideLoadingScreen();
        }
      }, 15000);
    })();

    // ========== MANEJO DE VISIBILIDAD DE SECCIONES ==========
    document.addEventListener('DOMContentLoaded', function() {
      const selectTipoObjeto = document.getElementById('selectTipoObjeto');
      const calleSelector = document.getElementById('calleSelector');
      const edificioSelector = document.getElementById('edificioSelector');
      const calleConfigFields = document.getElementById('calleConfigFields');
      const calleApplyButton = document.getElementById('calleApplyButton');
      const curvaModeSection = document.getElementById('curvaModeSection');

      if (selectTipoObjeto) {
        selectTipoObjeto.addEventListener('change', function() {
          const tipo = this.value;
          
          if (tipo === 'calle') {
            calleSelector.style.display = 'block';
            edificioSelector.style.display = 'none';
            calleConfigFields.style.display = 'block';
            calleApplyButton.style.display = 'block';
            curvaModeSection.style.display = 'block';
          } else if (tipo === 'edificio') {
            calleSelector.style.display = 'none';
            edificioSelector.style.display = 'block';
            calleConfigFields.style.display = 'none';
            calleApplyButton.style.display = 'none';
            curvaModeSection.style.display = 'none';
          } else {
            calleSelector.style.display = 'none';
            edificioSelector.style.display = 'none';
            calleConfigFields.style.display = 'none';
            calleApplyButton.style.display = 'none';
            curvaModeSection.style.display = 'none';
          }
        });
      }
    });
  </script>

  <script src="trafico.js"></script>
  <script src="editor.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>