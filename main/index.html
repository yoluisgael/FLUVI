<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Simulador de Calles Din√°micas</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <link rel="stylesheet" href="src/css/estilos.css">
  <link rel="stylesheet" href="src/css/minimapa.css">
</head>

<body>
  <!-- ========== PANTALLA DE CARGA ========== -->
  <div id="loadingScreen">
    <div class="loading-content">
      <div class="loading-header">
        <h1>Simulador de Tr√°fico FLUVI</h1>
        <p>Cargando simulaci√≥n...</p>
      </div>

      <div class="loading-spinner">
        <div class="spinner"></div>
      </div>

      <div class="instructions">
        <div class="instruction-card">
          <h3>üñ±Ô∏è Controles B√°sicos</h3>
          <p>Usa la rueda del mouse para hacer zoom. Arrastra el canvas para moverte. Haz clic en las celdas para agregar/quitar veh√≠culos.</p>
        </div>

        <div class="instruction-card">
          <h3>‚öôÔ∏è Selecci√≥n R√°pida</h3>
          <p>Presiona Ctrl+Clic (‚åò+Clic en Mac) sobre calles o edificios en el canvas para seleccionarlos al instante. Tambi√©n puedes usar los men√∫s desplegables.</p>
        </div>

        <div class="instruction-card">
          <h3>‚è∏Ô∏è Simulaci√≥n</h3>
          <p>Pausa, avanza paso a paso, ajusta la velocidad y visualiza m√©tricas de tu simulaci√≥n.</p>
        </div>

        <div class="instruction-card">
          <h3>‚úèÔ∏è Modo Edici√≥n</h3>
          <p>Selecciona una calle o edificio y activa el modo edici√≥n para reposicionar y rotar visualmente.</p>
        </div>

        <div class="instruction-card">
          <h3>üåä Curvas en Calles</h3>
          <p>Activa el modo curva y arrastra los v√©rtices perpendiculares a la calle para crear curvaturas suaves.</p>
        </div>

        <div class="instruction-card">
          <h3>üö¶ Intersecciones</h3>
          <p>Activa la visualizaci√≥n de intersecciones para ver conflictos de tr√°fico entre calles.</p>
        </div>

        <div class="instruction-card">
          <h3>üîó Conexiones</h3>
          <p>Muestra las conexiones entre calles: lineales (verde), incorporaci√≥n (naranja) y probabil√≠sticas (morado).</p>
        </div>

        <div class="instruction-card">
          <h3>üèóÔ∏è Constructor de Mapas</h3>
          <p>Crea tus propias simulaciones desde cero, gu√°rdalas como JSON y carga mapas personalizados.</p>
        </div>
      </div>

      <div class="loading-progress">
        <div class="progress-bar-custom">
          <div class="progress-fill" id="progressFill"></div>
        </div>
        <div class="loading-status" id="loadingStatus">Inicializando recursos...</div>
      </div>
    </div>
  </div>

  <!-- Bot√≥n flotante para mostrar sidebar (visible solo cuando sidebar est√° oculto) -->
  <button class="sidebar-toggle-float" id="sidebarToggleFloat" data-bs-toggle="tooltip" data-bs-placement="right" data-bs-title="Mostrar panel de control" style="display: none;">
    <span>‚ò∞</span>
  </button>

  <!-- Handles de edici√≥n (se posicionan din√°micamente) -->
  <div id="moveHandle" class="edit-handle move-handle"></div>
  <div id="rotateHandle" class="edit-handle rotate-handle"></div>

  <!-- Sidebar Panel -->
  <div class="sidebar" id="sidebar">
    <!-- Toggle button dentro del panel (esquina superior derecha) -->
    <button class="sidebar-toggle-inner" id="sidebarToggle" data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-title="Ocultar panel de control">
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
        <line x1="3" y1="12" x2="15" y2="12"></line>
        <polyline points="10 5 3 12 10 19"></polyline>
        <line x1="21" y1="4" x2="21" y2="20"></line>
      </svg>
    </button>

    <h4>Panel de Control</h4>

    <!-- Indicador de modo edici√≥n -->
    <div id="editModeBadge" class="edit-mode-badge">
      üîß MODO EDICI√ìN ACTIVO
    </div>

    <!-- ========= ACCORDIONS ========== -->
    <div class="accordion" id="controlPanelAccordion">

      <!-- Accordion 1: Instrucciones -->
      <div class="accordion-item">
        <h2 class="accordion-header" id="headingInstrucciones">
          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseInstrucciones" aria-expanded="false" aria-controls="collapseInstrucciones">
            üìñ Instrucciones
          </button>
        </h2>
        <div id="collapseInstrucciones" class="accordion-collapse collapse" aria-labelledby="headingInstrucciones" data-bs-parent="#controlPanelAccordion">
          <div class="accordion-body">
            <p class="text-muted small mb-3">Aprende a usar el simulador de tr√°fico</p>
            <button class="btn btn-info w-100" data-bs-toggle="modal" data-bs-target="#instructionsModal" data-bs-title="Abrir la gu√≠a completa del simulador con instrucciones detalladas">
              üìö Ver Gu√≠a Completa
            </button>
          </div>
        </div>
      </div>

      <!-- Accordion 2: Configuraci√≥n de FLUVI -->
      <div class="accordion-item">
        <h2 class="accordion-header" id="headingConfigFLUVI">
          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseConfigFLUVI" aria-expanded="false" aria-controls="collapseConfigFLUVI">
            üé® Configuraci√≥n de FLUVI
          </button>
        </h2>
        <div id="collapseConfigFLUVI" class="accordion-collapse collapse" aria-labelledby="headingConfigFLUVI" data-bs-parent="#controlPanelAccordion">
          <div class="accordion-body">
            <h6 class="mb-3">Apariencia</h6>

            <!-- Switch Modo Oscuro -->
            <div class="form-check form-switch">
              <input class="form-check-input" type="checkbox" id="switchModoOscuro">
              <label class="form-check-label" for="switchModoOscuro">
                <span id="labelModoOscuro">üåô Modo Oscuro</span>
              </label>
            </div>

            <!-- Switch Logs de Consola -->
            <div class="form-check form-switch mt-3">
              <input class="form-check-input" type="checkbox" id="switchConsoleLogs">
              <label class="form-check-label" for="switchConsoleLogs">
                <span id="labelConsoleLogs">üìù Mostrar Logs en Consola</span>
              </label>
            </div>

            <div class="alert alert-info p-2 small mt-3 mb-0">
              <strong>üí° Consejo:</strong> El modo oscuro es ideal para trabajar en ambientes con poca luz. Desactiva los logs de consola para mejorar el rendimiento en producci√≥n.
            </div>
          </div>
        </div>
      </div>

      <!-- Accordion 3: Configuraci√≥n de Calles -->
      <div class="accordion-item">
        <h2 class="accordion-header" id="headingConfig">
          <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseConfig" aria-expanded="true" aria-controls="collapseConfig">
            ‚öôÔ∏è Configuraci√≥n de Calles
          </button>
        </h2>
        <div id="collapseConfig" class="accordion-collapse collapse show" aria-labelledby="headingConfig" data-bs-parent="#controlPanelAccordion">
          <div class="accordion-body">

            <!-- Selector de Calle -->
            <label for="selectCalle" class="form-label">Seleccionar Calle:</label>
            <select id="selectCalle" class="form-select mb-3">
              <option value="">Seleccione una calle...</option>
            </select>

            <!-- Campos de probabilidad -->
            <div id="calleConfigFields">
              <label for="inputProbabilidadGeneracion" class="form-label">Probabilidad de Generaci√≥n (%):</label>
              <input type="number" id="inputProbabilidadGeneracion" class="form-control mb-3" min="0" max="100" step="1" placeholder="0-100">

              <label for="inputProbabilidadSalto" class="form-label">Probabilidad de Cambio de Carril (%):</label>
              <input type="number" id="inputProbabilidadSalto" class="form-control mb-3" min="0" max="100" step="1" placeholder="0-100">
            </div>

            <!-- Bot√≥n aplicar cambios -->
            <div id="calleApplyButton">
              <button id="btnActualizarCalle" class="btn btn-primary w-100" data-bs-toggle="tooltip" data-bs-title="Aplicar las probabilidades configuradas a la calle seleccionada">‚úì Aplicar Cambios</button>
            </div>

            <div class="alert alert-info p-2 small mt-3 mb-0">
              <strong>üí° Atajo r√°pido:</strong> Presiona <kbd>Ctrl</kbd> (o <kbd>‚åò Cmd</kbd> en Mac) + clic sobre cualquier calle en el canvas para seleccionarla r√°pidamente.
            </div>

          </div>
        </div>
      </div>

      <!-- Accordion 4: Configuraci√≥n de Escenarios -->
      <div class="accordion-item">
        <h2 class="accordion-header" id="headingEscenarios">
          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseEscenarios" aria-expanded="false" aria-controls="collapseEscenarios">
            üé¨ Configuraci√≥n de Escenarios
          </button>
        </h2>
        <div id="collapseEscenarios" class="accordion-collapse collapse" aria-labelledby="headingEscenarios" data-bs-parent="#controlPanelAccordion">
          <div class="accordion-body">
            <p class="text-muted small mb-3">Aqu√≠ podr√°s configurar escenarios y situaciones especiales de tr√°fico.</p>

            <div class="alert alert-warning p-2 small mb-0">
              <strong>‚ö†Ô∏è En desarrollo:</strong> Esta secci√≥n estar√° disponible pr√≥ximamente con funcionalidades avanzadas de configuraci√≥n de escenarios.
            </div>
          </div>
        </div>
      </div>

      <!-- Accordion 5: Constructor de Mapas -->
      <div class="accordion-item">
        <h2 class="accordion-header" id="headingConstructor">
          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseConstructor" aria-expanded="false" aria-controls="collapseConstructor">
            üèóÔ∏è Constructor de Mapas
          </button>
        </h2>
        <div id="collapseConstructor" class="accordion-collapse collapse" aria-labelledby="headingConstructor" data-bs-parent="#controlPanelAccordion">
          <div class="accordion-body">
            <h6 class="mb-3">üó∫Ô∏è Gesti√≥n de Simulaci√≥n</h6>

            <!-- Botones de gesti√≥n de archivo -->
            <div class="d-grid gap-2 mb-3">
              <button id="btnNuevaSimulacion" class="btn btn-success btn-sm" data-bs-toggle="tooltip" data-bs-title="Crear una nueva simulaci√≥n desde cero, borrando todo el contenido actual">
                ‚ûï Nueva Simulaci√≥n
              </button>
              <button id="btnGuardarSimulacion" class="btn btn-primary btn-sm" data-bs-toggle="tooltip" data-bs-title="Guardar la simulaci√≥n actual como archivo JSON">
                üíæ Guardar Simulaci√≥n
              </button>
              <button id="btnCargarSimulacion" class="btn btn-info btn-sm" data-bs-toggle="tooltip" data-bs-title="Cargar una simulaci√≥n desde un archivo JSON guardado previamente">
                üìÇ Cargar Simulaci√≥n
              </button>
              <input type="file" id="inputCargarSimulacion" accept=".json" style="display: none;">
            </div>

            <hr class="my-3">

            <h6 class="mb-3">üõ†Ô∏è Modo Edici√≥n Visual</h6>

            <!-- Selector de tipo de objeto -->
            <label for="selectTipoObjeto" class="form-label">Tipo de Objeto:</label>
            <select id="selectTipoObjeto" class="form-select mb-3">
              <option value="">Selecciona tipo...</option>
              <option value="calle">üõ£Ô∏è Calle</option>
              <option value="edificio">üè¢ Edificio</option>
            </select>

            <!-- Selector de Calle -->
            <div id="calleEditorSelector" style="display: none;">
              <label for="selectCalleEditor" class="form-label">Calle:</label>
              <select id="selectCalleEditor" class="form-select mb-3">
                <option value="">Seleccione una calle...</option>
              </select>
            </div>

            <!-- Selector de Edificio -->
            <div id="edificioSelector" style="display: none;">
              <label for="selectEdificio" class="form-label">Edificio:</label>
              <select id="selectEdificio" class="form-select mb-3">
                <option value="">Seleccione un edificio...</option>
              </select>
            </div>

            <!-- Bot√≥n de modo edici√≥n -->
            <button id="btnModoEdicion" class="btn btn-warning w-100 mb-2" disabled data-bs-toggle="tooltip" data-bs-title="Activar modo edici√≥n para mover y rotar el objeto seleccionado visualmente">
              ‚úèÔ∏è Modo Edici√≥n
            </button>

            <!-- Botones de guardar/cancelar (solo visibles en modo edici√≥n) -->
            <div id="editActionButtons" style="display: none;">
              <div class="d-flex gap-2 mb-2">
                <button id="btnGuardarEdicion" class="btn btn-success flex-fill" data-bs-toggle="tooltip" data-bs-title="Guardar los cambios realizados en el modo edici√≥n">
                  üíæ Guardar
                </button>
                <button id="btnCancelarEdicion" class="btn btn-secondary flex-fill" data-bs-toggle="tooltip" data-bs-title="Cancelar los cambios y restaurar la posici√≥n original">
                  ‚ùå Cancelar
                </button>
              </div>
            </div>

            <!-- Dropdown de Ajustes Avanzados -->
            <div class="mt-3">
              <button class="btn btn-outline-primary w-100" type="button" id="btnAjustesAvanzados" data-bs-toggle="tooltip" data-bs-title="Mostrar/ocultar ajustes avanzados de posici√≥n, rotaci√≥n y dimensiones">
                üîß Ajustes Avanzados <span id="advancedArrow">‚ñº</span>
              </button>

              <div class="advanced-settings" id="advancedSettings">
                <div class="mt-3">
                  <h6>üìç Posici√≥n y Rotaci√≥n Manual</h6>

                  <div class="coordinate-input">
                    <label for="inputPosX">X:</label>
                    <input type="number" id="inputPosX" class="form-control" step="1" placeholder="Posici√≥n X">
                  </div>

                  <div class="coordinate-input">
                    <label for="inputPosY">Y:</label>
                    <input type="number" id="inputPosY" class="form-control" step="1" placeholder="Posici√≥n Y">
                  </div>

                  <div class="coordinate-input">
                    <label for="inputAngulo">√Ångulo:</label>
                    <input type="number" id="inputAngulo" class="form-control" min="0" max="360" step="1" placeholder="0-360¬∞">
                    <span>¬∞</span>
                  </div>

                  <!-- Nuevos campos para dimensiones de calles -->
                  <div id="dimensionesCalleSection" style="display: none;">
                    <hr class="my-3">
                    <h6>üìè Dimensiones de Calle</h6>

                    <div class="coordinate-input">
                      <label for="inputTamanoEditar">Tama√±o:</label>
                      <input type="number" id="inputTamanoEditar" class="form-control" min="10" max="500" step="1" placeholder="Tama√±o en celdas">
                      <span>celdas</span>
                    </div>

                    <div class="coordinate-input">
                      <label for="inputCarrilesEditar">Carriles:</label>
                      <input type="number" id="inputCarrilesEditar" class="form-control" min="1" max="10" step="1" placeholder="N√∫mero de carriles">
                      <span>carriles</span>
                    </div>

                    <button id="btnAplicarDimensiones" class="btn btn-sm btn-warning mt-2 w-100" data-bs-toggle="tooltip" data-bs-title="Aplicar cambios de tama√±o y n√∫mero de carriles (elimina veh√≠culos)">
                      üìè Aplicar Dimensiones
                    </button>

                    <div class="alert alert-warning p-2 small mt-2">
                      <strong>‚ö†Ô∏è Advertencia:</strong> Cambiar las dimensiones reiniciar√° el contenido de la calle (elimina veh√≠culos existentes).
                    </div>
                  </div>

                  <button id="btnAplicarPosicion" class="btn btn-sm btn-success mt-2 w-100" data-bs-toggle="tooltip" data-bs-title="Aplicar la posici√≥n (X, Y) y √°ngulo de rotaci√≥n ingresados manualmente">
                    ‚úì Aplicar Posici√≥n
                  </button>

                  <div class="mt-3 p-2 bg-light rounded">
                    <small class="text-muted">
                      <strong>üí° Consejo:</strong> Usa el modo edici√≥n para arrastrar y rotar visualmente el objeto.
                    </small>
                  </div>
                </div>
              </div>
            </div>

            <!-- NUEVO: Secci√≥n de Modo Curva (solo para calles) -->
            <div id="curvaModeSection" style="display: none;">
              <div class="mt-3 border-top pt-3">
                <h6>üåä Modo Curva</h6>
                <small class="text-muted d-block mt-2">
                  üí° <strong>Haz clic en un v√©rtice</strong> y arr√°stralo perpendicular a la calle para curvarlo (m√°x ¬±30¬∞)
                </small>
                <small class="text-muted d-block mt-1">
                  üéØ Aparecer√° una gu√≠a visual azul mostrando la direcci√≥n de arrastre
                </small>
              </div>
            </div>

            <hr class="my-3">

            <h6 class="mb-3">üõ£Ô∏è Agregar Elementos</h6>

            <!-- Botones de agregar -->
            <div class="d-grid gap-2 mb-3">
              <button id="btnAgregarCalle" class="btn btn-outline-primary btn-sm" data-bs-toggle="tooltip" data-bs-title="Abrir formulario para crear una nueva calle en el mapa">
                ‚ûï Agregar Calle
              </button>
              <button id="btnAgregarEdificio" class="btn btn-outline-success btn-sm" data-bs-toggle="tooltip" data-bs-title="Abrir formulario para crear un nuevo edificio en el mapa">
                üè¢ Agregar Edificio
              </button>
              <button id="btnAgregarConexion" class="btn btn-outline-secondary btn-sm" data-bs-toggle="tooltip" data-bs-title="Crear una conexi√≥n entre dos calles para flujo de tr√°fico">
                üîó Agregar Conexi√≥n
              </button>
              <button id="btnEliminarObjeto" class="btn btn-outline-danger btn-sm" data-bs-toggle="tooltip" data-bs-title="Eliminar permanentemente la calle o edificio seleccionado">
                üóëÔ∏è Eliminar Objeto Seleccionado
              </button>
            </div>

            <hr class="my-3">

            <h6 class="mb-3">üîó Gesti√≥n de Conexiones</h6>

            <!-- Bot√≥n para mostrar lista de conexiones -->
            <button id="btnMostrarListaConexiones" class="btn btn-outline-info w-100 mb-2" data-bs-toggle="tooltip" data-bs-title="Mostrar/ocultar lista de todas las conexiones entre calles creadas">
              üìã Ver Conexiones Existentes
            </button>

            <!-- Lista de conexiones (inicialmente oculta) -->
            <div id="listaConexionesContainer" style="display: none;" class="mt-2">
              <div id="listaConexiones" class="list-group small" style="max-height: 300px; overflow-y: auto;">
                <!-- Las conexiones se insertar√°n aqu√≠ din√°micamente -->
              </div>
            </div>

            <hr class="my-3">

            <div class="alert alert-info p-2 small mb-0">
              <strong>üí° C√≥mo usar:</strong>
              <ul class="mb-0 mt-1 ps-3">
                <li>Crea calles y edificios con los botones</li>
                <li><kbd>Ctrl</kbd>+Clic en el canvas para seleccionar objetos r√°pidamente</li>
                <li>Usa el modo edici√≥n para posicionarlos</li>
                <li>Conecta calles con "Agregar Conexi√≥n"</li>
                <li>Gestiona conexiones existentes con "Ver Conexiones"</li>
                <li>Guarda tu mapa como archivo JSON</li>
                <li>Carga mapas guardados anteriormente</li>
              </ul>
            </div>
          </div>
        </div>
      </div>

      <!-- Accordion 6: M√©tricas en Tiempo Real -->
      <div class="accordion-item">
        <h2 class="accordion-header" id="headingMetrics">
          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseMetrics" aria-expanded="false" aria-controls="collapseMetrics">
            üìà M√©tricas de la Simulaci√≥n
          </button>
        </h2>
        <div id="collapseMetrics" class="accordion-collapse collapse" aria-labelledby="headingMetrics" data-bs-parent="#controlPanelAccordion">
          <div class="accordion-body p-2">
            <!-- Panel de Interpretaci√≥n de M√©tricas -->
            <div id="statusPanel" class="status-panel status-moderado mb-3">
              <div class="status-header">
                <span class="status-emoji">üü°</span>
                <span class="status-title">INICIANDO...</span>
              </div>
              <div class="status-description">
                Esperando datos de simulaci√≥n...
              </div>
              <div class="status-metrics">
                <div class="metric-item">
                  <span class="metric-label">Densidad:</span>
                  <span class="metric-value">0.0%</span>
                  <span class="metric-desc">‚Üí Muy baja</span>
                </div>
                <div class="metric-item">
                  <span class="metric-label">Flujo:</span>
                  <span class="metric-value">0.0 c/s</span>
                  <span class="metric-desc">‚Üí Muy bajo</span>
                </div>
                <div class="metric-item">
                  <span class="metric-label">Velocidad:</span>
                  <span class="metric-value">0.0%</span>
                  <span class="metric-desc">‚Üí Casi detenido</span>
                </div>
              </div>
              <div class="status-observations">
                <div class="observations-title">üí°</div>
              </div>
            </div>

            <div class="chart-container mb-3">
              <h6>üöó Densidad de Tr√°fico</h6>
              <div style="position: relative; height: 180px;">
                <canvas id="densityChart"></canvas>
              </div>
            </div>

            <div class="chart-container mb-3">
              <h6>üåä Flujo vehicular</h6>
              <div style="position: relative; height: 180px;">
                <canvas id="throughputChart"></canvas>
              </div>
            </div>

            <div class="chart-container mb-3">
              <h6>‚ö° Velocidad Promedio</h6>
              <div style="position: relative; height: 180px;">
                <canvas id="speedChart"></canvas>
              </div>
            </div>

            <div class="chart-container mb-3">
              <h6>üìä Tasa de Cambio</h6>
              <div style="position: relative; height: 180px;">
                <canvas id="netGenerationChart"></canvas>
              </div>
            </div>

            <hr class="my-3">

            <h6 class="mb-3">üíæ Exportar M√©tricas</h6>
            <div class="d-grid gap-2">
              <button id="btnDescargarCSV" class="btn btn-success btn-sm" data-bs-toggle="tooltip" data-bs-title="Exportar todas las m√©tricas recolectadas en formato CSV">
                Descargar CSV
              </button>
              <button id="btnDescargarJSON" class="btn btn-info btn-sm" data-bs-toggle="tooltip" data-bs-title="Exportar todas las m√©tricas recolectadas en formato JSON">
                Descargar JSON
              </button>
              <button id="btnLimpiarMetricas" class="btn btn-danger btn-sm" data-bs-toggle="tooltip" data-bs-title="Borrar todos los datos de m√©tricas recolectados y reiniciar gr√°ficas">
                Limpiar M√©tricas
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Accordion 7: Analizador de M√©tricas -->
      <div class="accordion-item">
        <h2 class="accordion-header" id="headingAnalyzer">
          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseAnalyzer" aria-expanded="false" aria-controls="collapseAnalyzer">
            üî¨ Analizador de M√©tricas
          </button>
        </h2>
        <div id="collapseAnalyzer" class="accordion-collapse collapse" aria-labelledby="headingAnalyzer" data-bs-parent="#controlPanelAccordion">
          <div class="accordion-body">
            <p class="text-muted small mb-3">Herramientas avanzadas para an√°lisis y comparaci√≥n de m√©tricas.</p>

            <div class="alert alert-warning p-2 small mb-0">
              <strong>‚ö†Ô∏è En desarrollo:</strong> Esta secci√≥n estar√° disponible pr√≥ximamente con an√°lisis estad√≠stico y comparativas.
            </div>
          </div>
        </div>
      </div>

      <!-- Accordion 8: Acerca de FLUVI -->
      <div class="accordion-item">
        <h2 class="accordion-header" id="headingAbout">
          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseAbout" aria-expanded="false" aria-controls="collapseAbout">
            ‚ÑπÔ∏è Acerca de FLUVI
          </button>
        </h2>
        <div id="collapseAbout" class="accordion-collapse collapse" aria-labelledby="headingAbout" data-bs-parent="#controlPanelAccordion">
          <div class="accordion-body">
            <h6 class="mb-3">Simulador de Sistema de Gesti√≥n del Flujo Vehicular en Vialidades Cercanas a √Åreas Acad√©micas de IPN - ESCOM</h6>

            <p class="text-muted small mb-3">Sistema de simulaci√≥n basado en aut√≥matas celulares para el an√°lisis de tr√°fico vehicular.</p>

            <button class="btn btn-info w-100" data-bs-toggle="modal" data-bs-target="#aboutModal" data-bs-title="Ver informaci√≥n completa sobre el proyecto FLUVI">
              üìñ Ver Informaci√≥n Completa
            </button>

            <div class="mt-3">
              <small class="text-muted">
                <strong>Versi√≥n:</strong> 1.0.0<br>
                <strong>A√±o:</strong> 2025
              </small>
            </div>
          </div>
        </div>
      </div>

    </div>
    <!-- FIN ACCORDIONS -->
  </div>

  <!-- Modal de Instrucciones -->
  <div class="modal fade" id="instructionsModal" tabindex="-1" aria-labelledby="instructionsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title" id="instructionsModalLabel">üìö Gu√≠a del Simulador de Tr√°fico FLUVI</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="row">
            <div class="col-md-6 mb-4">
              <div class="card border-primary">
                <div class="card-body">
                  <h5 class="card-title text-primary">üñ±Ô∏è Controles B√°sicos</h5>
                  <ul class="list-unstyled">
                    <li><strong>Zoom:</strong> Rueda del mouse</li>
                    <li><strong>Mover vista:</strong> Arrastrar con el mouse</li>
                    <li><strong>Agregar/quitar veh√≠culos:</strong> Clic en celdas</li>
                    <li><strong>Minimapa:</strong> Clic para teletransportarse</li>
                  </ul>
                </div>
              </div>
            </div>

            <div class="col-md-6 mb-4">
              <div class="card border-success">
                <div class="card-body">
                  <h5 class="card-title text-success">‚öôÔ∏è Panel de Control</h5>
                  <ul class="list-unstyled">
                    <li><strong>Selecci√≥n r√°pida:</strong> Ctrl+Clic sobre calles o edificios en el canvas</li>
                    <li><strong>Men√∫ desplegable:</strong> Selecciona objetos manualmente</li>
                    <li><strong>Probabilidades:</strong> Ajusta generaci√≥n y cambio de carril</li>
                    <li><strong>Aplicar cambios:</strong> Bot√≥n azul al final</li>
                  </ul>
                </div>
              </div>
            </div>

            <div class="col-md-6 mb-4">
              <div class="card border-warning">
                <div class="card-body">
                  <h5 class="card-title text-warning">‚úèÔ∏è Modo Edici√≥n</h5>
                  <ul class="list-unstyled">
                    <li>1. Selecciona una calle o edificio</li>
                    <li>2. Activa "Modo Edici√≥n"</li>
                    <li>3. Arrastra el handle azul para mover</li>
                    <li>4. Arrastra el handle verde para rotar</li>
                    <li>5. Guarda o cancela los cambios</li>
                  </ul>
                </div>
              </div>
            </div>

            <div class="col-md-6 mb-4">
              <div class="card border-info">
                <div class="card-body">
                  <h5 class="card-title text-info">üåä Modo Curva</h5>
                  <ul class="list-unstyled">
                    <li>1. Selecciona una calle</li>
                    <li>2. Activa "Mostrar Conexiones"</li>
                    <li>3. Haz clic en "Activar Curvas"</li>
                    <li>4. Arrastra v√©rtices perpendicular a la calle</li>
                    <li>5. Curva m√°xima: ¬±30¬∞</li>
                    <li>6. Usa "Resetear" para restaurar</li>
                  </ul>
                </div>
              </div>
            </div>

            <div class="col-md-6 mb-4">
              <div class="card border-info">
                <div class="card-body">
                  <h5 class="card-title text-info">‚è∏Ô∏è Simulaci√≥n</h5>
                  <ul class="list-unstyled">
                    <li><strong>Pause/Resume:</strong> Detener/continuar</li>
                    <li><strong>Paso:</strong> Avanzar frame por frame</li>
                    <li><strong>Velocidad:</strong> Slider de velocidad</li>
                    <li><strong>Generaci√≥n:</strong> % global de veh√≠culos</li>
                  </ul>
                </div>
              </div>
            </div>

            <div class="col-md-6 mb-4">
              <div class="card border-danger">
                <div class="card-body">
                  <h5 class="card-title text-danger">üö¶ Intersecciones</h5>
                  <p>Las intersecciones detectan colisiones entre calles. Al activar la visualizaci√≥n ver√°s:</p>
                  <ul class="list-unstyled">
                    <li>üü£ <strong>C√≠rculos morados:</strong> Puntos de intersecci√≥n</li>
                    <li>üöó Sistema de prioridad alternada</li>
                    <li>‚è±Ô∏è Los veh√≠culos esperan su turno</li>
                  </ul>
                </div>
              </div>
            </div>

            <div class="col-md-6 mb-4">
              <div class="card border-secondary">
                <div class="card-body">
                  <h5 class="card-title text-secondary">üîó Conexiones</h5>
                  <p>Tipos de conexiones entre calles:</p>
                  <ul class="list-unstyled">
                    <li>üü¢ <strong>Verde (Lineal):</strong> 1 a 1 entre carriles</li>
                    <li>üü† <strong>Naranja (Incorporaci√≥n):</strong> Varios a uno</li>
                    <li>üü£ <strong>Morado (Probabil√≠stica):</strong> Con probabilidad</li>
                    <li>üî¥ <strong>Roja:</strong> Conexi√≥n bloqueada</li>
                  </ul>
                </div>
              </div>
            </div>

            <div class="col-md-6 mb-4">
              <div class="card border-success">
                <div class="card-body">
                  <h5 class="card-title text-success">üèóÔ∏è Constructor de Mapas</h5>
                  <ul class="list-unstyled">
                    <li><strong>Ctrl+Clic:</strong> Selecciona calles y edificios directamente en el canvas</li>
                    <li><strong>Agregar objetos:</strong> Usa los botones para crear calles y edificios</li>
                    <li><strong>Modo edici√≥n:</strong> Arrastra y rota objetos visualmente</li>
                    <li><strong>Conexiones:</strong> Conecta calles para crear flujo de tr√°fico</li>
                    <li><strong>Guardar/Cargar:</strong> Exporta e importa simulaciones como JSON</li>
                  </ul>
                </div>
              </div>
            </div>

            <div class="col-12">
              <div class="card bg-light">
                <div class="card-body">
                  <h5 class="card-title">üìä M√©tricas del Simulador</h5>
                  <ul class="list-unstyled">
                    <li><strong>Densidad de Tr√°fico:</strong> % de ocupaci√≥n de las calles</li>
                    <li><strong>Flujo Vehicular:</strong> Carros por segundo movi√©ndose</li>
                    <li><strong>Velocidad Promedio:</strong> % de veh√≠culos en movimiento</li>
                  </ul>
                  <div class="alert alert-info mb-0 mt-3">
                    <small><strong>üí° Tip:</strong> Las m√©tricas se actualizan cada 5 frames de simulaci√≥n para optimizar el rendimiento.</small>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Nueva Calle -->
  <div class="modal fade" id="modalNuevaCalle" tabindex="-1" aria-labelledby="modalNuevaCalleLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title" id="modalNuevaCalleLabel">‚ûï Agregar Nueva Calle</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="inputNombreCalle" class="form-label">Nombre:</label>
            <input type="text" class="form-control" id="inputNombreCalle" placeholder="Ej: Calle Principal">
          </div>
          <div class="mb-3">
            <label for="inputTamanoCalle" class="form-label">Tama√±o (celdas):</label>
            <input type="number" class="form-control" id="inputTamanoCalle" placeholder="100" min="1" value="100">
          </div>
          <div class="mb-3">
            <label for="selectTipoCalle" class="form-label">Tipo:</label>
            <select class="form-select" id="selectTipoCalle">
              <option value="GENERADOR">üöó Generador</option>
              <option value="CONEXION" selected>üõ£Ô∏è Conexi√≥n</option>
              <option value="DEVORADOR">üèÅ Devorador</option>
            </select>
          </div>
          <div class="mb-3">
            <label for="inputCarrilesCalle" class="form-label">N√∫mero de Carriles:</label>
            <input type="number" class="form-control" id="inputCarrilesCalle" placeholder="3" min="1" value="3">
          </div>
          <div class="row">
            <div class="col-md-4 mb-3">
              <label for="inputXCalle" class="form-label">Posici√≥n X:</label>
              <input type="number" class="form-control" id="inputXCalle" placeholder="500" value="500">
            </div>
            <div class="col-md-4 mb-3">
              <label for="inputYCalle" class="form-label">Posici√≥n Y:</label>
              <input type="number" class="form-control" id="inputYCalle" placeholder="500" value="500">
            </div>
            <div class="col-md-4 mb-3">
              <label for="inputAnguloCalle" class="form-label">√Ångulo (¬∞):</label>
              <input type="number" class="form-control" id="inputAnguloCalle" placeholder="0" min="0" max="360" value="0">
            </div>
          </div>
          <div class="mb-3">
            <label for="inputProbGenCalle" class="form-label">Probabilidad de Generaci√≥n (0-1):</label>
            <input type="number" class="form-control" id="inputProbGenCalle" placeholder="0.5" min="0" max="1" step="0.01" value="0.5">
          </div>
          <div class="mb-3">
            <label for="inputProbSaltoCalle" class="form-label">Probabilidad de Cambio de Carril (0-1):</label>
            <input type="number" class="form-control" id="inputProbSaltoCalle" placeholder="0.02" min="0" max="1" step="0.01" value="0.02">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-bs-toggle="tooltip" data-bs-title="Cerrar sin crear la calle">Cancelar</button>
          <button type="button" class="btn btn-primary" id="btnConfirmarNuevaCalle" data-bs-toggle="tooltip" data-bs-title="Crear la calle con los par√°metros ingresados">‚úì Crear Calle</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Nuevo Edificio -->
  <div class="modal fade" id="modalNuevoEdificio" tabindex="-1" aria-labelledby="modalNuevoEdificioLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header bg-success text-white">
          <h5 class="modal-title" id="modalNuevoEdificioLabel">üè¢ Agregar Nuevo Edificio</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="inputNombreEdificio" class="form-label">Nombre:</label>
            <input type="text" class="form-control" id="inputNombreEdificio" placeholder="Ej: Edificio Central">
          </div>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="inputXEdificio" class="form-label">Posici√≥n X:</label>
              <input type="number" class="form-control" id="inputXEdificio" placeholder="500" value="500">
            </div>
            <div class="col-md-6 mb-3">
              <label for="inputYEdificio" class="form-label">Posici√≥n Y:</label>
              <input type="number" class="form-control" id="inputYEdificio" placeholder="500" value="500">
            </div>
          </div>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="inputWidthEdificio" class="form-label">Ancho:</label>
              <input type="number" class="form-control" id="inputWidthEdificio" placeholder="100" min="1" value="100">
            </div>
            <div class="col-md-6 mb-3">
              <label for="inputHeightEdificio" class="form-label">Alto:</label>
              <input type="number" class="form-control" id="inputHeightEdificio" placeholder="100" min="1" value="100">
            </div>
          </div>
          <div class="mb-3">
            <label for="inputAnguloEdificio" class="form-label">√Ångulo (¬∞):</label>
            <input type="number" class="form-control" id="inputAnguloEdificio" placeholder="0" min="0" max="360" value="0">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-bs-toggle="tooltip" data-bs-title="Cerrar sin crear el edificio">Cancelar</button>
          <button type="button" class="btn btn-success" id="btnConfirmarNuevoEdificio" data-bs-toggle="tooltip" data-bs-title="Crear el edificio con los par√°metros ingresados">‚úì Crear Edificio</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Nueva Conexi√≥n -->
  <div class="modal fade" id="modalNuevaConexion" tabindex="-1" aria-labelledby="modalNuevaConexionLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header bg-secondary text-white">
          <h5 class="modal-title" id="modalNuevaConexionLabel">üîó Agregar Nueva Conexi√≥n</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="selectCalleOrigen" class="form-label">Calle Origen:</label>
            <select class="form-select" id="selectCalleOrigen">
              <option value="">Selecciona calle origen...</option>
            </select>
          </div>
          <div class="mb-3">
            <label for="selectCalleDestino" class="form-label">Calle Destino:</label>
            <select class="form-select" id="selectCalleDestino">
              <option value="">Selecciona calle destino...</option>
            </select>
          </div>
          <div class="mb-3">
            <label for="selectTipoConexion" class="form-label">Tipo de Conexi√≥n:</label>
            <select class="form-select" id="selectTipoConexion">
              <option value="LINEAL" selected>üü¢ Lineal (1 a 1)</option>
              <option value="INCORPORACION">üü† Incorporaci√≥n (varios a uno)</option>
              <option value="PROBABILISTICA">üü£ Probabil√≠stica</option>
            </select>
          </div>

          <!-- Campos espec√≠ficos para INCORPORACION -->
          <div id="camposIncorporacion" style="display: none;">
            <div class="mb-3">
              <label for="inputCarrilDestino" class="form-label">Carril Destino:</label>
              <input type="number" class="form-control" id="inputCarrilDestino" placeholder="0" min="0" value="0">
            </div>
            <div class="mb-3">
              <label for="inputPosInicial" class="form-label">Posici√≥n Inicial:</label>
              <input type="number" class="form-control" id="inputPosInicial" placeholder="0" min="0" value="0">
            </div>
          </div>

          <!-- Campos espec√≠ficos para PROBABILISTICA -->
          <div id="camposProbabilistica" style="display: none;">
            <div class="mb-3">
              <label for="inputCarrilOrigen" class="form-label">Carril Origen:</label>
              <input type="number" class="form-control" id="inputCarrilOrigen" placeholder="0" min="0" value="0">
            </div>
            <div class="mb-3">
              <label for="inputCarrilDestinoProb" class="form-label">Carril Destino:</label>
              <input type="number" class="form-control" id="inputCarrilDestinoProb" placeholder="0" min="0" value="0">
            </div>
            <div class="mb-3">
              <label for="inputProbabilidad" class="form-label">Probabilidad (0-1):</label>
              <input type="number" class="form-control" id="inputProbabilidad" placeholder="0.5" min="0" max="1" step="0.01" value="0.5">
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-bs-toggle="tooltip" data-bs-title="Cerrar sin crear la conexi√≥n">Cancelar</button>
          <button type="button" class="btn btn-primary" id="btnConfirmarNuevaConexion" data-bs-toggle="tooltip" data-bs-title="Crear la conexi√≥n entre las calles con los par√°metros ingresados">‚úì Crear Conexi√≥n</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Editar Conexi√≥n -->
  <div class="modal fade" id="modalEditarConexion" tabindex="-1" aria-labelledby="modalEditarConexionLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header bg-warning text-dark">
          <h5 class="modal-title" id="modalEditarConexionLabel">‚úèÔ∏è Editar Conexi√≥n</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="alert alert-info small mb-3">
            <strong>Conexi√≥n:</strong> <span id="editConexionInfo"></span>
          </div>

          <div class="mb-3">
            <label for="editSelectTipoConexion" class="form-label">Tipo de Conexi√≥n:</label>
            <select class="form-select" id="editSelectTipoConexion">
              <option value="LINEAL">üü¢ Lineal (1 a 1)</option>
              <option value="INCORPORACION">üü† Incorporaci√≥n (varios a uno)</option>
              <option value="PROBABILISTICA">üü£ Probabil√≠stica</option>
            </select>
          </div>

          <!-- Campos espec√≠ficos para INCORPORACION -->
          <div id="editCamposIncorporacion" style="display: none;">
            <div class="mb-3">
              <label for="editInputCarrilDestino" class="form-label">Carril Destino:</label>
              <input type="number" class="form-control" id="editInputCarrilDestino" placeholder="0" min="0" value="0">
            </div>
            <div class="mb-3">
              <label for="editInputPosInicial" class="form-label">Posici√≥n Inicial:</label>
              <input type="number" class="form-control" id="editInputPosInicial" placeholder="0" min="0" value="0">
            </div>
          </div>

          <!-- Campos espec√≠ficos para PROBABILISTICA -->
          <div id="editCamposProbabilistica" style="display: none;">
            <div class="mb-3">
              <label for="editInputCarrilOrigen" class="form-label">Carril Origen:</label>
              <input type="number" class="form-control" id="editInputCarrilOrigen" placeholder="0" min="0" value="0">
            </div>
            <div class="mb-3">
              <label for="editInputCarrilDestinoProb" class="form-label">Carril Destino:</label>
              <input type="number" class="form-control" id="editInputCarrilDestinoProb" placeholder="0" min="0" value="0">
            </div>
            <div class="mb-3">
              <label for="editInputProbabilidad" class="form-label">Probabilidad (0-1):</label>
              <input type="number" class="form-control" id="editInputProbabilidad" placeholder="0.5" min="0" max="1" step="0.01" value="0.5">
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-bs-toggle="tooltip" data-bs-title="Cerrar sin guardar los cambios">Cancelar</button>
          <button type="button" class="btn btn-warning" id="btnConfirmarEditarConexion" data-bs-toggle="tooltip" data-bs-title="Guardar los cambios realizados en la conexi√≥n">‚úì Guardar Cambios</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Acerca de FLUVI -->
  <div class="modal fade" id="aboutModal" tabindex="-1" aria-labelledby="aboutModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-xl modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title" id="aboutModalLabel">‚ÑπÔ∏è Acerca de FLUVI</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="container-fluid">

            <!-- T√≠tulo del Proyecto -->
            <div class="text-center mb-4">
              <h4 class="text-primary fw-bold">FLUVI</h4>
              <p class="lead">Simulador de Sistema de Gesti√≥n del Flujo Vehicular en Vialidades Cercanas a √Åreas Acad√©micas de IPN - ESCOM</p>
            </div>

            <hr class="my-4">

            <!-- Introduction -->
            <section class="mb-5">
              <h5 class="text-primary mb-3">
                <span class="badge bg-primary me-2">1</span>
                Introduction
              </h5>
              <div class="card">
                <div class="card-body">
                  <p>
                    FLUVI es un simulador de tr√°fico vehicular basado en <strong>aut√≥matas celulares</strong> dise√±ado espec√≠ficamente para analizar y optimizar el flujo de veh√≠culos en vialidades cercanas a √°reas acad√©micas del Instituto Polit√©cnico Nacional, con enfoque en la Escuela Superior de C√≥mputo (ESCOM).
                  </p>
                  <p>
                    El sistema permite modelar escenarios complejos de tr√°fico urbano, incluyendo:
                  </p>
                  <ul>
                    <li>M√∫ltiples carriles y calles interconectadas</li>
                    <li>Generaci√≥n din√°mica de veh√≠culos</li>
                    <li>Cambios de carril con probabilidades configurables</li>
                    <li>Detecci√≥n y resoluci√≥n de intersecciones</li>
                    <li>Visualizaci√≥n en tiempo real de m√©tricas de tr√°fico</li>
                    <li>Calles con curvaturas personalizables</li>
                  </ul>
                  <p>
                    Este proyecto surge de la necesidad de comprender y mejorar la circulaci√≥n vehicular en zonas acad√©micas, permitiendo a investigadores y planificadores urbanos simular diferentes escenarios antes de implementar cambios en la infraestructura real.
                  </p>
                </div>
              </div>
            </section>

            <!-- Algorithms -->
            <section class="mb-5">
              <h5 class="text-primary mb-3">
                <span class="badge bg-primary me-2">2</span>
                Algorithms
              </h5>
              <div class="card">
                <div class="card-body">
                  <h6 class="fw-bold mb-3">Regla 184 de Aut√≥matas Celulares</h6>
                  <p>
                    FLUVI implementa una versi√≥n modificada de la <strong>Regla 184</strong>, un aut√≥mata celular unidimensional que simula el flujo de tr√°fico de manera eficiente.
                  </p>

                  <div class="alert alert-info">
                    <h6 class="alert-heading">üìö ¬øQu√© es la Regla 184?</h6>
                    <p class="mb-0">
                      La Regla 184 es un aut√≥mata celular que modela el tr√°fico vehicular donde cada celda puede estar vac√≠a (0) o ocupada por un veh√≠culo (1). Los veh√≠culos se mueven hacia adelante si la celda siguiente est√° vac√≠a, creando un flujo natural de tr√°fico.
                    </p>
                  </div>

                  <h6 class="fw-bold mt-4 mb-3">Funcionamiento B√°sico de la Regla 184</h6>
                  <div class="table-responsive">
                    <table class="table table-bordered table-sm">
                      <thead class="table-primary">
                        <tr>
                          <th>Izquierda</th>
                          <th>Centro</th>
                          <th>Derecha</th>
                          <th>‚Üí</th>
                          <th>Nuevo Estado (Centro)</th>
                        </tr>
                      </thead>
                      <tbody>
                        <tr>
                          <td>1</td>
                          <td>1</td>
                          <td>1</td>
                          <td>‚Üí</td>
                          <td class="fw-bold">1</td>
                        </tr>
                        <tr>
                          <td>1</td>
                          <td>1</td>
                          <td>0</td>
                          <td>‚Üí</td>
                          <td class="fw-bold">0</td>
                        </tr>
                        <tr>
                          <td>1</td>
                          <td>0</td>
                          <td>1</td>
                          <td>‚Üí</td>
                          <td class="fw-bold">1</td>
                        </tr>
                        <tr>
                          <td>1</td>
                          <td>0</td>
                          <td>0</td>
                          <td>‚Üí</td>
                          <td class="fw-bold">0</td>
                        </tr>
                        <tr>
                          <td>0</td>
                          <td>1</td>
                          <td>1</td>
                          <td>‚Üí</td>
                          <td class="fw-bold">1</td>
                        </tr>
                        <tr>
                          <td>0</td>
                          <td>1</td>
                          <td>0</td>
                          <td>‚Üí</td>
                          <td class="fw-bold">1</td>
                        </tr>
                        <tr>
                          <td>0</td>
                          <td>0</td>
                          <td>1</td>
                          <td>‚Üí</td>
                          <td class="fw-bold">0</td>
                        </tr>
                        <tr>
                          <td>0</td>
                          <td>0</td>
                          <td>0</td>
                          <td>‚Üí</td>
                          <td class="fw-bold">0</td>
                        </tr>
                      </tbody>
                    </table>
                  </div>

                  <h6 class="fw-bold mt-4 mb-3">üîß Modificaciones Implementadas en FLUVI</h6>
                  <p>Hemos adaptado y extendido la Regla 184 cl√°sica para soportar escenarios de tr√°fico m√°s complejos y realistas:</p>

                  <div class="row g-3">
                    <div class="col-md-6">
                      <div class="card border-primary">
                        <div class="card-body">
                          <h6 class="card-title text-primary">1Ô∏è‚É£ Multi-carril</h6>
                          <p class="card-text small">
                            Expandimos la regla unidimensional a un sistema de <strong>m√∫ltiples carriles</strong>, permitiendo que los veh√≠culos cambien de carril bas√°ndose en probabilidades configurables.
                          </p>
                        </div>
                      </div>
                    </div>

                    <div class="col-md-6">
                      <div class="card border-success">
                        <div class="card-body">
                          <h6 class="card-title text-success">2Ô∏è‚É£ Celdas de Espera</h6>
                          <p class="card-text small">
                            Introducimos el concepto de <strong>celdas en espera</strong> para manejar bloqueos temporales (como intersecciones o conexiones congestionadas), previniendo colisiones.
                          </p>
                        </div>
                      </div>
                    </div>

                    <div class="col-md-6">
                      <div class="card border-warning">
                        <div class="card-body">
                          <h6 class="card-title text-warning">3Ô∏è‚É£ Conexiones entre Calles</h6>
                          <p class="card-text small">
                            Implementamos tres tipos de conexiones: <strong>lineales</strong> (1-a-1), <strong>incorporaci√≥n</strong> (N-a-1) y <strong>probabil√≠sticas</strong> (1-a-N con distribuci√≥n).
                          </p>
                        </div>
                      </div>
                    </div>

                    <div class="col-md-6">
                      <div class="card border-danger">
                        <div class="card-body">
                          <h6 class="card-title text-danger">4Ô∏è‚É£ Resoluci√≥n de Intersecciones</h6>
                          <p class="card-text small">
                            Agregamos un sistema de <strong>prioridad alternante</strong> para resolver conflictos en intersecciones, simulando sem√°foros o reglas de paso.
                          </p>
                        </div>
                      </div>
                    </div>

                    <div class="col-md-6">
                      <div class="card border-info">
                        <div class="card-body">
                          <h6 class="card-title text-info">5Ô∏è‚É£ Prevenci√≥n de Cruces en X</h6>
                          <p class="card-text small">
                            Implementamos l√≥gica para <strong>prevenir cambios de carril cruzados</strong> (patr√≥n X) donde dos veh√≠culos adyacentes intentan intercambiar carriles simult√°neamente.
                          </p>
                        </div>
                      </div>
                    </div>

                    <div class="col-md-6">
                      <div class="card border-secondary">
                        <div class="card-body">
                          <h6 class="card-title text-secondary">6Ô∏è‚É£ Calles Curvas</h6>
                          <p class="card-text small">
                            Extendimos el modelo a <strong>geometr√≠as no lineales</strong> mediante sistema de v√©rtices con interpolaci√≥n angular para calles con curvaturas.
                          </p>
                        </div>
                      </div>
                    </div>
                  </div>

                  <div class="alert alert-success mt-4">
                    <h6 class="alert-heading">‚úÖ Resultado</h6>
                    <p class="mb-0">
                      Estas modificaciones permiten simular escenarios de tr√°fico urbano complejos manteniendo la eficiencia computacional de los aut√≥matas celulares, con actualizaciones en tiempo real y soporte para miles de veh√≠culos simult√°neos.
                    </p>
                  </div>
                </div>
              </div>
            </section>

            <!-- File Formats -->
            <section class="mb-5">
              <h5 class="text-primary mb-3">
                <span class="badge bg-primary me-2">3</span>
                File Formats
              </h5>
              <div class="card">
                <div class="card-body">
                  <p>FLUVI utiliza formato <strong>JSON</strong> para guardar y cargar simulaciones completas.</p>

                  <h6 class="fw-bold mt-3 mb-2">Estructura del archivo JSON:</h6>
                  <pre class="bg-light p-3 rounded"><code>{
  "version": "1.0",
  "nombre": "Nombre de la Simulaci√≥n",
  "fecha": "2024-01-01T12:00:00.000Z",
  "calles": [
    {
      "nombre": "Calle Principal",
      "tamano": 100,
      "tipo": "CONEXION",
      "carriles": 3,
      "x": 500,
      "y": 300,
      "angulo": 0,
      "probabilidadGeneracion": 0.5,
      "probabilidadSaltoDeCarril": 0.02,
      "esCurva": false,
      "vertices": []
    }
  ],
  "conexiones": [
    {
      "tipo": "LINEAL",
      "origen": "Calle1",
      "destino": "Calle2",
      "carrilOrigen": 0,
      "carrilDestino": 0
    }
  ],
  "edificios": [
    {
      "label": "ESCOM",
      "x": 1000,
      "y": 500,
      "width": 200,
      "height": 150
    }
  ]
}</code></pre>

                  <div class="alert alert-info mt-3">
                    <strong>üí° Consejo:</strong> Puedes exportar tu simulaci√≥n actual usando el bot√≥n "Guardar Simulaci√≥n" en el Constructor de Mapas.
                  </div>
                </div>
              </div>
            </section>

            <!-- Known Problems -->
            <section class="mb-5">
              <h5 class="text-primary mb-3">
                <span class="badge bg-primary me-2">4</span>
                Known Problems
              </h5>
              <div class="card">
                <div class="card-body">
                  <p>Algunos problemas conocidos y limitaciones actuales del sistema:</p>
                  <ul>
                    <li><strong>Rendimiento en simulaciones muy grandes:</strong> Simulaciones con m√°s de 50 calles largas pueden experimentar ca√≠das de FPS.</li>
                    <li><strong>Colisiones en curvas muy cerradas:</strong> Curvaturas extremas (¬±40¬∞) pueden generar ocasionalmente solapamientos visuales.</li>
                    <li><strong>Compatibilidad con navegadores antiguos:</strong> Requiere soporte de ES6+ y Canvas API.</li>
                  </ul>

                  <div class="alert alert-warning">
                    <strong>‚ö†Ô∏è Nota:</strong> Estamos trabajando continuamente en mejoras y correcciones. Si encuentras alg√∫n problema, por favor rep√≥rtalo al equipo de desarrollo.
                  </div>
                </div>
              </div>
            </section>

            <!-- Credits -->
            <section class="mb-4">
              <h5 class="text-primary mb-3">
                <span class="badge bg-primary me-2">5</span>
                Credits
              </h5>
              <div class="card">
                <div class="card-body">
                  <h6 class="fw-bold mb-3">üë• Equipo de Desarrollo</h6>

                  <div class="row mb-4">
                    <div class="col-md-4 mb-3">
                      <div class="card border-primary">
                        <div class="card-body text-center">
                          <div class="mb-2">üë®‚Äçüíª</div>
                          <h6 class="card-title">Connor Urbano Mendoza</h6>
                          <p class="card-text small text-muted">Desarrollador</p>
                        </div>
                      </div>
                    </div>
                    <div class="col-md-4 mb-3">
                      <div class="card border-primary">
                        <div class="card-body text-center">
                          <div class="mb-2">üë®‚Äçüíª</div>
                          <h6 class="card-title">Luis Gael Molina Figueroa</h6>
                          <p class="card-text small text-muted">Desarrollador</p>
                        </div>
                      </div>
                    </div>
                    <div class="col-md-4 mb-3">
                      <div class="card border-primary">
                        <div class="card-body text-center">
                          <div class="mb-2">üë©‚Äçüíª</div>
                          <h6 class="card-title">Denisse Marques Morales</h6>
                          <p class="card-text small text-muted">Desarrolladora</p>
                        </div>
                      </div>
                    </div>
                  </div>

                  <h6 class="fw-bold mb-3">üéì Directores del Proyecto</h6>
                  <div class="row">
                    <div class="col-md-6 mb-3">
                      <div class="card border-success">
                        <div class="card-body text-center">
                          <div class="mb-2">üë®‚Äçüè´</div>
                          <h6 class="card-title">Ju√°rez Mart√≠nez Genaro</h6>
                          <p class="card-text small text-muted">Director</p>
                        </div>
                      </div>
                    </div>
                    <div class="col-md-6 mb-3">
                      <div class="card border-success">
                        <div class="card-body text-center">
                          <div class="mb-2">üë©‚Äçüè´</div>
                          <h6 class="card-title">Maldonado Castillo Idalia</h6>
                          <p class="card-text small text-muted">Directora</p>
                        </div>
                      </div>
                    </div>
                  </div>

                  <div class="alert alert-info mt-4 mb-0">
                    <h6 class="alert-heading">üèõÔ∏è Instituci√≥n</h6>
                    <p class="mb-1"><strong>Instituto Polit√©cnico Nacional (IPN)</strong></p>
                    <p class="mb-0">Escuela Superior de C√≥mputo (ESCOM)</p>
                  </div>
                </div>
              </div>
            </section>

          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Cerrar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <div class="main-content">
    <!-- Barra de Informaci√≥n estilo Golly -->
    <div class="info-bar">
      <div class="info-bar-content">
        <span class="info-item">
          <span class="info-label">Generation:</span>
          <span id="infoGeneration" class="info-value">0</span>
        </span>
        <span class="info-separator">|</span>
        <span class="info-item">
          <span class="info-label">Population:</span>
          <span id="infoPopulation" class="info-value">0</span>
        </span>
        <span class="info-separator">|</span>
        <span class="info-item">
          <span class="info-label">Rule:</span>
          <span id="infoRule" class="info-value">184</span>
        </span>
        <span class="info-separator">|</span>
        <span class="info-item">
          <span class="info-label">Time/Frame:</span>
          <span id="infoTimePerFrame" class="info-value">1.0s</span>
        </span>
        <span class="info-separator">|</span>
        <span class="info-item">
          <span class="info-label">Sim. Time:</span>
          <span id="infoSimulatedDateTime" class="info-value">--/--/---- --:--:--</span>
        </span>
      </div>
    </div>

    <div class="canvas-wrapper">
      <canvas id="simuladorCanvas"></canvas>
      <canvas id="minimapa"></canvas>

      <!-- Control Bar -->
      <div id="canvasControlBar">
        <div id="controlBar" class="d-flex align-items-center">
          <button id="btnConexiones" class="btn btn-info" data-bs-toggle="tooltip" data-bs-title="Mostrar/ocultar las conexiones entre calles en el canvas">üîó</button>
          <button id="btnPauseResume" class="btn btn-secondary me-2" data-bs-toggle="tooltip" data-bs-title="Pausar o reanudar la simulaci√≥n de tr√°fico">‚è∏</button>
          <button id="btnPaso" class="btn btn-success me-2" disabled data-bs-toggle="tooltip" data-bs-title="Avanzar un paso de la simulaci√≥n (solo disponible cuando est√° en pausa)">‚è≠</button>
          <button id="btnIntersecciones" class="btn btn-info me-2" data-bs-toggle="tooltip" data-bs-title="Mostrar/ocultar los puntos de intersecci√≥n entre calles">‚úñÔ∏è</button>
          <button id="btnEtiquetas" class="btn btn-info me-2" data-bs-toggle="tooltip" data-bs-title="Mostrar/ocultar las etiquetas con nombres de calles y edificios">üè∑Ô∏è</button>
          <button id="btnBorrar" class="btn btn-danger me-2" data-bs-toggle="tooltip" data-bs-title="Borrar todos los veh√≠culos de todas las calles">üóëÔ∏è</button>
          <button id="btnRandom" class="btn btn-warning me-3" data-bs-toggle="tooltip" data-bs-title="Llenar las calles con veh√≠culos aleatorios">üé≤</button>
          <label for="velocidadSlider" class="form-label me-2 mb-0">Velocidad:</label>
          <input type="range" class="form-range me-2" id="velocidadSlider" min="1" max="100" step="1" style="width: 100px;">
          <span id="velocidadValor" class="badge bg-primary">10</span>
          <label for="probabilidadSlider" class="form-label ms-3 me-2 mb-0">Generaci√≥n:</label>
          <input type="range" class="form-range me-2" id="probabilidadSlider" min="0" max="100" step="1" style="width: 100px;">
          <span id="probabilidadValor" class="badge bg-primary">10</span>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ========== SISTEMA DE CARGA ==========
    (function() {
      const loadingScreen = document.getElementById('loadingScreen');
      const progressFill = document.getElementById('progressFill');
      const loadingStatus = document.getElementById('loadingStatus');

      let progress = 0;
      const statusMessages = [
        'Inicializando recursos...',
        'Cargando librer√≠as...',
        'Preparando canvas...',
        'Generando calles...',
        'Calculando intersecciones...',
        'Creando conexiones...',
        'Iniciando simulaci√≥n...',
        'Listo!'
      ];

      let messageIndex = 0;

      // Simular progreso de carga
      const progressInterval = setInterval(() => {
        progress += Math.random() * 15;

        if (progress >= 100) {
          progress = 100;
          clearInterval(progressInterval);
        }

        progressFill.style.width = progress + '%';

        // Cambiar mensaje seg√∫n progreso
        const newMessageIndex = Math.floor((progress / 100) * statusMessages.length);
        if (newMessageIndex !== messageIndex && newMessageIndex < statusMessages.length) {
          messageIndex = newMessageIndex;
          loadingStatus.textContent = statusMessages[messageIndex];
        }
      }, 200);

      // Funci√≥n para actualizar el estado de carga
      window.updateLoadingStatus = function(message) {
        loadingStatus.textContent = message;
      };

      // Funci√≥n para ocultar la pantalla de carga
      window.hideLoadingScreen = function() {
        clearInterval(progressInterval);
        progressFill.style.width = '100%';
        loadingStatus.textContent = 'Listo!';

        setTimeout(() => {
          loadingScreen.classList.add('fade-out');
          setTimeout(() => {
            loadingScreen.style.display = 'none';
          }, 500);
        }, 500);
      };

      // Ocultar pantalla cuando todo est√© cargado
      window.addEventListener('load', async () => {
        console.log('üöÄ Evento window.load disparado');
        // Esperar un m√≠nimo de 2 segundos para que se vean las instrucciones
        setTimeout(async () => {
          console.log('‚è∞ Timeout de 2 segundos completado');
          // Verificar que los scripts principales est√©n cargados
          console.log('üîç Verificando iniciarSimulacion:', typeof iniciarSimulacion);
          console.log('üîç Verificando inicializarMotorGrafico:', typeof inicializarMotorGrafico);
          console.log('üîç window.USE_PIXI:', window.USE_PIXI);
          if (typeof iniciarSimulacion !== 'undefined') {
            // Inicializar motor gr√°fico PixiJS solo si est√° habilitado
            if (window.USE_PIXI && typeof inicializarMotorGrafico !== 'undefined') {
              try {
                updateLoadingStatus('Inicializando motor gr√°fico...');
                await inicializarMotorGrafico();
                updateLoadingStatus('¬°Listo!');
              } catch (error) {
                console.error('‚ùå Error inicializando motor gr√°fico:', error);
                alert('Error inicializando PixiJS. Revisa la consola para m√°s detalles.');
              }
            } else if (!window.USE_PIXI) {
              console.log('‚ÑπÔ∏è PixiJS deshabilitado, usando Canvas 2D nativo');
            }
            hideLoadingScreen();
          } else {
            // Esperar un poco m√°s si no est√° listo
            setTimeout(hideLoadingScreen, 1000);
          }
        }, 2000);
      });

      // Backup: ocultar despu√©s de 15 segundos m√°ximo
      setTimeout(() => {
        if (loadingScreen && !loadingScreen.classList.contains('fade-out')) {
          console.warn('Forzando cierre de pantalla de carga');
          hideLoadingScreen();
        }
      }, 15000);
    })();

  </script>

  <!-- Motor Gr√°fico PixiJS -->
  <script src="https://cdn.jsdelivr.net/npm/pixi.js@7/dist/pixi.min.js"></script>

  <!-- Motor Gr√°fico - Utilidades -->
  <script src="src/js/renderer/utils/CoordinateConverter.js"></script>
  <script src="src/js/renderer/utils/AssetLoader.js"></script>

  <!-- Motor Gr√°fico - Core -->
  <script src="src/js/renderer/CameraController.js"></script>
  <script src="src/js/renderer/SceneManager.js"></script>
  <script src="src/js/renderer/PixiApp.js"></script>

  <!-- Motor Gr√°fico - Renderers -->
  <script src="src/js/renderer/renderers/CalleRenderer.js"></script>
  <script src="src/js/renderer/renderers/CarroRenderer.js"></script>
  <script src="src/js/renderer/renderers/EdificioRenderer.js"></script>
  <script src="src/js/renderer/renderers/ConexionRenderer.js"></script>
  <script src="src/js/renderer/renderers/UIRenderer.js"></script>
  <script src="src/js/renderer/renderers/EditorHandles.js"></script>
  <script src="src/js/renderer/renderers/MinimapRenderer.js"></script>

  <!-- Scripts modulares del simulador -->
  <script src="src/js/core/curvas.js"></script>
  <script src="src/js/ui/etiquetas.js"></script>
  <script src="src/js/core/trafico.js"></script>
  <script src="src/js/core/graficas.js"></script>
  <script src="src/js/ui/editor.js"></script>
  <script src="src/js/ui/constructor.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Inicializar tooltips de Bootstrap 5 -->
  <script>
    // Inicializar todos los tooltips cuando el DOM est√© listo
    document.addEventListener('DOMContentLoaded', function() {
      // Obtener todos los elementos con data-bs-toggle="tooltip"
      const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]');

      // Inicializar cada tooltip
      const tooltipList = [...tooltipTriggerList].map(tooltipTriggerEl => {
        return new bootstrap.Tooltip(tooltipTriggerEl, {
          trigger: 'hover focus', // Mostrar al pasar el mouse o enfocar
          delay: { show: 300, hide: 100 } // Peque√±o delay para evitar tooltips molestos
        });
      });

      console.log(`‚úì ${tooltipList.length} tooltips inicializados correctamente`);
    });
  </script>

  <!-- Fix para warning de aria-hidden en modales -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Obtener todos los modales
      const modals = document.querySelectorAll('.modal');

      modals.forEach(modal => {
        // Antes de que el modal se oculte, remover el foco de cualquier elemento dentro del modal
        modal.addEventListener('hide.bs.modal', function(event) {
          // Buscar el elemento que tiene el foco dentro del modal
          const focusedElement = modal.querySelector(':focus');

          if (focusedElement) {
            // Remover el foco del elemento
            focusedElement.blur();
          }
        });

        // Opcional: Cuando el modal se muestre, enfocar el bot√≥n de cerrar o el primer input
        modal.addEventListener('shown.bs.modal', function(event) {
          // Buscar el primer input o textarea que no est√© deshabilitado
          const firstInput = modal.querySelector('input:not([disabled]):not([readonly]), textarea:not([disabled]):not([readonly])');

          if (firstInput) {
            // Peque√±o delay para asegurar que el modal est√© completamente renderizado
            setTimeout(() => firstInput.focus(), 100);
          }
        });
      });

      console.log(`‚úì ${modals.length} modales configurados para evitar warning de aria-hidden`);
    });
  </script>

  <!-- Sistema de Control de Logs de Consola -->
  <script>
    // Guardar referencias originales de los m√©todos de console
    const originalConsole = {
      log: console.log,
      warn: console.warn,
      error: console.error,
      info: console.info,
      debug: console.debug,
      trace: console.trace,
      table: console.table,
      group: console.group,
      groupEnd: console.groupEnd,
      groupCollapsed: console.groupCollapsed
    };

    // Funci√≥n para deshabilitar logs de consola
    function disableConsoleLogs() {
      console.log = function() {};
      console.warn = function() {};
      console.error = function() {};
      console.info = function() {};
      console.debug = function() {};
      console.trace = function() {};
      console.table = function() {};
      console.group = function() {};
      console.groupEnd = function() {};
      console.groupCollapsed = function() {};
    }

    // Funci√≥n para habilitar logs de consola
    function enableConsoleLogs() {
      console.log = originalConsole.log;
      console.warn = originalConsole.warn;
      console.error = originalConsole.error;
      console.info = originalConsole.info;
      console.debug = originalConsole.debug;
      console.trace = originalConsole.trace;
      console.table = originalConsole.table;
      console.group = originalConsole.group;
      console.groupEnd = originalConsole.groupEnd;
      console.groupCollapsed = originalConsole.groupCollapsed;
    }

    // Inicializar: Por defecto los logs est√°n DESHABILITADOS
    const consoleLogsEnabled = localStorage.getItem('consoleLogsEnabled') === 'true';
    if (!consoleLogsEnabled) {
      disableConsoleLogs();
    }

    // Configurar el switch cuando el DOM est√© listo
    document.addEventListener('DOMContentLoaded', function() {
      const switchConsoleLogs = document.getElementById('switchConsoleLogs');
      const labelConsoleLogs = document.getElementById('labelConsoleLogs');

      // Establecer estado inicial del switch
      switchConsoleLogs.checked = consoleLogsEnabled;

      // Actualizar label seg√∫n el estado
      function updateLabel(enabled) {
        if (enabled) {
          labelConsoleLogs.innerHTML = 'üìù Mostrar Logs en Consola';
          labelConsoleLogs.style.color = '#28a745';
        } else {
          labelConsoleLogs.innerHTML = 'üö´ Ocultar Logs en Consola';
          labelConsoleLogs.style.color = '#6c757d';
        }
      }

      updateLabel(consoleLogsEnabled);

      // Event listener para el switch
      switchConsoleLogs.addEventListener('change', function() {
        const enabled = this.checked;
        localStorage.setItem('consoleLogsEnabled', enabled);

        if (enabled) {
          enableConsoleLogs();
          console.log('‚úÖ Logs de consola HABILITADOS');
        } else {
          console.log('üö´ Logs de consola DESHABILITADOS');
          disableConsoleLogs();
        }

        updateLabel(enabled);
      });
    });
  </script>

  <!-- Sistema de toggle para sidebar responsive -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const sidebar = document.getElementById('sidebar');
      const mainContent = document.querySelector('.main-content');
      const toggleBtnInner = document.getElementById('sidebarToggle');
      const toggleBtnFloat = document.getElementById('sidebarToggleFloat');

      // Estado del sidebar (inicialmente visible)
      let sidebarVisible = true;

      // Cargar estado del sidebar desde localStorage
      const savedState = localStorage.getItem('sidebarVisible');
      if (savedState !== null) {
        sidebarVisible = savedState === 'true';
        applySidebarState(false); // Aplicar sin animaci√≥n inicial
      }

      // Funci√≥n para aplicar el estado del sidebar
      function applySidebarState(animate = true) {
        if (sidebarVisible) {
          // Mostrar sidebar
          sidebar.classList.remove('hidden');
          mainContent.classList.remove('expanded');
          document.body.classList.remove('sidebar-collapsed');

          // Mostrar bot√≥n flotante = oculto
          toggleBtnFloat.style.display = 'none';
        } else {
          // Ocultar sidebar
          sidebar.classList.add('hidden');
          mainContent.classList.add('expanded');
          document.body.classList.add('sidebar-collapsed');

          // Mostrar bot√≥n flotante despu√©s de la animaci√≥n
          setTimeout(() => {
            toggleBtnFloat.style.display = 'flex';
          }, animate ? 400 : 0);
        }

        // Guardar estado en localStorage
        localStorage.setItem('sidebarVisible', sidebarVisible);

        // Redimensionar canvas despu√©s de la transici√≥n
        if (animate) {
          setTimeout(() => {
            resizeCanvasToFit();
          }, 400);
        } else {
          // Aplicar inmediatamente si no hay animaci√≥n
          resizeCanvasToFit();
        }
      }

      // Funci√≥n para redimensionar el canvas al tama√±o correcto
      function resizeCanvasToFit() {
        const header = document.querySelector('header');
        const sidebarWidth = sidebarVisible ? (window.innerWidth > 768 ? 380 : 0) : 0;
        const headerHeight = header ? header.offsetHeight : 0;

        const newWidth = window.innerWidth - sidebarWidth;
        const newHeight = window.innerHeight - headerHeight;

        // Si usamos PixiJS, redimensionar su renderer
        if (window.USE_PIXI && window.pixiApp && window.pixiApp.app) {
          window.pixiApp.app.renderer.resize(newWidth, newHeight);
          console.log(`üñºÔ∏è Canvas PixiJS redimensionado: ${newWidth}x${newHeight}`);
        } else {
          // Canvas 2D tradicional
          const canvas = document.getElementById('simuladorCanvas');
          if (canvas) {
            canvas.width = newWidth;
            canvas.height = newHeight;
          }
        }

        // Renderizar despu√©s del redimensionamiento
        if (window.renderizarCanvas) {
          window.renderizarCanvas();
        }
      }

      // Funci√≥n para toggle del sidebar
      function toggleSidebar() {
        sidebarVisible = !sidebarVisible;
        applySidebarState(true);
        console.log(`üìä Panel de control ${sidebarVisible ? 'mostrado' : 'ocultado'}`);
      }

      // Event listeners para ambos botones
      toggleBtnInner.addEventListener('click', toggleSidebar);
      toggleBtnFloat.addEventListener('click', toggleSidebar);

      // Atajo de teclado: Ctrl + B para toggle
      document.addEventListener('keydown', function(e) {
        if (e.ctrlKey && e.key === 'b') {
          e.preventDefault();
          toggleSidebar();
        }
      });

      console.log('‚úì Sistema de toggle del sidebar inicializado (Ctrl+B para toggle)');
    });
  </script>

  <!-- Sistema de Informaci√≥n en Tiempo Real (estilo Golly) -->
  <script>
    (function() {
      // Variables globales para el sistema de informaci√≥n
      let generation = 0;
      let lastFrameTime = Date.now();
      let frameCount = 0;
      let totalFrameTime = 0;
      let avgTimePerFrame = 1.0; // segundos por frame

      // Tiempo simulado
      let simulatedStartDate = new Date();
      let simulatedCurrentDate = new Date(simulatedStartDate);

      // Referencias a elementos del DOM
      const infoGeneration = document.getElementById('infoGeneration');
      const infoPopulation = document.getElementById('infoPopulation');
      const infoRule = document.getElementById('infoRule');
      const infoTimePerFrame = document.getElementById('infoTimePerFrame');
      const infoSimulatedDateTime = document.getElementById('infoSimulatedDateTime');

      // Funci√≥n para calcular la poblaci√≥n (veh√≠culos en todas las calles)
      // Cuenta todos los veh√≠culos de tipo 1, 2, 3, 4, 5, 6
      function calculatePopulation() {
        if (!window.calles || window.calles.length === 0) return 0;

        let total = 0;
        window.calles.forEach(calle => {
          if (calle.arreglo && Array.isArray(calle.arreglo)) {
            calle.arreglo.forEach(carril => {
              if (Array.isArray(carril)) {
                // Contar todas las celdas con valor >= 1 y <= 6 (todos los tipos de veh√≠culos)
                total += carril.filter(cell => cell >= 1 && cell <= 6).length;
              }
            });
          }
        });
        return total;
      }

      // Funci√≥n para formatear fecha y hora combinadas
      function formatDateTime(date) {
        const day = String(date.getDate()).padStart(2, '0');
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const year = date.getFullYear();
        const hours = String(date.getHours()).padStart(2, '0');
        const minutes = String(date.getMinutes()).padStart(2, '0');
        const seconds = String(date.getSeconds()).padStart(2, '0');
        return `${day}/${month}/${year} ${hours}:${minutes}:${seconds}`;
      }

      // Constantes f√≠sicas para el c√°lculo de tiempo simulado
      const CELL_LENGTH_METERS = 5; // Cada celda representa 5 metros
      // Calibrado emp√≠ricamente: slider en 58 ‚âà 0.9 segundos de tiempo simulado por frame
      // Cada frame representa el avance de 1 celda (5 metros) en el mundo simulado
      const REAL_TIME_PER_CELL_SECONDS = 0.9; // Tiempo real que tarda un veh√≠culo en avanzar 1 celda (5m)

      // Funci√≥n para actualizar la informaci√≥n
      function updateInfo() {
        // Actualizar generaci√≥n
        generation++;
        infoGeneration.textContent = generation.toLocaleString();

        // Calcular tiempo real por frame (cu√°nto tarda el navegador)
        const currentTime = Date.now();
        const frameTime = (currentTime - lastFrameTime) / 1000; // en segundos
        lastFrameTime = currentTime;

        // Promedio m√≥vil de los √∫ltimos 10 frames
        frameCount++;
        totalFrameTime += frameTime;
        if (frameCount > 10) {
          totalFrameTime -= avgTimePerFrame;
          frameCount = 10;
        }
        avgTimePerFrame = totalFrameTime / frameCount;

        // Actualizar tiempo real por frame (tiempo de procesamiento)
        infoTimePerFrame.textContent = `${avgTimePerFrame.toFixed(3)}s`;

        // Actualizar poblaci√≥n
        const population = calculatePopulation();
        infoPopulation.textContent = population.toLocaleString();

        // Calcular tiempo simulado f√≠sicamente correcto
        // Cada generaci√≥n (frame) representa el avance de 1 celda (5 metros) en el mundo simulado
        // Independientemente de qu√© tan r√°pido ejecute el navegador los frames (controlado por el slider),
        // el tiempo que transcurre en el mundo simulado por cada celda avanzada es constante: 0.6 segundos

        // Tiempo simulado que avanza en cada frame (constante, no depende del slider de velocidad)
        const simulatedTimeIncrement = REAL_TIME_PER_CELL_SECONDS * 1000; // en milisegundos

        // Actualizar tiempo simulado
        simulatedCurrentDate = new Date(simulatedCurrentDate.getTime() + simulatedTimeIncrement);
        infoSimulatedDateTime.textContent = formatDateTime(simulatedCurrentDate);
      }

      // Funci√≥n para resetear la informaci√≥n
      function resetInfo() {
        generation = 0;
        frameCount = 0;
        totalFrameTime = 0;
        avgTimePerFrame = 1.0;
        lastFrameTime = Date.now();
        simulatedStartDate = new Date();
        simulatedCurrentDate = new Date(simulatedStartDate);

        infoGeneration.textContent = '0';
        infoPopulation.textContent = '0';
        infoTimePerFrame.textContent = '1.0s';
        infoSimulatedDateTime.textContent = formatDateTime(simulatedCurrentDate);
      }

      // Exponer funciones globalmente
      window.updateSimulationInfo = updateInfo;
      window.resetSimulationInfo = resetInfo;

      // Inicializar con fecha y hora actuales
      document.addEventListener('DOMContentLoaded', function() {
        infoSimulatedDateTime.textContent = formatDateTime(simulatedCurrentDate);
        console.log('‚úì Sistema de informaci√≥n en tiempo real inicializado');
      });
    })();
  </script>
</body>
</html>