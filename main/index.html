<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FLUVI</title>

  <!-- Favicon -->
  <link rel="icon" type="image/png" sizes="32x32" href="src/assets/logos/favicon.png">
  <link rel="shortcut icon" href="src/assets/logos/favicon.png">

  <!-- Bootstrap CSS local -->
  <link href="./src/bootstrap-5.0.2-dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Chart.js local -->
  <script src="./src/libs/chart.js/chart.umd.min.js"></script>
  <link rel="stylesheet" href="src/css/estilos.css">
  <link rel="stylesheet" href="src/css/minimapa.css">

  <!-- Script para aplicar modo oscuro ANTES de renderizar -->
  <script src="src/js/ui/darkMode.js"></script>
</head>

<body>


  <!-- ========== PANTALLA DE CARGA ========== -->
  <div id="loadingScreen">
    <div class="loading-content">
      <div class="loading-header">
        <img src="src/assets/logos/logo_horizontal.png" alt="FLUVI" class="loading-logo">
        <p>Cargando simulaciÃ³n...</p>
      </div>

      <div class="loading-spinner">
        <div class="spinner"></div>
      </div>

      <div class="instructions">
        <div class="instruction-card">
          <h3>ğŸ–±ï¸ Navega</h3>
          <p>Zoom con la rueda, arrastra para moverte por el mapa</p>
        </div>

        <div class="instruction-card">
          <h3>âš™ï¸ SelecciÃ³n</h3>
          <p>Ctrl+Clic sobre calles o edificios para configurarlos rÃ¡pidamente</p>
        </div>

        <div class="instruction-card">
          <h3>â¸ï¸ Controla</h3>
          <p>Pausa, ajusta la velocidad y observa las mÃ©tricas en tiempo real</p>
        </div>

        <div class="instruction-card">
          <h3>âœï¸ Edita</h3>
          <p>Activa el modo ediciÃ³n para mover y rotar calles o edificios</p>
        </div>

        <div class="instruction-card">
          <h3>ğŸŒŠ Personaliza</h3>
          <p>Crea curvas en calles, activa intersecciones y visualiza conexiones</p>
        </div>

        <div class="instruction-card">
          <h3>ğŸ—ï¸ Construye</h3>
          <p>DiseÃ±a tus propios mapas y guÃ¡rdalos para usarlos despuÃ©s</p>
        </div>
      </div>

      <div class="loading-progress">
        <div class="progress-bar-custom">
          <div class="progress-fill" id="progressFill"></div>
        </div>
        <div class="loading-status" id="loadingStatus">Inicializando recursos...</div>
      </div>
    </div>
  </div>

  <!-- BotÃ³n flotante para mostrar sidebar (visible solo cuando sidebar estÃ¡ oculto) -->
  <button class="sidebar-toggle-float" id="sidebarToggleFloat" data-bs-toggle="tooltip" data-bs-placement="right" data-bs-title="Mostrar panel de control" style="display: none;">
    <span>â˜°</span>
  </button>

  <!-- Handles de ediciÃ³n (se posicionan dinÃ¡micamente) -->
  <div id="moveHandle" class="edit-handle move-handle"></div>
  <div id="rotateHandle" class="edit-handle rotate-handle"></div>

  <!-- Sidebar Panel -->
  <div class="sidebar" id="sidebar">
    <!-- Toggle button dentro del panel (esquina superior derecha) -->
    <button class="sidebar-toggle-inner" id="sidebarToggle" data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-title="Ocultar panel de control">
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
        <line x1="3" y1="12" x2="15" y2="12"></line>
        <polyline points="10 5 3 12 10 19"></polyline>
        <line x1="21" y1="4" x2="21" y2="20"></line>
      </svg>
    </button>

    <h4>Panel de Control</h4>

    <!-- Indicador de modo ediciÃ³n -->
    <div id="editModeBadge" class="edit-mode-badge">
      ğŸ”§ MODO EDICIÃ“N ACTIVO
    </div>

    <!-- Contenedor scrolleable para accordions -->
    <div class="sidebar-scrollable-content">
      <!-- ========= ACCORDIONS ========== -->
      <div class="accordion" id="controlPanelAccordion">

      <!-- Accordion 1: Instrucciones -->
      <div class="accordion-item">
        <h2 class="accordion-header" id="headingInstrucciones">
          <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseInstrucciones" aria-expanded="true" aria-controls="collapseInstrucciones">
            ğŸ“– Instrucciones
          </button>
        </h2>
        <div id="collapseInstrucciones" class="accordion-collapse collapse show" aria-labelledby="headingInstrucciones" data-bs-parent="#controlPanelAccordion">
          <div class="accordion-body">
            <p class="text-muted small mb-3">Aprende a usar el simulador de trÃ¡fico</p>
            <button class="btn btn-info w-100" data-bs-toggle="modal" data-bs-target="#instructionsModal" data-bs-title="Abrir la guÃ­a completa del simulador con instrucciones detalladas">
              ğŸ“š Ver GuÃ­a Completa
            </button>
          </div>
        </div>
      </div>

      <!-- Accordion 2: ConfiguraciÃ³n de Calles -->
      <div class="accordion-item">
        <h2 class="accordion-header" id="headingConfig">
          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseConfig" aria-expanded="false" aria-controls="collapseConfig">
            âš™ï¸ ConfiguraciÃ³n de Calles
          </button>
        </h2>
        <div id="collapseConfig" class="accordion-collapse collapse" aria-labelledby="headingConfig" data-bs-parent="#controlPanelAccordion">
          <div class="accordion-body">

            <!-- Selector de Calle -->
            <label for="selectCalle" class="form-label">Seleccionar Calle:</label>
            <select id="selectCalle" class="form-select mb-3">
              <option value="">Seleccione una calle...</option>
            </select>

            <!-- Campos de probabilidad -->
            <div id="calleConfigFields">
              <!-- Probabilidad de GeneraciÃ³n (solo para calles de tipo GENERADOR) -->
              <div class="mb-3" id="campoGeneracionConfig">
                <label for="inputProbabilidadGeneracion" class="form-label">
                  Probabilidad de GeneraciÃ³n (%)
                  <span class="info-icon" data-bs-toggle="tooltip" data-bs-placement="right" data-bs-title="Controla la frecuencia con la que se generan nuevos vehÃ­culos en esta calle. 0% = sin vehÃ­culos, 100% = generaciÃ³n mÃ¡xima continua. Solo disponible para calles de tipo GENERADOR.">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-info-circle" viewBox="0 0 16 16">
                      <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14m0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16"/>
                      <path d="m8.93 6.588-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.194.897.105 1.319.808 1.319.545 0 1.178-.252 1.465-.598l.088-.416c-.2.176-.492.246-.686.246-.275 0-.375-.193-.304-.533z"/>
                      <circle cx="8" cy="4.5" r="1"/>
                    </svg>
                  </span>
                </label>
                <input type="number" id="inputProbabilidadGeneracion" class="form-control" min="0" max="100" step="1" placeholder="0-100">
                <div class="invalid-feedback">
                  Por favor ingresa un valor entre 0 y 100.
                </div>
                <small class="form-text text-muted">Ejemplo: "47" que sera equivalente a 47%.</small>
              </div>

              <div class="mb-3">
                <label for="inputProbabilidadSalto" class="form-label">
                  Probabilidad de Cambio de Carril (%)
                  <span class="info-icon" data-bs-toggle="tooltip" data-bs-placement="right" data-bs-title="Define la probabilidad de que un vehÃ­culo cambie de carril cuando es posible. Valores bajos (0-5%) simulan trÃ¡fico ordenado, valores altos (>20%) generan mÃ¡s cambios de carril.">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-info-circle" viewBox="0 0 16 16">
                      <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14m0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16"/>
                      <path d="m8.93 6.588-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.194.897.105 1.319.808 1.319.545 0 1.178-.252 1.465-.598l.088-.416c-.2.176-.492.246-.686.246-.275 0-.375-.193-.304-.533z"/>
                      <circle cx="8" cy="4.5" r="1"/>
                    </svg>
                  </span>
                </label>
                <input type="number" id="inputProbabilidadSalto" class="form-control" min="0" max="100" step="1" placeholder="0-100">
                <div class="invalid-feedback">
                  Por favor ingresa un valor entre 0 y 100.
                </div>
              </div>
            </div>

            <!-- BotÃ³n aplicar cambios -->
            <div id="calleApplyButton">
              <button id="btnActualizarCalle" class="btn btn-primary w-100" data-bs-toggle="tooltip" data-bs-title="Aplicar las probabilidades configuradas a la calle seleccionada">âœ“ Aplicar Cambios</button>
            </div>

            <div class="alert alert-info p-2 small mt-3 mb-0">
              <strong>ğŸ’¡ Atajo rÃ¡pido:</strong> Presiona <kbd>Ctrl</kbd> (o <kbd>âŒ˜ Cmd</kbd> en Mac) + clic sobre cualquier calle en el canvas para seleccionarla rÃ¡pidamente.
            </div>

          </div>
        </div>
      </div>

      <!-- Accordion 3: ConfiguraciÃ³n de Escenarios -->
      <div class="accordion-item">
        <h2 class="accordion-header" id="headingEscenarios">
          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseEscenarios" aria-expanded="false" aria-controls="collapseEscenarios">
            ğŸ¬ ConfiguraciÃ³n de Escenarios
          </button>
        </h2>
        <div id="collapseEscenarios" class="accordion-collapse collapse" aria-labelledby="headingEscenarios" data-bs-parent="#controlPanelAccordion">
          <div class="accordion-body">
            <p class="text-muted small mb-3">Configura situaciones especiales de trÃ¡fico en el simulador.</p>

            <!-- Bloqueo de Carril (ACTIVO) -->
            <div class="scenario-card scenario-active mb-3">
              <div class="scenario-header">
                <div class="scenario-icon">ğŸš§</div>
                <div class="scenario-info">
                  <h6 class="scenario-title mb-1">Bloqueo de Carril</h6>
                  <p class="scenario-desc mb-2">Bloquea celdas especÃ­ficas para simular obstÃ¡culos permanentes</p>
                </div>
              </div>
              <div class="scenario-controls">
                <div class="form-check form-switch mb-2">
                  <input class="form-check-input" type="checkbox" id="toggleBloqueoCarril" data-bs-toggle="tooltip" data-bs-title="Activar modo de pintado para bloquear celdas">
                  <label class="form-check-label" for="toggleBloqueoCarril">
                    <strong>Activar modo bloqueo</strong>
                  </label>
                </div>
                <div class="scenario-paint-mode" id="paintModeIndicator" style="display: none;">
                  <div class="paint-mode-badge">
                    âœï¸ Modo Pintado Activo
                  </div>
                  <p class="small text-muted mb-2">Haz clic o arrastra sobre las celdas de la calle para bloquearlas</p>
                </div>
              </div>
            </div>

            <!-- InundaciÃ³n (ACTIVO) -->
            <div class="scenario-card scenario-active mb-3">
              <div class="scenario-header">
                <div class="scenario-icon">ğŸŒŠ</div>
                <div class="scenario-info">
                  <h6 class="scenario-title mb-1">InundaciÃ³n</h6>
                  <p class="scenario-desc mb-2">Simula Ã¡reas inundadas que bloquean el paso</p>
                </div>
              </div>
              <div class="scenario-controls">
                <div class="form-check form-switch mb-2">
                  <input class="form-check-input" type="checkbox" id="toggleInundacion" data-bs-toggle="tooltip" data-bs-title="Activar modo de inundaciÃ³n">
                  <label class="form-check-label" for="toggleInundacion">
                    <strong>Activar modo inundaciÃ³n</strong>
                  </label>
                </div>
                <div class="scenario-paint-mode" id="paintModeIndicatorInundacion" style="display: none;">
                  <div class="paint-mode-badge">ğŸŒŠ Modo InundaciÃ³n Activo</div>
                  <p class="small text-muted mb-2">Haz clic sobre las celdas de la calle para inundarlas</p>
                </div>
              </div>
            </div>

            <!-- ObstÃ¡culo (ACTIVO) -->
            <div class="scenario-card scenario-active mb-3">
              <div class="scenario-header">
                <div class="scenario-icon">âš ï¸</div>
                <div class="scenario-info">
                  <h6 class="scenario-title mb-1">ObstÃ¡culo</h6>
                  <p class="scenario-desc mb-2">Coloca obstÃ¡culos especÃ­ficos en las calles</p>
                </div>
              </div>
              <div class="scenario-controls">
                <div class="form-check form-switch mb-2">
                  <input class="form-check-input" type="checkbox" id="toggleObstaculo" data-bs-toggle="tooltip" data-bs-title="Activar modo de obstÃ¡culos">
                  <label class="form-check-label" for="toggleObstaculo">
                    <strong>Activar modo obstÃ¡culo</strong>
                  </label>
                </div>
                <div class="scenario-paint-mode" id="paintModeIndicatorObstaculo" style="display: none;">
                  <div class="paint-mode-badge">âš ï¸ Modo ObstÃ¡culo Activo</div>
                  <p class="small text-muted mb-2">Haz clic sobre las celdas para colocar obstÃ¡culos</p>
                  <div id="selectorObstaculoContainer">
                    <label for="selectorEmojiObstaculo" class="form-label small">Tipo de obstÃ¡culo:</label>
                    <select id="selectorEmojiObstaculo" class="form-select form-select-sm mb-2">
                      <option value="bache">ğŸ•³ï¸ Bache</option>
                      <option value="trabajador">ğŸ‘·ğŸ½ ConstrucciÃ³n</option>
                      <option value="arbol">ğŸŒ³ Ãrbol caÃ­do</option>
                    </select>
                  </div>
                </div>
              </div>
            </div>

            <!-- Escenarios Base -->
            <hr class="mt-4 mb-3">
            <div class="mb-3">
              <h6 class="mb-3 d-flex align-items-center">
                ğŸ¯ Escenarios Base
                <span class="info-icon ms-2" data-bs-toggle="tooltip" data-bs-placement="right" data-bs-title="Escenarios predeterminados de ejemplo que demuestran diferentes situaciones de trÃ¡fico.">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-info-circle" viewBox="0 0 16 16">
                    <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14m0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16"/>
                    <path d="m8.93 6.588-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.194.897.105 1.319.808 1.319.545 0 1.178-.252 1.465-.598l.088-.416c-.2.176-.492.246-.686.246-.275 0-.375-.193-.304-.533z"/>
                    <circle cx="8" cy="4.5" r="1"/>
                  </svg>
                </span>
              </h6>

              <p class="text-muted small mb-3">Carga escenarios predeterminados de ejemplo para probar diferentes situaciones.</p>

              <!-- Lista de escenarios base -->
              <div class="list-group mb-3">
                <button type="button" class="list-group-item list-group-item-action" id="btnEscenarioInundacionMasiva" data-bs-toggle="tooltip" data-bs-title="Simula una inundaciÃ³n que deja solo un carril libre en cada calle">
                  <div class="d-flex w-100 justify-content-between align-items-center">
                    <div>
                      <h6 class="mb-1">ğŸŒŠ InundaciÃ³n Masiva</h6>
                      <p class="mb-0 small text-muted">Deja solo un carril libre en todas las calles</p>
                    </div>
                    <span class="badge bg-info">Cargar</span>
                  </div>
                </button>

                <button type="button" class="list-group-item list-group-item-action" id="btnEscenarioBachesAleatorios" data-bs-toggle="tooltip" data-bs-title="Coloca baches aleatoriamente con 5% de probabilidad en todas las calles">
                  <div class="d-flex w-100 justify-content-between align-items-center">
                    <div>
                      <h6 class="mb-1">ğŸ•³ï¸ Baches Aleatorios</h6>
                      <p class="mb-0 small text-muted">5% de probabilidad de baches en cada celda</p>
                    </div>
                    <span class="badge bg-warning text-dark">Cargar</span>
                  </div>
                </button>
              </div>
            </div>

            <!-- GestiÃ³n de Escenarios -->
            <hr class="mt-4 mb-3">
            <div class="mb-3">
              <h6 class="mb-3 d-flex align-items-center">
                ğŸ’¾ GestiÃ³n de Escenarios
                <span class="info-icon ms-2" data-bs-toggle="tooltip" data-bs-placement="right" data-bs-title="Guarda y carga configuraciones completas de obstÃ¡culos, inundaciones y bloqueos.">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-info-circle" viewBox="0 0 16 16">
                    <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14m0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16"/>
                    <path d="m8.93 6.588-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.194.897.105 1.319.808 1.319.545 0 1.178-.252 1.465-.598l.088-.416c-.2.176-.492.246-.686.246-.275 0-.375-.193-.304-.533z"/>
                    <circle cx="8" cy="4.5" r="1"/>
                  </svg>
                </span>
              </h6>

              <div class="row g-2 mb-3">
                <div class="col-6">
                  <button type="button" class="btn btn-success w-100" id="btnGuardarEscenario" data-bs-toggle="tooltip" data-bs-title="Guardar la configuraciÃ³n actual de obstÃ¡culos">
                    <i class="bi bi-save"></i> ğŸ’¾ Guardar
                  </button>
                </div>
                <div class="col-6">
                  <button type="button" class="btn btn-primary w-100" id="btnCargarEscenario" data-bs-toggle="tooltip" data-bs-title="Cargar un escenario guardado previamente">
                    <i class="bi bi-folder-open"></i> ğŸ“‚ Cargar
                  </button>
                </div>
              </div>

              <!-- Escenario actual cargado -->
              <div id="escenarioActualInfo" class="alert alert-success p-2 small mb-2" style="display: none;">
                <strong>âœ“ Escenario activo:</strong> <span id="escenarioActualNombre">Ninguno</span><br>
                <small class="text-muted">Guardado: <span id="escenarioActualFecha">-</span></small>
              </div>

              <p class="text-muted small mb-0">
                <strong>â„¹ï¸ Nota:</strong> Los escenarios incluyen todos los obstÃ¡culos, inundaciones y bloqueos configurados.
              </p>
            </div>

            <div class="alert alert-info p-2 small mt-3 mb-0">
              <strong>ğŸ’¡ Toma en cuenta que:</strong> Los vehÃ­culos no podrÃ¡n atravesar las celdas bloqueadas.
            </div>

            <!-- Control de Fecha y Hora del Simulador -->
            <div class="mt-3">
              <h6 class="mb-2">ğŸ“… Fecha y Hora del Simulador</h6>
              <p class="text-muted small mb-2">Configura el dÃ­a y hora inicial de la simulaciÃ³n para probar diferentes perfiles de trÃ¡fico.</p>

              <!-- Mostrar tiempo actual del simulador -->
              <div class="alert alert-secondary p-2 small mb-2">
                <strong>Tiempo de la simulaciÃ³n:</strong> <span id="tiempoActualDisplay">Lunes 07:00</span>
              </div>

              <!-- BotÃ³n para abrir modal de configuraciÃ³n -->
              <button type="button" class="btn btn-primary btn-sm w-100" data-bs-toggle="modal" data-bs-target="#modalTiempoSimulador">
                â° Cambiar Fecha y Hora
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Accordion 4: Constructor de Mapas -->
      <div class="accordion-item">
        <h2 class="accordion-header" id="headingConstructor">
          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseConstructor" aria-expanded="false" aria-controls="collapseConstructor">
            ğŸ—ï¸ Constructor de Mapas
          </button>
        </h2>
        <div id="collapseConstructor" class="accordion-collapse collapse" aria-labelledby="headingConstructor" data-bs-parent="#controlPanelAccordion">
          <div class="accordion-body">
            <h6 class="mb-3">ğŸ—ºï¸ GestiÃ³n de SimulaciÃ³n</h6>

            <!-- Botones de gestiÃ³n de archivo -->
            <div class="d-grid gap-2 mb-3">
              <button id="btnNuevaSimulacion" class="btn btn-success btn-sm" data-bs-toggle="tooltip" data-bs-title="Crear una nueva simulaciÃ³n desde cero, borrando todo el contenido actual">
                â• Nueva SimulaciÃ³n
              </button>
              <button id="btnGuardarSimulacion" class="btn btn-primary btn-sm" data-bs-toggle="tooltip" data-bs-title="Guardar la simulaciÃ³n actual como archivo JSON">
                ğŸ’¾ Guardar SimulaciÃ³n
              </button>
              <button id="btnCargarSimulacion" class="btn btn-info btn-sm" data-bs-toggle="tooltip" data-bs-title="Cargar una simulaciÃ³n desde un archivo JSON guardado previamente">
                ğŸ“‚ Cargar SimulaciÃ³n
              </button>
              <input type="file" id="inputCargarSimulacion" accept=".json" style="display: none;">
            </div>

            <hr class="my-3">

            <h6 class="mb-3">ğŸ› ï¸ Modo EdiciÃ³n Visual</h6>

            <!-- Selector de tipo de objeto -->
            <label for="selectTipoObjeto" class="form-label">Tipo de Objeto:</label>
            <select id="selectTipoObjeto" class="form-select mb-3">
              <option value="">Selecciona tipo...</option>
              <option value="calle">ğŸ›£ï¸ Calle</option>
              <option value="edificio">ğŸ¢ Edificio</option>
            </select>

            <!-- Selector de Calle -->
            <div id="calleEditorSelector" style="display: none;">
              <label for="selectCalleEditor" class="form-label">Calle:</label>
              <select id="selectCalleEditor" class="form-select mb-3">
                <option value="">Seleccione una calle...</option>
              </select>
            </div>

            <!-- Selector de Edificio -->
            <div id="edificioSelector" style="display: none;">
              <label for="selectEdificio" class="form-label">Edificio:</label>
              <select id="selectEdificio" class="form-select mb-3">
                <option value="">Seleccione un edificio...</option>
              </select>
            </div>

            <!-- BotÃ³n de modo ediciÃ³n -->
            <button id="btnModoEdicion" class="btn btn-warning w-100 mb-2" disabled data-bs-toggle="tooltip" data-bs-title="Activar modo ediciÃ³n para mover y rotar el objeto seleccionado visualmente">
              âœï¸ Modo EdiciÃ³n
            </button>

            <!-- Botones de guardar/cancelar (solo visibles en modo ediciÃ³n) -->
            <div id="editActionButtons" style="display: none;">
              <div class="d-flex gap-2 mb-2">
                <button id="btnGuardarEdicion" class="btn btn-success flex-fill" data-bs-toggle="tooltip" data-bs-title="Guardar los cambios realizados en el modo ediciÃ³n">
                  ğŸ’¾ Guardar
                </button>
                <button id="btnCancelarEdicion" class="btn btn-secondary flex-fill" data-bs-toggle="tooltip" data-bs-title="Cancelar los cambios y restaurar la posiciÃ³n original">
                  âŒ Cancelar
                </button>
              </div>
            </div>

            <!-- Dropdown de Ajustes Avanzados -->
            <div class="mt-3">
              <button class="btn btn-outline-primary w-100" type="button" id="btnAjustesAvanzados" data-bs-toggle="tooltip" data-bs-title="Mostrar/ocultar ajustes avanzados de posiciÃ³n, rotaciÃ³n y dimensiones">
                ğŸ”§ Ajustes Avanzados <span id="advancedArrow">â–¼</span>
              </button>

              <div class="advanced-settings" id="advancedSettings">
                <div class="mt-3">
                  <h6>ğŸ“ PosiciÃ³n y RotaciÃ³n Manual</h6>

                  <div class="coordinate-input">
                    <label for="inputPosX">X:</label>
                    <input type="number" id="inputPosX" class="form-control" step="1" placeholder="PosiciÃ³n X">
                  </div>

                  <div class="coordinate-input">
                    <label for="inputPosY">Y:</label>
                    <input type="number" id="inputPosY" class="form-control" step="1" placeholder="PosiciÃ³n Y">
                  </div>

                  <div class="coordinate-input">
                    <label for="inputAngulo">Ãngulo:</label>
                    <input type="number" id="inputAngulo" class="form-control" min="0" max="360" step="1" placeholder="0-360Â°">
                    <span>Â°</span>
                  </div>

                  <!-- Nuevos campos para dimensiones de calles -->
                  <div id="dimensionesCalleSection" style="display: none;">
                    <hr class="my-3">
                    <h6>ğŸ“ Dimensiones de Calle</h6>

                    <div class="coordinate-input">
                      <label for="inputTamanoEditar">TamaÃ±o:</label>
                      <input type="number" id="inputTamanoEditar" class="form-control" min="10" max="500" step="1" placeholder="TamaÃ±o en celdas">
                      <span>celdas</span>
                    </div>

                    <div class="coordinate-input">
                      <label for="inputCarrilesEditar">Carriles:</label>
                      <input type="number" id="inputCarrilesEditar" class="form-control" min="1" max="10" step="1" placeholder="NÃºmero de carriles">
                      <span>carriles</span>
                    </div>

                    <button id="btnAplicarDimensiones" class="btn btn-sm btn-warning mt-2 w-100" data-bs-toggle="tooltip" data-bs-title="Aplicar cambios de tamaÃ±o y nÃºmero de carriles (elimina vehÃ­culos)">
                      ğŸ“ Aplicar Dimensiones
                    </button>

                    <div class="alert alert-warning p-2 small mt-2">
                      <strong>âš ï¸ Advertencia:</strong> Cambiar las dimensiones reiniciarÃ¡ el contenido de la calle (elimina vehÃ­culos existentes).
                    </div>
                  </div>

                  <button id="btnAplicarPosicion" class="btn btn-sm btn-success mt-2 w-100" data-bs-toggle="tooltip" data-bs-title="Aplicar la posiciÃ³n (X, Y) y Ã¡ngulo de rotaciÃ³n ingresados manualmente">
                    âœ“ Aplicar PosiciÃ³n
                  </button>

                  <div class="mt-3 p-2 bg-light rounded">
                    <small class="text-muted">
                      <strong>ğŸ’¡ Consejo:</strong> Usa el modo ediciÃ³n para arrastrar y rotar visualmente el objeto.
                    </small>
                  </div>
                </div>
              </div>
            </div>

            <!-- NUEVO: SecciÃ³n de Modo Curva (solo para calles) -->
            <div id="curvaModeSection" style="display: none;">
              <div class="mt-3 border-top pt-3">
                <h6>ğŸŒŠ Modo Curva</h6>
                <small class="text-muted d-block mt-2">
                  âŒ¨ï¸ <strong>Presiona la tecla Z</strong> para activar/desactivar el modo de ediciÃ³n de vÃ©rtices
                </small>
                <small class="text-muted d-block mt-1">
                  ğŸ’¡ <strong>Haz clic en un vÃ©rtice</strong> y arrÃ¡stralo perpendicular a la calle para curvarlo (mÃ¡x Â±40Â°)
                </small>
                <small class="text-muted d-block mt-1">
                  ğŸ¯ AparecerÃ¡ una guÃ­a visual azul mostrando la direcciÃ³n de arrastre
                </small>
              </div>
            </div>

            <hr class="my-3">

            <h6 class="mb-3">ğŸ›£ï¸ Agregar Elementos</h6>

            <!-- Botones de agregar -->
            <div class="d-grid gap-2 mb-3">
              <button id="btnAgregarCalle" class="btn btn-outline-primary btn-sm" data-bs-toggle="tooltip" data-bs-title="Abrir formulario para crear una nueva calle en el mapa">
                â• Agregar Calle
              </button>
              <button id="btnAgregarEdificio" class="btn btn-outline-success btn-sm" data-bs-toggle="tooltip" data-bs-title="Abrir formulario para crear un nuevo edificio en el mapa">
                ğŸ¢ Agregar Edificio
              </button>
              <button id="btnEditarEdificio" class="btn btn-outline-warning btn-sm" style="display: none;" data-bs-toggle="tooltip" data-bs-title="Editar configuraciÃ³n del edificio seleccionado (Ctrl+Click para seleccionar)">
                âœï¸ Editar Edificio
              </button>
              <button id="btnAgregarConexion" class="btn btn-outline-secondary btn-sm" data-bs-toggle="tooltip" data-bs-title="Crear una conexiÃ³n entre dos calles para flujo de trÃ¡fico">
                ğŸ”— Agregar ConexiÃ³n
              </button>
              <button id="btnEliminarObjeto" class="btn btn-outline-danger btn-sm" data-bs-toggle="tooltip" data-bs-title="Eliminar permanentemente la calle o edificio seleccionado">
                ğŸ—‘ï¸ Eliminar Objeto Seleccionado
              </button>
            </div>

            <hr class="my-3">

            <h6 class="mb-3">ğŸ”— GestiÃ³n de Conexiones</h6>

            <!-- BotÃ³n para mostrar lista de conexiones -->
            <button id="btnMostrarListaConexiones" class="btn btn-outline-info w-100 mb-2" data-bs-toggle="tooltip" data-bs-title="Mostrar/ocultar lista de todas las conexiones entre calles creadas">
              ğŸ“‹ Ver Conexiones Existentes
            </button>

            <!-- Lista de conexiones (inicialmente oculta) -->
            <div id="listaConexionesContainer" style="display: none;" class="mt-2">
              <div id="listaConexiones" class="list-group small" style="max-height: 300px; overflow-y: auto;">
                <!-- Las conexiones se insertarÃ¡n aquÃ­ dinÃ¡micamente -->
              </div>
            </div>

            <hr class="my-3">

            <div class="alert alert-info p-2 small mb-0">
              <strong>ğŸ’¡ CÃ³mo usar:</strong>
              <ul class="mb-0 mt-1 ps-3">
                <li>Crea calles y edificios con los botones</li>
                <li><kbd>Ctrl</kbd>+Clic en el canvas para seleccionar objetos rÃ¡pidamente</li>
                <li>Usa el modo ediciÃ³n para posicionarlos</li>
                <li>Conecta calles con "Agregar ConexiÃ³n"</li>
                <li>Gestiona conexiones existentes con "Ver Conexiones"</li>
                <li>Guarda tu mapa como archivo JSON</li>
                <li>Carga mapas guardados anteriormente</li>
              </ul>
            </div>
          </div>
        </div>
      </div>

      <!-- Accordion 5: MÃ©tricas en Tiempo Real -->
      <div class="accordion-item">
        <h2 class="accordion-header" id="headingMetrics">
          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseMetrics" aria-expanded="false" aria-controls="collapseMetrics">
            ğŸ“ˆ MÃ©tricas de la SimulaciÃ³n
          </button>
        </h2>
        <div id="collapseMetrics" class="accordion-collapse collapse" aria-labelledby="headingMetrics" data-bs-parent="#controlPanelAccordion">
          <div class="accordion-body p-2">
            <!-- Panel de InterpretaciÃ³n de MÃ©tricas -->
            <div id="statusPanel" class="status-panel status-moderado mb-3">
              <div class="status-header">
                <span class="status-emoji">ğŸŸ¡</span>
                <span class="status-title">INICIANDO...</span>
              </div>
              <div class="status-description">
                Esperando datos de simulaciÃ³n...
              </div>
              <div class="status-metrics">
                <div class="metric-item">
                  <span class="metric-label">Densidad:</span>
                  <span class="metric-value">0.0%</span>
                  <span class="metric-desc">â†’ Muy baja</span>
                </div>
                <div class="metric-item">
                  <span class="metric-label">Flujo:</span>
                  <span class="metric-value">0.0 c/s</span>
                  <span class="metric-desc">â†’ Muy bajo</span>
                </div>
                <div class="metric-item">
                  <span class="metric-label">Velocidad:</span>
                  <span class="metric-value">0.0%</span>
                  <span class="metric-desc">â†’ Casi detenido</span>
                </div>
              </div>
              <div class="status-observations">
                <div class="observations-title">!</div>
              </div>
            </div>

            <div class="chart-container mt-3 mb-3">
              <h6>ğŸš— Densidad de TrÃ¡fico</h6>
              <div style="position: relative; height: 180px;">
                <canvas id="densityChart"></canvas>
              </div>
            </div>

            <div class="chart-container mb-3">
              <h6>ğŸŒŠ Flujo vehicular</h6>
              <div style="position: relative; height: 180px;">
                <canvas id="throughputChart"></canvas>
              </div>
            </div>

            <div class="chart-container mb-3">
              <h6>âš¡ Velocidad Promedio</h6>
              <div style="position: relative; height: 180px;">
                <canvas id="speedChart"></canvas>
              </div>
            </div>

            <div class="chart-container mb-3">
              <h6>ğŸ“Š Tasa de Cambio</h6>
              <div style="position: relative; height: 180px;">
                <canvas id="netGenerationChart"></canvas>
              </div>
            </div>

            <div class="chart-container mb-3">
              <h6>ğŸ”¬ EntropÃ­a de Shannon</h6>
              <div style="position: relative; height: 180px;">
                <canvas id="entropyChart"></canvas>
              </div>
            </div>

            <!-- Mapa de Calor -->
            <div class="mb-3">
              <h6 class="mb-2">ğŸŒ¡ï¸ VisualizaciÃ³n</h6>
              <button id="btnMapaCalor" class="btn btn-outline-primary btn-sm w-100" data-bs-toggle="tooltip" data-bs-title="Muestra un mapa de calor sobre las calles indicando densidad de trÃ¡fico">
                <span id="iconMapaCalor">ğŸ”²</span> Activar Mapa de Calor
              </button>
            </div>

            <hr class="my-3">

            <h6 class="mb-3">ğŸ’¾ Exportar MÃ©tricas</h6>
            <div class="d-grid gap-2">
              <button id="btnDescargarCSV" class="btn btn-success btn-sm" data-bs-toggle="tooltip" data-bs-title="Exportar todas las mÃ©tricas recolectadas en formato CSV">
                Descargar CSV
              </button>
              <button id="btnDescargarJSON" class="btn btn-info btn-sm" data-bs-toggle="tooltip" data-bs-title="Exportar todas las mÃ©tricas recolectadas en formato JSON">
                Descargar JSON
              </button>
              <button id="btnLimpiarMetricas" class="btn btn-danger btn-sm" data-bs-toggle="tooltip" data-bs-title="Borrar todos los datos de mÃ©tricas recolectados y reiniciar grÃ¡ficas">
                Limpiar MÃ©tricas
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Accordion 6: Acerca de FLUVI -->
      <div class="accordion-item">
        <h2 class="accordion-header" id="headingAbout">
          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseAbout" aria-expanded="false" aria-controls="collapseAbout">
            â„¹ï¸ Acerca de FLUVI
          </button>
        </h2>
        <div id="collapseAbout" class="accordion-collapse collapse" aria-labelledby="headingAbout" data-bs-parent="#controlPanelAccordion">
          <div class="accordion-body">
            <h6 class="mb-3">Simulador de Sistema de GestiÃ³n del Flujo Vehicular en Vialidades Cercanas a Ãreas AcadÃ©micas de IPN - ESCOM</h6>

            <p class="text-muted small mb-3">Sistema de simulaciÃ³n basado en autÃ³matas celulares para el anÃ¡lisis de trÃ¡fico vehicular.</p>

            <button class="btn btn-info w-100" data-bs-toggle="modal" data-bs-target="#aboutModal" data-bs-title="Ver informaciÃ³n completa sobre el proyecto FLUVI">
              ğŸ“– Ver InformaciÃ³n Completa
            </button>

            <div class="mt-3">
              <small class="text-muted">
                <strong>VersiÃ³n:</strong> 1.0.0<br>
                <strong>AÃ±o:</strong> 2025
              </small>
            </div>
          </div>
        </div>
      </div>

      </div>
      <!-- FIN ACCORDIONS -->
    </div>
    <!-- FIN contenedor scrolleable -->

    <!-- ConfiguraciÃ³n Global (anclada al fondo del sidebar) -->
    <div class="sidebar-footer-config">
      <!-- Header clickeable para colapsar/expandir -->
      <div class="config-header" id="configHeader">
        <h6 class="config-title">âš™ï¸ ConfiguraciÃ³n</h6>
        <span class="config-chevron">â–¼</span>
      </div>

      <!-- Contenido colapsable -->
      <div class="config-content" id="configContent">
        <!-- Switch Modo Oscuro -->
        <div class="form-check form-switch mb-3">
          <input class="form-check-input" type="checkbox" id="switchModoOscuro">
          <label class="form-check-label" for="switchModoOscuro">
            <span id="labelModoOscuro">ğŸŒ™ Modo Oscuro</span>
          </label>
        </div>

        <!-- Switch Logs de Consola -->
        <div class="form-check form-switch">
          <input class="form-check-input" type="checkbox" id="switchConsoleLogs">
          <label class="form-check-label" for="switchConsoleLogs">
            <span id="labelConsoleLogs">ğŸ“ Logs en Consola</span>
          </label>
        </div>

        <!-- Switch Activador de Celdas -->
        <div class="form-check form-switch mt-2">
          <input class="form-check-input" type="checkbox" id="switchCellDetection">
          <label class="form-check-label" for="switchCellDetection">
            <span id="labelCellDetection">ğŸ”¢ Activador de Celdas</span>
            <span class="ms-1"
                  data-bs-toggle="tooltip"
                  data-bs-placement="right"
                  title="Muestra el nÃºmero de celda en el hover sobre calles. Al activarlo se muestra 'NOMBRE_CALLE : NUMERO_CELDA'. DesactÃ­valo para mejorar el rendimiento (solo mostrarÃ¡ el nombre de la calle)."
                  style="cursor: help;">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-info-circle" viewBox="0 0 16 16">
                <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14m0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16"></path>
                <path d="m8.93 6.588-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.194.897.105 1.319.808 1.319.545 0 1.178-.252 1.465-.598l.088-.416c-.2.176-.492.246-.686.246-.275 0-.375-.193-.304-.533z"></path>
                <circle cx="8" cy="4.5" r="1"></circle>
              </svg>
            </span>
          </label>
        </div>
      </div>
    </div>
  </div>
  <!-- FIN sidebar -->

  <!-- Modal de Instrucciones -->
  <div class="modal fade" id="instructionsModal" tabindex="-1" aria-labelledby="instructionsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title" id="instructionsModalLabel">ğŸ“š GuÃ­a del Simulador de TrÃ¡fico FLUVI</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="row">
            <div class="col-md-6 mb-4">
              <div class="card border-primary">
                <div class="card-body">
                  <h5 class="card-title text-primary">ğŸ–±ï¸ Controles BÃ¡sicos</h5>
                  <ul class="list-unstyled">
                    <li><strong>Zoom:</strong> Rueda del mouse</li>
                    <li><strong>Mover vista:</strong> Arrastrar con el mouse</li>
                    <li><strong>Agregar/quitar vehÃ­culos:</strong> Clic en celdas</li>
                    <li><strong>Minimapa:</strong> Clic para teletransportarse</li>
                  </ul>
                </div>
              </div>
            </div>

            <div class="col-md-6 mb-4">
              <div class="card border-success">
                <div class="card-body">
                  <h5 class="card-title text-success">âš™ï¸ Panel de Control</h5>
                  <ul class="list-unstyled">
                    <li><strong>SelecciÃ³n rÃ¡pida:</strong> Ctrl+Clic sobre calles o edificios en el canvas</li>
                    <li><strong>MenÃº desplegable:</strong> Selecciona objetos manualmente</li>
                    <li><strong>Probabilidades:</strong> Ajusta generaciÃ³n y cambio de carril</li>
                    <li><strong>Aplicar cambios:</strong> BotÃ³n azul al final</li>
                  </ul>
                </div>
              </div>
            </div>

            <div class="col-md-6 mb-4">
              <div class="card border-warning">
                <div class="card-body">
                  <h5 class="card-title text-warning">âœï¸ Modo EdiciÃ³n</h5>
                  <ul class="list-unstyled">
                    <li>1. Selecciona una calle o edificio</li>
                    <li>2. Activa "Modo EdiciÃ³n"</li>
                    <li>3. Arrastra el handle azul para mover</li>
                    <li>4. Arrastra el handle verde para rotar</li>
                    <li>5. Guarda o cancela los cambios</li>
                  </ul>
                </div>
              </div>
            </div>

            <div class="col-md-6 mb-4">
              <div class="card border-info">
                <div class="card-body">
                  <h5 class="card-title text-info">ğŸŒŠ Calles Curvas</h5>
                  <ul class="list-unstyled">
                    <li>1. Selecciona una calle</li>
                    <li>2. Activa "Modo EdiciÃ³n"</li>
                    <li>3. Haz clic en "Editar VÃ©rtices"</li>
                    <li>4. Presiona <kbd>Z</kbd> para activar ediciÃ³n de vÃ©rtices</li>
                    <li>5. Arrastra vÃ©rtices para crear curvas</li>
                    <li>6. Presiona <kbd>Z</kbd> nuevamente para desactivar</li>
                    <li>7. Ãngulo mÃ¡ximo: Â±40Â° por celda</li>
                    <li>8. Usa "Resetear VÃ©rtices" para restaurar</li>
                  </ul>
                </div>
              </div>
            </div>

            <div class="col-md-6 mb-4">
              <div class="card border-info">
                <div class="card-body">
                  <h5 class="card-title text-info">â¸ï¸ Control de SimulaciÃ³n</h5>
                  <ul class="list-unstyled">
                    <li><strong>Pause/Resume:</strong> Detener/continuar simulaciÃ³n</li>
                    <li><strong>Paso a Paso:</strong> Avanzar frame por frame</li>
                    <li><strong>Velocidad:</strong> Ajustar frames por segundo</li>
                    <li><strong>GeneraciÃ³n:</strong> % de apariciÃ³n de vehÃ­culos</li>
                    <li><strong>Hora/Fecha:</strong> Control de tiempo simulado</li>
                  </ul>
                </div>
              </div>
            </div>

            <div class="col-md-6 mb-4">
              <div class="card border-secondary">
                <div class="card-body">
                  <h5 class="card-title text-secondary">ğŸ”— Conexiones</h5>
                  <p>Tipos de conexiones entre calles:</p>
                  <ul class="list-unstyled">
                    <li>ğŸŸ¢ <strong>Verde (Lineal):</strong> 1 a 1 entre carriles</li>
                    <li>ğŸŸ  <strong>Naranja (IncorporaciÃ³n):</strong> Varios a uno</li>
                    <li>ğŸŸ£ <strong>Morado (ProbabilÃ­stica):</strong> Con probabilidad</li>
                    <li>ğŸ”´ <strong>Roja:</strong> ConexiÃ³n bloqueada</li>
                  </ul>
                </div>
              </div>
            </div>

            <div class="col-md-6 mb-4">
              <div class="card border-success">
                <div class="card-body">
                  <h5 class="card-title text-success">ğŸ—ï¸ Constructor de Mapas</h5>
                  <ul class="list-unstyled">
                    <li><strong>Ctrl+Clic:</strong> Selecciona calles y edificios directamente en el canvas</li>
                    <li><strong>Agregar objetos:</strong> Usa los botones para crear calles y edificios</li>
                    <li><strong>Modo ediciÃ³n:</strong> Arrastra y rota objetos visualmente</li>
                    <li><strong>Conexiones:</strong> Conecta calles para crear flujo de trÃ¡fico</li>
                    <li><strong>Guardar/Cargar:</strong> Exporta e importa simulaciones como JSON</li>
                  </ul>
                </div>
              </div>
            </div>

            <div class="col-md-6 mb-4">
              <div class="card border-warning">
                <div class="card-body">
                  <h5 class="card-title text-warning">ğŸ…¿ï¸ Estacionamientos</h5>
                  <ul class="list-unstyled">
                    <li><strong>ConfiguraciÃ³n:</strong> Marca edificio como estacionamiento</li>
                    <li><strong>Capacidad:</strong> Define mÃ¡ximo de vehÃ­culos</li>
                    <li><strong>Conexiones:</strong> Pares de entrada/salida en calles</li>
                    <li><strong>Probabilidades:</strong> Ajusta entrada/salida por cada hora (0-100%)</li>
                    <li><strong>Perfiles:</strong> Normal, Oficina, Centro Comercial</li>
                    <li><strong>ValidaciÃ³n:</strong> Previene configuraciones invÃ¡lidas</li>
                  </ul>
                </div>
              </div>
            </div>

            <div class="col-md-6 mb-4">
              <div class="card border-primary">
                <div class="card-body">
                  <h5 class="card-title text-primary">ğŸ’¾ GestiÃ³n de Escenarios</h5>
                  <ul class="list-unstyled">
                    <li><strong>Guardar:</strong> Exporta configuraciÃ³n completa como JSON</li>
                    <li><strong>Cargar:</strong> Importa escenarios previamente guardados</li>
                    <li><strong>Incluye:</strong> Calles, edificios, estacionamientos</li>
                    <li><strong>Conexiones:</strong> Mantiene todas las conexiones entre calles</li>
                    <li><strong>Probabilidades:</strong> Preserva configuraciones horarias</li>
                  </ul>
                </div>
              </div>
            </div>

            <div class="col-12">
              <div class="card border-primary">
                <div class="card-body">
                  <h5 class="card-title">ğŸ“Š MÃ©tricas del Simulador</h5>
                  <div class="row">
                    <div class="col-md-6">
                      <h6 class="text-primary mt-2">ğŸ“ˆ MÃ©tricas Principales</h6>
                      <ul class="list-unstyled mb-3">
                        <li><strong>Densidad:</strong> % de ocupaciÃ³n de las calles (0-100%)</li>
                        <li><strong>Flujo Vehicular:</strong> VehÃ­culos/segundo segÃºn Q=kÃ—v</li>
                        <li><strong>Tasa de Cambio:</strong> Crecimiento neto de poblaciÃ³n (veh/s)</li>
                        <li><strong>Velocidad Promedio:</strong> % de vehÃ­culos en movimiento</li>
                        <li><strong>EntropÃ­a de Shannon:</strong> Diversidad de reglas del AC (bits)</li>
                      </ul>
                    </div>
                    <div class="col-md-6">
                      <h6 class="text-success mt-2">ğŸ“Š InterpretaciÃ³n Inteligente</h6>
                      <ul class="list-unstyled mb-3">
                        <li>ğŸŸ¢ <strong>Ã“ptimo:</strong> MÃ¡xima eficiencia del sistema</li>
                        <li>ğŸŸ¡ <strong>Moderado:</strong> Condiciones aceptables</li>
                        <li>ğŸŸ  <strong>Congestionado:</strong> Alta densidad con lentitud</li>
                        <li>ğŸ”´ <strong>Colapso:</strong> Calles paralizadas</li>
                        <li>ğŸ”µ <strong>Sub-utilizado:</strong> Baja ocupaciÃ³n</li>
                      </ul>
                    </div>
                  </div>
                  <div class="row">
                    <div class="col-12">
                      <h6 class="text-warning mt-2">ğŸ› ï¸ Herramientas Disponibles</h6>
                      <ul class="list-unstyled mb-2">
                        <li><strong>5 GrÃ¡ficas en Tiempo Real:</strong> Visualiza todas las mÃ©tricas con Chart.js</li>
                        <li><strong>Panel de Estado:</strong> InterpretaciÃ³n automÃ¡tica del trÃ¡fico con recomendaciones</li>
                        <li><strong>Exportar CSV:</strong> Descarga historial completo con estadÃ­sticas</li>
                        <li><strong>Exportar JSON:</strong> Formato estructurado con metadata</li>
                        <li><strong>Limpiar MÃ©tricas:</strong> Reinicia el historial de mediciones</li>
                        <li><strong>Mapa de Calor:</strong> Visualiza densidad por zona geogrÃ¡fica</li>
                      </ul>
                    </div>
                  </div>
                  <div class="alert alert-info mb-0 mt-2">
                    <small><strong>ğŸ’¡ Tips:</strong> Las mÃ©tricas se actualizan cada 5 frames para optimizar rendimiento. El historial de grÃ¡ficas muestra Ãºltimos 50 puntos, pero el CSV exporta TODAS las mediciones desde el inicio.</small>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Nueva Calle -->
  <div class="modal fade" id="modalNuevaCalle" tabindex="-1" aria-labelledby="modalNuevaCalleLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title" id="modalNuevaCalleLabel">â• Agregar Nueva Calle</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="inputNombreCalle" class="form-label">Nombre:</label>
            <input type="text" class="form-control" id="inputNombreCalle" placeholder="Ej: Calle Principal" required maxlength="100">
            <div class="invalid-feedback">
              El nombre debe contener solo caracteres vÃ¡lidos (letras, nÃºmeros, espacios, guiones y puntos).
            </div>
          </div>
          <div class="mb-3">
            <label for="inputTamanoCalle" class="form-label">TamaÃ±o (celdas):</label>
            <input type="number" class="form-control" id="inputTamanoCalle" placeholder="100" min="1" max="2500" value="100" required>
            <div class="invalid-feedback">
              El tamaÃ±o debe estar entre 1 y 2500 celdas.
            </div>
            <small class="form-text text-muted">MÃ¡ximo: 2500 celdas</small>
          </div>
          <div class="mb-3">
            <label for="selectTipoCalle" class="form-label">Tipo:</label>
            <select class="form-select" id="selectTipoCalle">
              <option value="GENERADOR">ğŸš— Generador</option>
              <option value="CONEXION" selected>ğŸ›£ï¸ ConexiÃ³n</option>
              <option value="DEVORADOR">ğŸ Devorador</option>
            </select>
          </div>
          <div class="mb-3">
            <label for="inputCarrilesCalle" class="form-label">NÃºmero de Carriles:</label>
            <input type="number" class="form-control" id="inputCarrilesCalle" placeholder="3" min="1" max="10" value="3" required>
            <div class="invalid-feedback">
              El nÃºmero de carriles debe estar entre 1 y 10.
            </div>
            <small class="form-text text-muted">MÃ¡ximo: 10 carriles</small>
          </div>
          <div class="row">
            <div class="col-md-4 mb-3">
              <label for="inputXCalle" class="form-label">PosiciÃ³n X:</label>
              <input type="number" class="form-control" id="inputXCalle" placeholder="500" value="500" required>
              <div class="invalid-feedback">
                Requerido.
              </div>
            </div>
            <div class="col-md-4 mb-3">
              <label for="inputYCalle" class="form-label">PosiciÃ³n Y:</label>
              <input type="number" class="form-control" id="inputYCalle" placeholder="500" value="500" required>
              <div class="invalid-feedback">
                Requerido.
              </div>
            </div>
            <div class="col-md-4 mb-3">
              <label for="inputAnguloCalle" class="form-label">Ãngulo (Â°):</label>
              <input type="number" class="form-control" id="inputAnguloCalle" placeholder="0" min="0" max="360" value="0" required>
              <div class="invalid-feedback">
                Debe estar entre 0 y 360Â°.
              </div>
            </div>
          </div>
          <!-- Probabilidad de GeneraciÃ³n (solo para tipo GENERADOR) -->
          <div class="mb-3" id="campoGeneracionModal">
            <label for="inputProbGenCalle" class="form-label">
              Probabilidad de GeneraciÃ³n (%)
              <span class="info-icon" data-bs-toggle="tooltip" data-bs-placement="right" data-bs-title="Controla la frecuencia con la que se generan nuevos vehÃ­culos. 0% = sin vehÃ­culos, 100% = generaciÃ³n mÃ¡xima continua. Solo disponible para calles de tipo GENERADOR.">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-info-circle" viewBox="0 0 16 16">
                  <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14m0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16"/>
                  <path d="m8.93 6.588-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.194.897.105 1.319.808 1.319.545 0 1.178-.252 1.465-.598l.088-.416c-.2.176-.492.246-.686.246-.275 0-.375-.193-.304-.533z"/>
                  <circle cx="8" cy="4.5" r="1"/>
                </svg>
              </span>
            </label>
            <input type="number" class="form-control" id="inputProbGenCalle" placeholder="50" min="0" max="100" step="1" value="50">
            <div class="invalid-feedback">
              La probabilidad debe estar entre 0 y 100.
            </div>
            <small class="form-text text-muted">Ejemplo: 50 = 50%, 100 = 100%. Solo disponible para calles de tipo GENERADOR.</small>
          </div>
          <div class="mb-3">
            <label for="inputProbSaltoCalle" class="form-label">
              Probabilidad de Cambio de Carril (%)
              <span class="info-icon" data-bs-toggle="tooltip" data-bs-placement="right" data-bs-title="Define la probabilidad de que un vehÃ­culo cambie de carril cuando es posible. Valores bajos (0-5%) simulan trÃ¡fico ordenado, valores altos (>20%) generan mÃ¡s cambios de carril.">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-info-circle" viewBox="0 0 16 16">
                  <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14m0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16"/>
                  <path d="m8.93 6.588-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.194.897.105 1.319.808 1.319.545 0 1.178-.252 1.465-.598l.088-.416c-.2.176-.492.246-.686.246-.275 0-.375-.193-.304-.533z"/>
                  <circle cx="8" cy="4.5" r="1"/>
                </svg>
              </span>
            </label>
            <input type="number" class="form-control" id="inputProbSaltoCalle" placeholder="2" min="0" max="100" step="1" value="2" required>
            <div class="invalid-feedback">
              La probabilidad debe estar entre 0 y 100.
            </div>
            <small class="form-text text-muted">Ejemplo: 2 = 2%, 10 = 10%</small>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-bs-toggle="tooltip" data-bs-title="Cerrar sin crear la calle">Cancelar</button>
          <button type="button" class="btn btn-primary" id="btnConfirmarNuevaCalle" data-bs-toggle="tooltip" data-bs-title="Crear la calle con los parÃ¡metros ingresados">âœ“ Crear Calle</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Nuevo Edificio -->
  <div class="modal fade" id="modalNuevoEdificio" tabindex="-1" aria-labelledby="modalNuevoEdificioLabel" aria-hidden="true" data-bs-theme="auto">
    <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title fw-bold" id="modalNuevoEdificioLabel">ğŸ¢ Agregar Nuevo Edificio</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <!-- InformaciÃ³n bÃ¡sica -->
          <h6 class="border-bottom pb-2 mb-3 fw-semibold">ğŸ“‹ InformaciÃ³n BÃ¡sica</h6>
          <div class="mb-3">
            <label for="inputNombreEdificio" class="form-label">Nombre:</label>
            <input type="text" class="form-control" id="inputNombreEdificio" placeholder="Ej: Edificio Central">
          </div>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="inputXEdificio" class="form-label">PosiciÃ³n X:</label>
              <input type="number" class="form-control" id="inputXEdificio" placeholder="500" value="500">
            </div>
            <div class="col-md-6 mb-3">
              <label for="inputYEdificio" class="form-label">PosiciÃ³n Y:</label>
              <input type="number" class="form-control" id="inputYEdificio" placeholder="500" value="500">
            </div>
          </div>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="inputWidthEdificio" class="form-label">Ancho:</label>
              <input type="number" class="form-control" id="inputWidthEdificio" placeholder="100" min="1" value="100">
            </div>
            <div class="col-md-6 mb-3">
              <label for="inputHeightEdificio" class="form-label">Alto:</label>
              <input type="number" class="form-control" id="inputHeightEdificio" placeholder="100" min="1" value="100">
            </div>
          </div>
          <div class="mb-3">
            <label for="inputAnguloEdificio" class="form-label">Ãngulo (Â°):</label>
            <input type="number" class="form-control" id="inputAnguloEdificio" placeholder="0" min="0" max="360" value="0">
          </div>

          <!-- ConfiguraciÃ³n de Estacionamiento -->
          <hr>
          <h6 class="border-bottom pb-2 mb-3 fw-semibold">ğŸ…¿ï¸ ConfiguraciÃ³n de Estacionamiento</h6>

          <div class="form-check form-switch mb-3">
            <input class="form-check-input" type="checkbox" id="checkEstacionamiento" onchange="toggleEstacionamientoConfig(this.checked)" style="cursor: pointer;">
            <label class="form-check-label fw-semibold" for="checkEstacionamiento" style="cursor: pointer;">
              Funciona como estacionamiento
            </label>
          </div>

          <div id="configEstacionamiento" style="display: none;">
            <!-- Capacidad -->
            <div class="mb-3">
              <label for="inputCapacidad" class="form-label">Capacidad mÃ¡xima de vehÃ­culos:</label>
              <input type="number" class="form-control" id="inputCapacidad" min="1" max="500" value="50">
            </div>

            <!-- Conexiones -->
            <div class="mb-3">
              <label class="form-label fw-semibold">Conexiones (Entradas/Salidas):</label>
              <div class="alert alert-info small mb-2" role="alert">
                <strong>âš ï¸ Importante:</strong> Las conexiones deben venir en pares (1 entrada â†’ 1 salida). MÃ¡ximo 10 pares.
                <br><small class="text-muted">La entrada y salida NO pueden estar en la misma celda del mismo carril.</small>
              </div>

              <div id="listaConexionesEdificio" class="mb-2 border rounded p-2" style="max-height: 400px; overflow-y: auto; min-height: 50px; background-color: var(--bs-light-bg-subtle);"></div>

              <button type="button" class="btn btn-sm btn-primary" onclick="agregarParConexion()">
                â• Agregar Par (Entrada + Salida)
              </button>
            </div>

            <!-- Probabilidades por hora -->
            <div class="mb-3">
              <label class="form-label fw-semibold">Probabilidades de Entrada/Salida por Hora:</label>
              <div class="alert alert-warning small mb-2" role="alert">
                <strong>â° ConfiguraciÃ³n:</strong> Ajusta las probabilidades para cada hora del dÃ­a (0-23). Los valores van de 0% a 100%.
              </div>

              <div class="btn-group btn-group-sm mb-3 d-flex" role="group">
                <button type="button" class="btn btn-outline-primary flex-fill" onclick="aplicarPerfilHorario('normal')">Normal</button>
                <button type="button" class="btn btn-outline-primary flex-fill" onclick="aplicarPerfilHorario('oficina')">Oficina</button>
                <button type="button" class="btn btn-outline-primary flex-fill" onclick="aplicarPerfilHorario('centro')">Centro Comercial</button>
              </div>

              <div class="row g-3">
                <div class="col-md-6">
                  <label class="form-label small fw-semibold text-success">ğŸŸ¢ Entrada (%)</label>
                  <div id="slidersProbEntrada" class="border rounded p-2" style="max-height: 200px; overflow-y: auto; background-color: var(--bs-light-bg-subtle);"></div>
                </div>
                <div class="col-md-6">
                  <label class="form-label small fw-semibold text-primary">ğŸ”µ Salida (%)</label>
                  <div id="slidersProbSalida" class="border rounded p-2" style="max-height: 200px; overflow-y: auto; background-color: var(--bs-light-bg-subtle);"></div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer bg-light">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">âœ– Cancelar</button>
          <button type="button" class="btn btn-primary" id="btnConfirmarNuevoEdificio">âœ“ Crear Edificio</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Nueva ConexiÃ³n -->
  <div class="modal fade" id="modalNuevaConexion" tabindex="-1" aria-labelledby="modalNuevaConexionLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header bg-secondary text-white">
          <h5 class="modal-title" id="modalNuevaConexionLabel">ğŸ”— Agregar Nueva ConexiÃ³n</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="selectCalleOrigen" class="form-label">Calle Origen:</label>
            <select class="form-select" id="selectCalleOrigen">
              <option value="">Selecciona calle origen...</option>
            </select>
          </div>
          <div class="mb-3">
            <label for="selectCalleDestino" class="form-label">Calle Destino:</label>
            <select class="form-select" id="selectCalleDestino">
              <option value="">Selecciona calle destino...</option>
            </select>
          </div>
          <div class="mb-3">
            <label for="selectTipoConexion" class="form-label">Tipo de ConexiÃ³n:</label>
            <select class="form-select" id="selectTipoConexion">
              <option value="LINEAL" selected>ğŸŸ¢ Lineal (1 a 1)</option>
              <option value="INCORPORACION">ğŸŸ  IncorporaciÃ³n (varios a uno)</option>
              <option value="PROBABILISTICA">ğŸŸ£ ProbabilÃ­stica</option>
            </select>
          </div>

          <!-- Campos especÃ­ficos para INCORPORACION -->
          <div id="camposIncorporacion" style="display: none;">
            <div class="alert alert-info small mb-3">
              <strong>ğŸ’¡ ConexiÃ³n de IncorporaciÃ³n:</strong> Une una calle origen a un carril especÃ­fico de la calle destino en una posiciÃ³n inicial.
            </div>
            <div class="mb-3">
              <label for="selectCarrilDestinoIncorp" class="form-label">Carril Destino:</label>
              <select class="form-select" id="selectCarrilDestinoIncorp">
                <option value="">Selecciona una calle destino primero</option>
              </select>
              <small class="form-text text-muted">Carril al que se incorporarÃ¡n los vehÃ­culos</small>
            </div>
            <div class="mb-3">
              <label for="inputPosInicial" class="form-label">PosiciÃ³n Inicial (celda):</label>
              <input type="number" class="form-control" id="inputPosInicial" placeholder="1" min="1" value="1">
              <small class="form-text text-muted">PosiciÃ³n en la calle destino donde comienza la incorporaciÃ³n</small>
            </div>
          </div>

          <!-- Campos especÃ­ficos para PROBABILISTICA -->
          <div id="camposProbabilistica" style="display: none;">
            <div class="alert alert-info small mb-3">
              <strong>ğŸ’¡ ConexiÃ³n ProbabilÃ­stica:</strong> Define un carril origen y configura la probabilidad y posiciones para cada carril destino disponible.
            </div>

            <div class="mb-3">
              <label for="selectCarrilOrigenProb" class="form-label">Carril Origen:</label>
              <select class="form-select" id="selectCarrilOrigenProb">
                <option value="">Selecciona una calle origen primero</option>
              </select>
              <small class="form-text text-muted">Carril desde el cual saldrÃ¡n los vehÃ­culos</small>
            </div>

            <!-- ConfiguraciÃ³n dinÃ¡mica de distribuciones (uno por cada carril destino) -->
            <div id="contenedorDistribucionesProbabilisticas">
              <!-- Se generarÃ¡ dinÃ¡micamente segÃºn los carriles de la calle destino -->
              <p class="text-muted text-center py-3">Selecciona una calle destino para configurar las salidas</p>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-bs-toggle="tooltip" data-bs-title="Cerrar sin crear la conexiÃ³n">Cancelar</button>
          <button type="button" class="btn btn-primary" id="btnConfirmarNuevaConexion" data-bs-toggle="tooltip" data-bs-title="Crear la conexiÃ³n entre las calles con los parÃ¡metros ingresados">âœ“ Crear ConexiÃ³n</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Editar ConexiÃ³n -->
  <div class="modal fade" id="modalEditarConexion" tabindex="-1" aria-labelledby="modalEditarConexionLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header bg-warning text-dark">
          <h5 class="modal-title" id="modalEditarConexionLabel">âœï¸ Editar ConexiÃ³n</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="alert alert-info small mb-3">
            <strong>ConexiÃ³n:</strong> <span id="editConexionInfo"></span>
          </div>

          <div class="mb-3">
            <label for="editSelectTipoConexion" class="form-label">Tipo de ConexiÃ³n:</label>
            <select class="form-select" id="editSelectTipoConexion">
              <option value="LINEAL">ğŸŸ¢ Lineal (1 a 1)</option>
              <option value="INCORPORACION">ğŸŸ  IncorporaciÃ³n (varios a uno)</option>
              <option value="PROBABILISTICA">ğŸŸ£ ProbabilÃ­stica</option>
            </select>
          </div>

          <!-- Campos especÃ­ficos para INCORPORACION -->
          <div id="editCamposIncorporacion" style="display: none;">
            <div class="mb-3">
              <label for="editSelectCarrilDestinoIncorp" class="form-label">Carril Destino:</label>
              <select class="form-select" id="editSelectCarrilDestinoIncorp">
                <option value="">Selecciona un carril...</option>
              </select>
              <small class="form-text text-muted">Carril al que se incorporarÃ¡n los vehÃ­culos</small>
            </div>
            <div class="mb-3">
              <label for="editInputPosInicial" class="form-label">PosiciÃ³n Inicial (celda):</label>
              <input type="number" class="form-control" id="editInputPosInicial" placeholder="1" min="1" value="1">
              <small class="form-text text-muted">PosiciÃ³n en la calle destino donde comienza la incorporaciÃ³n</small>
            </div>
          </div>

          <!-- Campos especÃ­ficos para PROBABILISTICA -->
          <div id="editCamposProbabilistica" style="display: none;">
            <div class="alert alert-info small mb-3">
              <strong>ğŸ’¡ ConexiÃ³n ProbabilÃ­stica:</strong> Define las salidas con sus probabilidades y posiciones.
            </div>

            <div class="mb-3">
              <label for="editSelectCarrilOrigenProb" class="form-label">Carril Origen:</label>
              <select class="form-select" id="editSelectCarrilOrigenProb">
                <option value="">Cargando...</option>
              </select>
              <small class="form-text text-muted">Carril desde el cual saldrÃ¡n los vehÃ­culos</small>
            </div>

            <!-- ConfiguraciÃ³n dinÃ¡mica de distribuciones -->
            <div id="editContenedorDistribucionesProbabilisticas">
              <p class="text-muted text-center py-3">Cargando configuraciÃ³n...</p>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-bs-toggle="tooltip" data-bs-title="Cerrar sin guardar los cambios">Cancelar</button>
          <button type="button" class="btn btn-warning" id="btnConfirmarEditarConexion" data-bs-toggle="tooltip" data-bs-title="Guardar los cambios realizados en la conexiÃ³n">âœ“ Guardar Cambios</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Acerca de FLUVI -->
  <div class="modal fade" id="aboutModal" tabindex="-1" aria-labelledby="aboutModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-xl modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title" id="aboutModalLabel">â„¹ï¸ Acerca de FLUVI</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="container-fluid">

            <!-- TÃ­tulo del Proyecto -->
            <div class="text-center mb-4">
              <h4 class="text-primary fw-bold">FLUVI</h4>
              <p class="lead">Simulador de Sistema de GestiÃ³n del Flujo Vehicular en Vialidades Cercanas a Ãreas AcadÃ©micas de IPN - ESCOM</p>
            </div>

            <hr class="my-4">

            <!-- Introduction -->
            <section class="mb-5">
              <h5 class="text-primary mb-3">
                <span class="badge bg-primary me-2">1</span>
                IntroducciÃ³n
              </h5>
              <div class="card">
                <div class="card-body">
                  <p>
                    FLUVI es un simulador de trÃ¡fico vehicular basado en <strong>autÃ³matas celulares</strong> diseÃ±ado especÃ­ficamente para analizar y optimizar el flujo de vehÃ­culos en vialidades cercanas a Ã¡reas acadÃ©micas del Instituto PolitÃ©cnico Nacional, con enfoque en la Escuela Superior de CÃ³mputo (ESCOM).
                  </p>
                  <p>
                    El sistema permite modelar escenarios complejos de trÃ¡fico urbano, incluyendo:
                  </p>
                  <ul>
                    <li>MÃºltiples carriles y calles interconectadas</li>
                    <li>GeneraciÃ³n dinÃ¡mica de vehÃ­culos</li>
                    <li>Cambios de carril con probabilidades configurables</li>
                    <li>DetecciÃ³n y resoluciÃ³n de intersecciones</li>
                    <li>VisualizaciÃ³n en tiempo real de mÃ©tricas de trÃ¡fico</li>
                    <li>Calles con curvaturas personalizables</li>
                  </ul>
                  <p>
                    Este proyecto surge de la necesidad de comprender y mejorar la circulaciÃ³n vehicular en zonas acadÃ©micas, permitiendo a investigadores y planificadores urbanos simular diferentes escenarios antes de implementar cambios en la infraestructura real.
                  </p>
                </div>
              </div>
            </section>

            <!-- Algorithms -->
            <section class="mb-5">
              <h5 class="text-primary mb-3">
                <span class="badge bg-primary me-2">2</span>
                Algoritmos
              </h5>
              <div class="card">
                <div class="card-body">
                  <h6 class="fw-bold mb-3">Regla 184 de AutÃ³matas Celulares</h6>
                  <p>
                    FLUVI implementa una versiÃ³n modificada de la <strong>Regla 184</strong>, un autÃ³mata celular unidimensional que simula el flujo de trÃ¡fico de manera eficiente.
                  </p>

                  <div class="alert alert-info">
                    <h6 class="alert-heading">ğŸ“š Â¿QuÃ© es la Regla 184?</h6>
                    <p class="mb-0">
                      La Regla 184 es un autÃ³mata celular que modela el trÃ¡fico vehicular donde cada celda puede estar vacÃ­a (0) o ocupada por un vehÃ­culo (1). Los vehÃ­culos se mueven hacia adelante si la celda siguiente estÃ¡ vacÃ­a, creando un flujo natural de trÃ¡fico.
                    </p>
                  </div>

                  <h6 class="fw-bold mt-4 mb-3">Funcionamiento BÃ¡sico de la Regla 184</h6>
                  <div class="table-responsive">
                    <table class="table table-bordered table-sm">
                      <thead class="table-primary">
                        <tr>
                          <th>Izquierda</th>
                          <th>Centro</th>
                          <th>Derecha</th>
                          <th>â†’</th>
                          <th>Nuevo Estado (Centro)</th>
                        </tr>
                      </thead>
                      <tbody>
                        <tr>
                          <td>1</td>
                          <td>1</td>
                          <td>1</td>
                          <td>â†’</td>
                          <td class="fw-bold">1</td>
                        </tr>
                        <tr>
                          <td>1</td>
                          <td>1</td>
                          <td>0</td>
                          <td>â†’</td>
                          <td class="fw-bold">0</td>
                        </tr>
                        <tr>
                          <td>1</td>
                          <td>0</td>
                          <td>1</td>
                          <td>â†’</td>
                          <td class="fw-bold">1</td>
                        </tr>
                        <tr>
                          <td>1</td>
                          <td>0</td>
                          <td>0</td>
                          <td>â†’</td>
                          <td class="fw-bold">0</td>
                        </tr>
                        <tr>
                          <td>0</td>
                          <td>1</td>
                          <td>1</td>
                          <td>â†’</td>
                          <td class="fw-bold">1</td>
                        </tr>
                        <tr>
                          <td>0</td>
                          <td>1</td>
                          <td>0</td>
                          <td>â†’</td>
                          <td class="fw-bold">1</td>
                        </tr>
                        <tr>
                          <td>0</td>
                          <td>0</td>
                          <td>1</td>
                          <td>â†’</td>
                          <td class="fw-bold">0</td>
                        </tr>
                        <tr>
                          <td>0</td>
                          <td>0</td>
                          <td>0</td>
                          <td>â†’</td>
                          <td class="fw-bold">0</td>
                        </tr>
                      </tbody>
                    </table>
                  </div>

                  <h6 class="fw-bold mt-4 mb-3">ğŸ”§ Modificaciones Implementadas en FLUVI</h6>
                  <p>Hemos adaptado y extendido la Regla 184 clÃ¡sica para soportar escenarios de trÃ¡fico mÃ¡s complejos y realistas:</p>

                  <div class="row g-3">
                    <div class="col-md-6">
                      <div class="card border-primary">
                        <div class="card-body">
                          <h6 class="card-title text-primary">1ï¸âƒ£ Multi-carril</h6>
                          <p class="card-text small">
                            Expandimos la regla unidimensional a un sistema de <strong>mÃºltiples carriles</strong>, permitiendo que los vehÃ­culos cambien de carril basÃ¡ndose en probabilidades configurables.
                          </p>
                        </div>
                      </div>
                    </div>

                    <div class="col-md-6">
                      <div class="card border-success">
                        <div class="card-body">
                          <h6 class="card-title text-success">2ï¸âƒ£ Celdas de Espera</h6>
                          <p class="card-text small">
                            Introducimos el concepto de <strong>celdas en espera</strong> para manejar bloqueos temporales (como intersecciones o conexiones congestionadas), previniendo colisiones.
                          </p>
                        </div>
                      </div>
                    </div>

                    <div class="col-md-6">
                      <div class="card border-warning">
                        <div class="card-body">
                          <h6 class="card-title text-warning">3ï¸âƒ£ Conexiones entre Calles</h6>
                          <p class="card-text small">
                            Implementamos tres tipos de conexiones: <strong>lineales</strong> (1-a-1), <strong>incorporaciÃ³n</strong> (N-a-1) y <strong>probabilÃ­sticas</strong> (1-a-N con distribuciÃ³n).
                          </p>
                        </div>
                      </div>
                    </div>

                    <div class="col-md-6">
                      <div class="card border-danger">
                        <div class="card-body">
                          <h6 class="card-title text-danger">4ï¸âƒ£ ResoluciÃ³n de Intersecciones</h6>
                          <p class="card-text small">
                            Agregamos un sistema de <strong>prioridad alternante</strong> para resolver conflictos en intersecciones, simulando semÃ¡foros o reglas de paso.
                          </p>
                        </div>
                      </div>
                    </div>

                    <div class="col-md-6">
                      <div class="card border-info">
                        <div class="card-body">
                          <h6 class="card-title text-info">5ï¸âƒ£ PrevenciÃ³n de Cruces en X</h6>
                          <p class="card-text small">
                            Implementamos lÃ³gica para <strong>prevenir cambios de carril cruzados</strong> (patrÃ³n X) donde dos vehÃ­culos adyacentes intentan intercambiar carriles simultÃ¡neamente.
                          </p>
                        </div>
                      </div>
                    </div>

                    <div class="col-md-6">
                      <div class="card border-secondary">
                        <div class="card-body">
                          <h6 class="card-title text-secondary">6ï¸âƒ£ Calles Curvas</h6>
                          <p class="card-text small">
                            Extendimos el modelo a <strong>geometrÃ­as no lineales</strong> mediante sistema de vÃ©rtices con interpolaciÃ³n angular para calles con curvaturas.
                          </p>
                        </div>
                      </div>
                    </div>
                  </div>

                  <div class="alert alert-success mt-4">
                    <h6 class="alert-heading">âœ… Resultado</h6>
                    <p class="mb-0">
                      Estas modificaciones permiten simular escenarios de trÃ¡fico urbano complejos manteniendo la eficiencia computacional de los autÃ³matas celulares, con actualizaciones en tiempo real y soporte para miles de vehÃ­culos simultÃ¡neos.
                    </p>
                  </div>
                </div>
              </div>
            </section>

            <!-- File Formats -->
            <section class="mb-5">
              <h5 class="text-primary mb-3">
                <span class="badge bg-primary me-2">3</span>
                Formato de Archivos
              </h5>
              <div class="card">
                <div class="card-body">
                  <p>FLUVI utiliza formato <strong>JSON</strong> para guardar y cargar simulaciones completas.</p>

                  <h6 class="fw-bold mt-3 mb-2">Estructura del archivo JSON:</h6>
                  <pre class="bg-light p-3 rounded"><code>{
  "version": "1.0",
  "nombre": "Nombre de la SimulaciÃ³n",
  "fecha": "2024-01-01T12:00:00.000Z",
  "calles": [
    {
      "nombre": "Calle Principal",
      "tamano": 100,
      "tipo": "CONEXION",
      "carriles": 3,
      "x": 500,
      "y": 300,
      "angulo": 0,
      "probabilidadGeneracion": 0.5,
      "probabilidadSaltoDeCarril": 0.02,
      "esCurva": false,
      "vertices": []
    }
  ],
  "conexiones": [
    {
      "tipo": "LINEAL",
      "origen": "Calle1",
      "destino": "Calle2",
      "carrilOrigen": 0,
      "carrilDestino": 0
    }
  ],
  "edificios": [
    {
      "label": "ESCOM",
      "x": 1000,
      "y": 500,
      "width": 200,
      "height": 150
    }
  ]
}</code></pre>

                  <div class="alert alert-info mt-3">
                    <strong>ğŸ’¡ Consejo:</strong> Puedes exportar tu simulaciÃ³n actual usando el botÃ³n "Guardar SimulaciÃ³n" en el Constructor de Mapas.
                  </div>
                </div>
              </div>
            </section>

            <!-- Known Problems -->
            <section class="mb-5">
              <h5 class="text-primary mb-3">
                <span class="badge bg-primary me-2">4</span>
                Advertencias
              </h5>
              <div class="card">
                <div class="card-body">
                  <p>Algunos problemas conocidos y limitaciones actuales del sistema:</p>
                  <ul>
                    <li><strong>Rendimiento en simulaciones muy grandes:</strong> Simulaciones con mÃ¡s de 50 calles largas pueden experimentar caÃ­das de FPS.</li>
                    <li><strong>Colisiones en curvas muy cerradas:</strong> Curvaturas extremas (Â±40Â°) pueden generar ocasionalmente solapamientos visuales.</li>
                    <li><strong>Compatibilidad con navegadores antiguos:</strong> Requiere soporte de ES6+ y Canvas API.</li>
                  </ul>

                  <div class="alert alert-warning">
                    <strong>âš ï¸ Nota:</strong> Estamos trabajando continuamente en mejoras y correcciones. Si encuentras algÃºn problema, por favor repÃ³rtalo al equipo de desarrollo.
                  </div>
                </div>
              </div>
            </section>

            <!-- Credits -->
            <section class="mb-4">
              <h5 class="text-primary mb-3">
                <span class="badge bg-primary me-2">5</span>
                CrÃ©ditos 
              </h5>
              <div class="card">
                <div class="card-body">
                  <h6 class="fw-bold mb-3">ğŸ‘¥ Equipo de Desarrollo</h6>

                  <div class="row mb-4">
                    <div class="col-md-4 mb-3">
                      <div class="card border-primary">
                        <div class="card-body text-center">
                          <div class="mb-2">ğŸ‘¨â€ğŸ’»</div>
                          <h6 class="card-title">Connor Urbano Mendoza</h6>
                          <p class="card-text small text-muted">soyconnor@outlook.com</p>
                          <p class="card-text small text-muted">Desarrollador</p>
                        </div>
                      </div>
                    </div>
                    <div class="col-md-4 mb-3">
                      <div class="card border-primary">
                        <div class="card-body text-center">
                          <div class="mb-2">ğŸ‘¨â€ğŸ’»</div>
                          <h6 class="card-title">Luis Gael Molina Figueroa</h6>
                          <p class="card-text small text-muted">luisgaelmf@gmail.com </p>
                          <p class="card-text small text-muted">Desarrollador</p>
                        </div>
                      </div>
                    </div>
                    <div class="col-md-4 mb-3">
                      <div class="card border-primary">
                        <div class="card-body text-center">
                          <div class="mb-2">ğŸ‘©â€ğŸ’»</div>
                          <h6 class="card-title">Denisse Marques Morales</h6>
                          <p class="card-text small text-muted">denissemarquez2704@gmail.com</p>
                          <p class="card-text small text-muted">Desarrolladora</p>
                        </div>
                      </div>
                    </div>
                  </div>

<h6 class="fw-bold mb-3 text-center">Directores del Proyecto</h6>

<ul class="list-unstyled text-center mb-0">
  <li>JuÃ¡rez MartÃ­nez Genaro </li>
  <li>Maldonado Castillo Idalia </li>
</ul>

                  <div class="alert alert-info mt-4 mb-0">
                    <h6 class="alert-heading">ğŸ›ï¸ InstituciÃ³n</h6>
                    <p class="mb-1"><strong>Instituto PolitÃ©cnico Nacional (IPN)</strong></p>
                    <p class="mb-0">Escuela Superior de CÃ³mputo (ESCOM)</p>
                    <p class="mb-0">Artificial Life Robotics (ALIROB)</p>
                  </div>
                </div>
              </div>
            </section>

          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Cerrar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal de ConfiguraciÃ³n de Fecha y Hora del Simulador -->
  <div class="modal fade" id="modalTiempoSimulador" tabindex="-1" aria-labelledby="modalTiempoSimuladorLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="modalTiempoSimuladorLabel">ğŸ“… Configurar Fecha y Hora</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p class="text-muted small mb-3">Selecciona el dÃ­a de la semana y la hora de inicio para la simulaciÃ³n. Esto afecta los patrones de trÃ¡fico segÃºn el perfil horario.</p>

          <!-- Selector de DÃ­a de la Semana -->
          <div class="mb-3">
            <label for="selectDiaSemanaModal" class="form-label fw-bold">ğŸ“† DÃ­a de la Semana</label>
            <select class="form-select" id="selectDiaSemanaModal">
              <option value="0">ğŸ”µ Domingo</option>
              <option value="1" selected>ğŸ”´ Lunes</option>
              <option value="2">ğŸŸ  Martes</option>
              <option value="3">ğŸŸ¡ MiÃ©rcoles</option>
              <option value="4">ğŸŸ¢ Jueves</option>
              <option value="5">ğŸŸ£ Viernes</option>
              <option value="6">ğŸŸ¤ SÃ¡bado</option>
            </select>
          </div>

          <!-- Grid para Hora y Minutos -->
          <div class="row">
            <div class="col-6">
              <label for="inputHoraModal" class="form-label fw-bold">ğŸ• Hora</label>
              <input type="number" class="form-control" id="inputHoraModal" min="0" max="23" value="7" placeholder="0-23">
              <small class="text-muted">0-23 horas</small>
            </div>
            <div class="col-6">
              <label for="inputMinutosModal" class="form-label fw-bold">â±ï¸ Minutos</label>
              <input type="number" class="form-control" id="inputMinutosModal" min="0" max="59" value="0" placeholder="0-59">
              <small class="text-muted">0-59 minutos</small>
            </div>
          </div>

          <!-- Vista previa del tiempo seleccionado -->
          <div class="alert alert-info mt-3 mb-0">
            <strong>ğŸ” Vista previa:</strong>
            <div class="mt-2" style="font-size: 1.1rem; font-weight: 600;">
              <span id="previewTiempoSeleccionado">Lunes 07:00</span>
            </div>
          </div>

          <!-- InformaciÃ³n sobre perfiles de trÃ¡fico -->
          <div class="alert alert-warning mt-3 mb-0 small">
            <strong>ğŸ’¡ Nota:</strong> Diferentes dÃ­as y horas tienen distintos multiplicadores de trÃ¡fico. Por ejemplo, las horas pico (7-9 AM, 6-8 PM) en dÃ­as laborales tienen mÃ¡s trÃ¡fico.
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="button" class="btn btn-success" id="btnConfirmarTiempo">
            âœ… Confirmar y Aplicar
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal de Mapa de Calor -->
  <div class="modal fade" id="modalMapaCalor" tabindex="-1" aria-labelledby="modalMapaCalorLabel" data-bs-backdrop="static">
    <div class="modal-dialog modal-fullscreen">
      <div class="modal-content heatmap-modal">
        <!-- Header elegante con gradiente -->
        <div class="modal-header heatmap-header">
          <div class="d-flex align-items-center gap-3">
            <div class="heatmap-icon">ğŸŒ¡ï¸</div>
            <div>
              <h5 class="modal-title mb-0" id="modalMapaCalorLabel">Mapa de Calor - AnÃ¡lisis de TrÃ¡fico</h5>
              <small class="text-muted" id="heatmapSubtitle">Snapshot en tiempo real</small>
            </div>
          </div>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>

        <div class="modal-body heatmap-body">
          <!-- Panel de InformaciÃ³n Superior -->
          <div class="heatmap-info-panel">
            <div class="row g-3 mb-4">
              <!-- EstadÃ­sticas en tiempo real -->
              <div class="col-md-3 col-6">
                <div class="stat-card">
                  <div class="stat-icon">ğŸš—</div>
                  <div class="stat-content">
                    <div class="stat-label">VehÃ­culos Activos</div>
                    <div class="stat-value" id="heatmapVehicles">--</div>
                  </div>
                </div>
              </div>
              <div class="col-md-3 col-6">
                <div class="stat-card">
                  <div class="stat-icon">ğŸ›£ï¸</div>
                  <div class="stat-content">
                    <div class="stat-label">Calles Renderizadas</div>
                    <div class="stat-value" id="heatmapStreets">--</div>
                  </div>
                </div>
              </div>
              <div class="col-md-3 col-6">
                <div class="stat-card">
                  <div class="stat-icon">â±ï¸</div>
                  <div class="stat-content">
                    <div class="stat-label">Tiempo de GeneraciÃ³n</div>
                    <div class="stat-value" id="heatmapTime">--</div>
                  </div>
                </div>
              </div>
              <div class="col-md-3 col-6">
                <div class="stat-card">
                  <div class="stat-icon">ğŸ•</div>
                  <div class="stat-content">
                    <div class="stat-label">Hora Simulada</div>
                    <div class="stat-value" id="heatmapSimTime">--</div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Leyenda mejorada -->
            <div class="heatmap-legend">
              <h6 class="legend-title">ğŸ“Š InterpretaciÃ³n del Mapa</h6>
              <div class="legend-items">
                <div class="legend-item">
                  <div class="legend-color" style="background: linear-gradient(90deg, #00ff00 0%, #7fff00 100%);"></div>
                  <div class="legend-text">
                    <strong>Verde</strong>
                    <span>TrÃ¡fico fluido - Alta velocidad</span>
                  </div>
                </div>
                <div class="legend-item">
                  <div class="legend-color" style="background: linear-gradient(90deg, #ffff00 0%, #ffa500 100%);"></div>
                  <div class="legend-text">
                    <strong>Amarillo</strong>
                    <span>TrÃ¡fico moderado - Velocidad media</span>
                  </div>
                </div>
                <div class="legend-item">
                  <div class="legend-color" style="background: linear-gradient(90deg, #ff6600 0%, #ff0000 100%);"></div>
                  <div class="legend-text">
                    <strong>Rojo</strong>
                    <span>Congestionamiento - Velocidad baja</span>
                  </div>
                </div>
                <div class="legend-item">
                  <div class="legend-color" style="background: #e0e0e0;"></div>
                  <div class="legend-text">
                    <strong>Gris</strong>
                    <span>Sin vehÃ­culos - Celdas vacÃ­as</span>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Canvas del Mapa de Calor -->
          <div class="heatmap-canvas-wrapper">
            <div id="heatmapCanvasContainer" class="heatmap-canvas-container">
              <canvas id="heatmapCanvas"></canvas>
            </div>
          </div>

          <!-- Mensaje de carga elegante -->
          <div id="heatmapLoading" class="heatmap-loading">
            <div class="loading-content">
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Generando mapa de calor...</span>
              </div>
              <p class="loading-text">Generando mapa de calor...</p>
              <small class="text-muted">Analizando densidad de trÃ¡fico en tiempo real</small>
            </div>
          </div>
        </div>

        <!-- Footer mejorado -->
        <div class="modal-footer heatmap-footer">
          <div class="footer-info">
            <small class="text-muted">
              ğŸ’¡ Este anÃ¡lisis representa un snapshot instantÃ¡neo del estado actual del trÃ¡fico
            </small>
          </div>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            <i class="bi bi-x-circle"></i> Cerrar
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <div class="main-content">
    <!-- Barra de InformaciÃ³n estilo Golly -->
    <div class="info-bar">
      <div class="info-bar-content">
        <span class="info-item">
          <span class="info-label">GeneraciÃ³n:</span>
          <span id="infoGeneration" class="info-value">0</span>
        </span>
        <span class="info-separator">|</span>
        <span class="info-item">
          <span class="info-label">VehÃ­culos:</span>
          <span id="infoPopulation" class="info-value">0</span>
        </span>
        <span class="info-separator">|</span>
        <span class="info-item">
          <span class="info-label">Hora:</span>
          <span id="infoSimulatedDateTime" class="info-value">--/--/---- --:--:--</span>
        </span>
        <span class="info-separator">|</span>
        <span class="info-item">
          <span class="info-label">Tiempo/Frame:</span>
          <span id="infoTimePerFrame" class="info-value">0.00s</span>
        </span>
        <span class="info-separator">|</span>
        <span class="info-item">
          <span class="info-label">Mult. de Gen. de VehÃ­c. por hora:</span>
          <span id="infoTrafficMultiplier" class="info-value">1.0Ã—</span>
        </span>
      </div>
    </div>

    <div class="canvas-wrapper">
      <canvas id="simuladorCanvas"></canvas>
      <canvas id="minimapa"></canvas>

      <!-- Control Bar -->
      <div id="canvasControlBar">
        <div id="controlBar" class="align-items-center">
          <!-- Grupo de controles de simulaciÃ³n -->
          <div class="btn-group" role="group">
            <button id="btnPauseResume" class="btn btn-secondary btn-sm" data-bs-toggle="tooltip" data-bs-title="Pausar o reanudar la simulaciÃ³n de trÃ¡fico">â¸</button>
            <button id="btnPaso" class="btn btn-success btn-sm" disabled data-bs-toggle="tooltip" data-bs-title="Avanzar un paso de la simulaciÃ³n (solo disponible cuando estÃ¡ en pausa)">â­</button>
          </div>

          <!-- Grupo de controles de visualizaciÃ³n -->
          <div class="btn-group" role="group">
            <button id="btnConexiones" class="btn btn-info btn-sm" data-bs-toggle="tooltip" data-bs-title="Mostrar/ocultar las conexiones entre calles en el canvas">ğŸ”—</button>
            <button id="btnVertices" class="btn btn-info btn-sm" data-bs-toggle="tooltip" data-bs-title="Mostrar/ocultar los vÃ©rtices de las calles para ediciÃ³n">ğŸ“</button>
            <button id="btnEtiquetas" class="btn btn-info btn-sm" data-bs-toggle="tooltip" data-bs-title="Mostrar/ocultar las etiquetas con nombres de calles y edificios">ğŸ·ï¸</button>
            <button id="btnContadores" class="btn btn-info btn-sm" data-bs-toggle="tooltip" data-bs-title="Mostrar/ocultar contadores de ocupaciÃ³n de estacionamientos">ğŸ”¢</button>
          </div>

          <!-- Grupo de acciones -->
          <div class="btn-group" role="group">
            <button id="btnRandom" class="btn btn-warning btn-sm" data-bs-toggle="tooltip" data-bs-title="Llenar las calles con vehÃ­culos aleatorios">ğŸ²</button>
            <button id="btnBorrar" class="btn btn-danger btn-sm" data-bs-toggle="tooltip" data-bs-title="Borrar todos los vehÃ­culos de todas las calles">ğŸ—‘ï¸</button>
          </div>

          <!-- Controles de velocidad -->
          <div class="d-flex align-items-center gap-1">
            <label for="velocidadSlider" class="form-label mb-0 small">Velocidad:</label>
            <input type="range" class="form-range" id="velocidadSlider" min="1" max="100" step="1" style="width: 80px;" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="Controla la velocidad de la simulaciÃ³n (cuÃ¡ntos ciclos por segundo)">
            <span id="velocidadValor" class="badge bg-primary">10</span>
          </div>

          <!-- Controles de generaciÃ³n -->
          <div class="d-flex align-items-center gap-1">
            <label for="probabilidadSlider" class="form-label mb-0 small">GeneraciÃ³n:</label>
            <input type="range" class="form-range" id="probabilidadSlider" min="0" max="100" step="1" style="width: 80px;" disabled data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="Controla la probabilidad de generaciÃ³n de vehÃ­culos en todos los arreglos tipo GENERADOR (solo activo cuando Perfiles estÃ¡ desactivado)">
            <span id="probabilidadValor" class="badge bg-secondary">10</span>
          </div>

          <!-- Toggle de perfiles dinÃ¡micos -->
          <div class="form-check form-switch flex-shrink-0">
            <input class="form-check-input" type="checkbox" id="togglePerfilesDinamicos" checked onchange="togglePerfiles(this.checked)" data-bs-toggle="tooltip" data-bs-title="Activar/desactivar perfiles dinÃ¡micos de trÃ¡fico segÃºn dÃ­a y hora">
            <label class="form-check-label small" for="togglePerfilesDinamicos">Perfiles</label>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Sistema de Carga -->
  <script src="src/js/ui/loadingSystem.js"></script>

  <!-- Motor GrÃ¡fico PixiJS -->
  <script src="https://cdn.jsdelivr.net/npm/pixi.js@7/dist/pixi.min.js"></script>

  <!-- Motor GrÃ¡fico - Utilidades -->
  <script src="src/js/renderer/utils/CoordinateConverter.js"></script>
  <script src="src/js/renderer/utils/AssetLoader.js"></script>

  <!-- Motor GrÃ¡fico - Core -->
  <script src="src/js/renderer/DayNightCycle.js"></script>
  <script src="src/js/renderer/CameraController.js"></script>
  <script src="src/js/renderer/RainEffect.js"></script>
  <script src="src/js/renderer/SceneManager.js"></script>
  <script src="src/js/renderer/PixiApp.js"></script>

  <!-- Motor GrÃ¡fico - Renderers -->
  <script src="src/js/renderer/renderers/BackgroundAreaRenderer.js"></script>
  <script src="src/js/renderer/renderers/CalleRenderer.js"></script>
  <script src="src/js/renderer/renderers/CarroRenderer.js"></script>
  <script src="src/js/renderer/renderers/EdificioRenderer.js"></script>
  <script src="src/js/renderer/renderers/ConexionRenderer.js"></script>
  <script src="src/js/renderer/renderers/UIRenderer.js"></script>
  <script src="src/js/renderer/renderers/EditorHandles.js"></script>
  <script src="src/js/renderer/renderers/MinimapRenderer.js"></script>

  <!-- Scripts modulares del simulador -->
  <script src="src/js/ui/notifications.js"></script>
  <script src="src/js/ui/HeatmapModal.js"></script>
  <script src="src/js/core/curvas.js"></script>
  <script src="src/js/ui/etiquetas.js"></script>
  <script src="src/js/core/ClickActionManager.js"></script>
  <script src="src/js/core/escenarios.js"></script>
  <script src="src/js/ui/gestionEscenarios.js"></script>
  <script src="src/js/core/tiempo.js"></script>
  <script src="src/js/core/estacionamientos.js"></script>
  <script src="src/js/core/trafico.js"></script>
  <script src="src/js/core/graficas.js"></script>
  <script src="src/js/ui/editor.js"></script>
  <script src="src/js/ui/edificioUI.js"></script>
  <script src="src/js/ui/constructor.js"></script>

  <!-- Bootstrap JS local (incluye Popper) -->
  <script src="./src/bootstrap-5.0.2-dist/js/bootstrap.bundle.min.js"></script>

  <!-- Inicializar tooltips de Bootstrap 5 -->
  <script src="src/js/ui/tooltips.js"></script>

  <!-- Fix para warning de aria-hidden en modales -->
  <script src="src/js/ui/modalFixes.js"></script>

  <!-- Sistema de Control de Logs de Consola -->
  <script src="src/js/ui/consoleControl.js"></script>

  <!-- Sistema de Control de DetecciÃ³n de Celdas -->
  <script src="src/js/ui/cellDetectionControl.js"></script>

  <!-- Sistema de toggle para sidebar responsive -->
  <script src="src/js/ui/sidebarToggle.js"></script>

  <!-- Sistema de InformaciÃ³n en Tiempo Real (estilo Golly) -->
  <script src="src/js/ui/infoBar.js"></script>

  <!-- Control de Fecha y Hora del Simulador -->
  <script src="src/js/ui/timeControl.js"></script>

  <!-- Tooltip global para objetos del canvas (calles y edificios) -->
  <div id="canvasTooltip" style="
    position: fixed;
    display: none;
    background-color: rgba(0, 0, 0, 0.85);
    color: white;
    padding: 8px 12px;
    border-radius: 6px;
    font-size: 14px;
    font-weight: 500;
    pointer-events: none;
    z-index: 10000;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    white-space: nowrap;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
  "></div>

  <!-- Contenedor de Toasts para notificaciones -->
  <div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 11000;">
    <!-- Los toasts se insertarÃ¡n dinÃ¡micamente aquÃ­ -->
  </div>

  <!-- Modal: Guardar Escenario -->
  <div class="modal fade" id="modalGuardarEscenario" tabindex="-1" aria-labelledby="modalGuardarEscenarioLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header bg-success text-white">
          <h5 class="modal-title" id="modalGuardarEscenarioLabel">ğŸ’¾ Guardar Escenario</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="inputNombreEscenario" class="form-label">Nombre del Escenario:</label>
            <input type="text" class="form-control" id="inputNombreEscenario" placeholder="Ej: TrÃ¡fico Pesado DÃ­a Lluvioso" required maxlength="50">
            <div class="invalid-feedback">
              El nombre es obligatorio (mÃ¡ximo 50 caracteres).
            </div>
          </div>
          <div class="mb-3">
            <label for="inputDescripcionEscenario" class="form-label">DescripciÃ³n (opcional):</label>
            <textarea class="form-control" id="inputDescripcionEscenario" rows="3" placeholder="Describe brevemente este escenario..." maxlength="200"></textarea>
            <small class="form-text text-muted">MÃ¡ximo 200 caracteres</small>
          </div>
          <div class="alert alert-info p-2 small mb-0">
            <strong>â„¹ï¸ Se guardarÃ¡:</strong>
            <ul class="mb-0 mt-1">
              <li>Todos los obstÃ¡culos (baches, construcciones, Ã¡rboles)</li>
              <li>Todas las Ã¡reas inundadas</li>
              <li>Todos los bloqueos de carril</li>
              <li>ConfiguraciÃ³n de cada calle afectada</li>
            </ul>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="button" class="btn btn-success" id="btnConfirmarGuardarEscenario">ğŸ’¾ Guardar Escenario</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal: Cargar Escenario -->
  <div class="modal fade" id="modalCargarEscenario" tabindex="-1" aria-labelledby="modalCargarEscenarioLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title" id="modalCargarEscenarioLabel">ğŸ“‚ Cargar Escenario</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p class="text-muted small mb-3">Selecciona un escenario guardado para cargarlo. <strong>Nota:</strong> Se eliminarÃ¡n todos los obstÃ¡culos actuales antes de cargar.</p>

          <!-- BotÃ³n para cargar desde archivo JSON -->
          <div class="mb-3">
            <label for="inputCargarJSON" class="btn btn-outline-success w-100">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-upload me-2" viewBox="0 0 16 16">
                <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5"/>
                <path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708z"/>
              </svg>
              ğŸ“¤ Subir Archivo JSON
            </label>
            <input type="file" id="inputCargarJSON" class="d-none" accept=".json" onchange="cargarDesdeArchivoJSON(event)">
            <small class="form-text text-muted d-block mt-1">
              Carga un escenario desde un archivo .json previamente descargado
            </small>
          </div>

          <hr>

          <h6 class="mb-2">Escenarios en el navegador:</h6>

          <div id="listaEscenariosGuardados" class="list-group">
            <!-- Los escenarios se cargarÃ¡n dinÃ¡micamente aquÃ­ -->
          </div>

          <div id="noEscenariosMessage" class="alert alert-warning text-center" style="display: none;">
            <strong>âš ï¸ No hay escenarios guardados</strong><br>
            <small>Guarda un escenario primero usando el botÃ³n "Guardar" o sube un archivo JSON</small>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
        </div>
      </div>
    </div>
  </div>

</body>
</html>