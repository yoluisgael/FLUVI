<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Simulador de Calles Dinámicas</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.plot.ly/plotly-2.27.0.min.js" charset="utf-8"></script>
  <link rel="stylesheet" href="estilos.css">
  <link rel="stylesheet" href="minimapa.css">
</head>

<body>
  <!-- ========== PANTALLA DE CARGA ========== -->
  <div id="loadingScreen">
    <div class="loading-content">
      <div class="loading-header">
        <h1>🚦 Simulador de Tráfico FLUVI</h1>
        <p>Cargando simulación...</p>
      </div>

      <div class="loading-spinner">
        <div class="spinner"></div>
      </div>

      <div class="instructions">
        <div class="instruction-card">
          <h3>🖱️ Controles Básicos</h3>
          <p>Usa la rueda del mouse para hacer zoom. Arrastra el canvas para moverte. Haz clic en las celdas para agregar/quitar vehículos.</p>
        </div>

        <div class="instruction-card">
          <h3>⚙️ Panel de Control</h3>
          <p>Selecciona calles en el panel izquierdo para modificar probabilidades de generación y cambio de carril.</p>
        </div>

        <div class="instruction-card">
          <h3>⏸️ Simulación</h3>
          <p>Pausa, avanza paso a paso, ajusta la velocidad y visualiza métricas de tu simulación.</p>
        </div>

        <div class="instruction-card">
          <h3>✏️ Modo Edición</h3>
          <p>Selecciona una calle o edificio y activa el modo edición para reposicionar y rotar visualmente.</p>
        </div>

        <div class="instruction-card">
          <h3>🌊 Curvas en Calles</h3>
          <p>Activa el modo curva y arrastra los vértices perpendiculares a la calle para crear curvaturas suaves.</p>
        </div>

        <div class="instruction-card">
          <h3>🚦 Intersecciones</h3>
          <p>Activa la visualización de intersecciones para ver conflictos de tráfico entre calles.</p>
        </div>

        <div class="instruction-card">
          <h3>🔗 Conexiones</h3>
          <p>Muestra las conexiones entre calles: lineales (verde), incorporación (naranja) y probabilísticas (morado).</p>
        </div>
      </div>

      <div class="loading-progress">
        <div class="progress-bar-custom">
          <div class="progress-fill" id="progressFill"></div>
        </div>
        <div class="loading-status" id="loadingStatus">Inicializando recursos...</div>
      </div>
    </div>
  </div>

  <!-- Toggle button for mobile -->
  <button class="sidebar-toggle" id="sidebarToggle">
    <span id="toggleIcon">📊</span>
  </button>

  <!-- Handles de edición (se posicionan dinámicamente) -->
  <div id="moveHandle" class="edit-handle move-handle"></div>
  <div id="rotateHandle" class="edit-handle rotate-handle"></div>

  <!-- Sidebar Panel -->
  <div class="sidebar" id="sidebar">
    <h4>📊 Panel de Control</h4>

    <!-- Indicador de modo edición -->
    <div id="editModeBadge" class="edit-mode-badge">
      🔧 MODO EDICIÓN ACTIVO
    </div>

    <!-- ========== ACCORDIONS ========== -->
    <div class="accordion" id="controlPanelAccordion">

      <!-- Accordion 1: Instrucciones -->
      <div class="accordion-item">
        <h2 class="accordion-header" id="headingInstrucciones">
          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseInstrucciones" aria-expanded="false" aria-controls="collapseInstrucciones">
            📖 Instrucciones
          </button>
        </h2>
        <div id="collapseInstrucciones" class="accordion-collapse collapse" aria-labelledby="headingInstrucciones" data-bs-parent="#controlPanelAccordion">
          <div class="accordion-body">
            <p class="text-muted small mb-3">Aprende a usar el simulador de tráfico</p>
            <button class="btn btn-info w-100" data-bs-toggle="modal" data-bs-target="#instructionsModal">
              📚 Ver Guía Completa
            </button>
          </div>
        </div>
      </div>

      <!-- Accordion 2: Configuración de Objetos -->
      <div class="accordion-item">
        <h2 class="accordion-header" id="headingConfig">
          <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseConfig" aria-expanded="true" aria-controls="collapseConfig">
            ⚙️ Configuración de Objetos
          </button>
        </h2>
        <div id="collapseConfig" class="accordion-collapse collapse show" aria-labelledby="headingConfig" data-bs-parent="#controlPanelAccordion">
          <div class="accordion-body">
            
            <!-- Selector de tipo de objeto -->
            <label for="selectTipoObjeto" class="form-label">Tipo de Objeto:</label>
            <select id="selectTipoObjeto" class="form-select mb-3">
              <option value="">Selecciona tipo...</option>
              <option value="calle">🛣️ Calle</option>
              <option value="edificio">🏢 Edificio</option>
            </select>

            <!-- Selector de Calle -->
            <div id="calleSelector" style="display: none;">
              <label for="selectCalle" class="form-label">Calle:</label>
              <select id="selectCalle" class="form-select mb-3">
                <option value="">Seleccione una calle...</option>
              </select>
            </div>

            <!-- Selector de Edificio -->
            <div id="edificioSelector" style="display: none;">
              <label for="selectEdificio" class="form-label">Edificio:</label>
              <select id="selectEdificio" class="form-select mb-3">
                <option value="">Seleccione un edificio...</option>
              </select>
            </div>

            <!-- Campos de probabilidad (solo para calles) -->
            <div id="calleConfigFields" style="display: none;">
              <label for="inputProbabilidadGeneracion" class="form-label">Probabilidad de Generación (%):</label>
              <input type="number" id="inputProbabilidadGeneracion" class="form-control mb-3" min="0" max="100" step="1" placeholder="0-100">

              <label for="inputProbabilidadSalto" class="form-label">Probabilidad de Cambio de Carril (%):</label>
              <input type="number" id="inputProbabilidadSalto" class="form-control mb-3" min="0" max="100" step="1" placeholder="0-100">
            </div>

            <!-- Botón de modo edición -->
            <button id="btnModoEdicion" class="btn btn-warning w-100 mb-2" disabled>
              ✏️ Modo Edición
            </button>

            <!-- Botones de guardar/cancelar (solo visibles en modo edición) -->
            <div id="editActionButtons" style="display: none;">
              <div class="d-flex gap-2 mb-2">
                <button id="btnGuardarEdicion" class="btn btn-success flex-fill">
                  💾 Guardar
                </button>
                <button id="btnCancelarEdicion" class="btn btn-secondary flex-fill">
                  ❌ Cancelar
                </button>
              </div>
            </div>

            <!-- Dropdown de Ajustes Avanzados -->
            <div class="mt-3">
              <button class="btn btn-outline-primary w-100" type="button" id="btnAjustesAvanzados">
                🔧 Ajustes Avanzados <span id="advancedArrow">▼</span>
              </button>

              <div class="advanced-settings" id="advancedSettings">
                <div class="mt-3">
                  <h6>📍 Posición y Rotación Manual</h6>

                  <div class="coordinate-input">
                    <label for="inputPosX">X:</label>
                    <input type="number" id="inputPosX" class="form-control" step="1" placeholder="Posición X">
                  </div>

                  <div class="coordinate-input">
                    <label for="inputPosY">Y:</label>
                    <input type="number" id="inputPosY" class="form-control" step="1" placeholder="Posición Y">
                  </div>

                  <div class="coordinate-input">
                    <label for="inputAngulo">Ángulo:</label>
                    <input type="number" id="inputAngulo" class="form-control" min="0" max="360" step="1" placeholder="0-360°">
                    <span>°</span>
                  </div>

                  <button id="btnAplicarPosicion" class="btn btn-sm btn-success mt-2 w-100">
                    ✓ Aplicar Posición
                  </button>

                  <div class="mt-3 p-2 bg-light rounded">
                    <small class="text-muted">
                      <strong>💡 Consejo:</strong> Usa el modo edición para arrastrar y rotar visualmente el objeto.
                    </small>
                  </div>
                </div>
              </div>
            </div>

            <!-- Botón aplicar cambios (solo para calles) -->
            <div id="calleApplyButton" style="display: none;">
              <button id="btnActualizarCalle" class="btn btn-primary mt-3 w-100">✓ Aplicar Cambios</button>
            </div>

            <!-- NUEVO: Sección de Modo Curva (solo para calles) -->
            <div id="curvaModeSection" style="display: none;">
              <div class="mt-3 border-top pt-3">
                <h6>🌊 Modo Curva</h6>
                <div class="d-flex gap-2">
                  <button id="btnToggleCurva" class="btn btn-outline-info flex-fill" disabled>
                    🌊 Activar Curvas
                  </button>
                  <button id="btnResetVertices" class="btn btn-outline-secondary flex-fill" disabled>
                    🔄 Resetear
                  </button>
                </div>
                <small class="text-muted d-block mt-2">
                  💡 <strong>Haz clic en un vértice</strong> y arrástralo perpendicular a la calle para curvarlo (máx ±30°)
                </small>
                <small class="text-muted d-block mt-1">
                  🎯 Aparecerá una guía visual azul mostrando la dirección de arrastre
                </small>
              </div>
            </div>

          </div>
        </div>
      </div>

      <!-- Accordion 3: Métricas en Tiempo Real -->
      <div class="accordion-item">
        <h2 class="accordion-header" id="headingMetrics">
          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseMetrics" aria-expanded="false" aria-controls="collapseMetrics">
            📈 Métricas de la Simulación
          </button>
        </h2>
        <div id="collapseMetrics" class="accordion-collapse collapse" aria-labelledby="headingMetrics" data-bs-parent="#controlPanelAccordion">
          <div class="accordion-body p-2">
            <div class="chart-container mb-3">
              <h6>🚗 Densidad de Tráfico</h6>
              <div id="densityChart" style="height: 180px;"></div>
            </div>

            <div class="chart-container mb-3">
              <h6>🌊 Flujo Vehicular</h6>
              <div id="flowChart" style="height: 180px;"></div>
            </div>

            <div class="chart-container">
              <h6>⚡ Velocidad Promedio</h6>
              <div id="speedChart" style="height: 180px;"></div>
            </div>
          </div>
        </div>
      </div>

    </div>
    <!-- FIN ACCORDIONS -->
  </div>

  <!-- Modal de Instrucciones -->
  <div class="modal fade" id="instructionsModal" tabindex="-1" aria-labelledby="instructionsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title" id="instructionsModalLabel">📚 Guía del Simulador de Tráfico FLUVI</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="row">
            <div class="col-md-6 mb-4">
              <div class="card border-primary">
                <div class="card-body">
                  <h5 class="card-title text-primary">🖱️ Controles Básicos</h5>
                  <ul class="list-unstyled">
                    <li><strong>Zoom:</strong> Rueda del mouse</li>
                    <li><strong>Mover vista:</strong> Arrastrar con el mouse</li>
                    <li><strong>Agregar/quitar vehículos:</strong> Clic en celdas</li>
                    <li><strong>Minimapa:</strong> Clic para teletransportarse</li>
                  </ul>
                </div>
              </div>
            </div>

            <div class="col-md-6 mb-4">
              <div class="card border-success">
                <div class="card-body">
                  <h5 class="card-title text-success">⚙️ Panel de Control</h5>
                  <ul class="list-unstyled">
                    <li><strong>Tipo de objeto:</strong> Selecciona calle o edificio</li>
                    <li><strong>Probabilidad de generación:</strong> % de crear vehículos (calles)</li>
                    <li><strong>Cambio de carril:</strong> % de saltar de carril (calles)</li>
                    <li><strong>Aplicar cambios:</strong> Botón azul al final</li>
                  </ul>
                </div>
              </div>
            </div>

            <div class="col-md-6 mb-4">
              <div class="card border-warning">
                <div class="card-body">
                  <h5 class="card-title text-warning">✏️ Modo Edición</h5>
                  <ul class="list-unstyled">
                    <li>1. Selecciona una calle o edificio</li>
                    <li>2. Activa "Modo Edición"</li>
                    <li>3. Arrastra el handle azul para mover</li>
                    <li>4. Arrastra el handle verde para rotar</li>
                    <li>5. Guarda o cancela los cambios</li>
                  </ul>
                </div>
              </div>
            </div>

            <div class="col-md-6 mb-4">
              <div class="card border-info">
                <div class="card-body">
                  <h5 class="card-title text-info">🌊 Modo Curva</h5>
                  <ul class="list-unstyled">
                    <li>1. Selecciona una calle</li>
                    <li>2. Activa "Mostrar Conexiones"</li>
                    <li>3. Haz clic en "Activar Curvas"</li>
                    <li>4. Arrastra vértices perpendicular a la calle</li>
                    <li>5. Curva máxima: ±30°</li>
                    <li>6. Usa "Resetear" para restaurar</li>
                  </ul>
                </div>
              </div>
            </div>

            <div class="col-md-6 mb-4">
              <div class="card border-info">
                <div class="card-body">
                  <h5 class="card-title text-info">⏸️ Simulación</h5>
                  <ul class="list-unstyled">
                    <li><strong>Pause/Resume:</strong> Detener/continuar</li>
                    <li><strong>Paso:</strong> Avanzar frame por frame</li>
                    <li><strong>Velocidad:</strong> Slider de velocidad</li>
                    <li><strong>Generación:</strong> % global de vehículos</li>
                  </ul>
                </div>
              </div>
            </div>

            <div class="col-md-6 mb-4">
              <div class="card border-danger">
                <div class="card-body">
                  <h5 class="card-title text-danger">🚦 Intersecciones</h5>
                  <p>Las intersecciones detectan colisiones entre calles. Al activar la visualización verás:</p>
                  <ul class="list-unstyled">
                    <li>🟣 <strong>Círculos morados:</strong> Puntos de intersección</li>
                    <li>🚗 Sistema de prioridad alternada</li>
                    <li>⏱️ Los vehículos esperan su turno</li>
                  </ul>
                </div>
              </div>
            </div>

            <div class="col-md-6 mb-4">
              <div class="card border-secondary">
                <div class="card-body">
                  <h5 class="card-title text-secondary">🔗 Conexiones</h5>
                  <p>Tipos de conexiones entre calles:</p>
                  <ul class="list-unstyled">
                    <li>🟢 <strong>Verde (Lineal):</strong> 1 a 1 entre carriles</li>
                    <li>🟠 <strong>Naranja (Incorporación):</strong> Varios a uno</li>
                    <li>🟣 <strong>Morado (Probabilística):</strong> Con probabilidad</li>
                    <li>🔴 <strong>Roja:</strong> Conexión bloqueada</li>
                  </ul>
                </div>
              </div>
            </div>

            <div class="col-12">
              <div class="card bg-light">
                <div class="card-body">
                  <h5 class="card-title">📊 Métricas del Simulador</h5>
                  <ul class="list-unstyled">
                    <li><strong>Densidad de Tráfico:</strong> % de ocupación de las calles</li>
                    <li><strong>Flujo Vehicular:</strong> Carros por segundo moviéndose</li>
                    <li><strong>Velocidad Promedio:</strong> % de vehículos en movimiento</li>
                  </ul>
                  <div class="alert alert-info mb-0 mt-3">
                    <small><strong>💡 Tip:</strong> Las métricas se actualizan cada 5 frames de simulación para optimizar el rendimiento.</small>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <div class="main-content">
    <div class="header">
      <h1>🚦 Simulador de Tráfico FLUVI</h1>
    </div>

    <div class="canvas-wrapper">
      <canvas id="simuladorCanvas"></canvas>
      <canvas id="minimapa"></canvas>

      <!-- Control Bar -->
      <div id="canvasControlBar">
        <div id="controlBar" class="d-flex align-items-center">
          <button id="btnConexiones" class="btn btn-info">Mostrar Conexiones</button>
          <button id="btnPauseResume" class="btn btn-secondary me-2">⏸ Pause</button>
          <button id="btnPaso" class="btn btn-success me-2" disabled>⏭ Paso</button>
          <button id="btnIntersecciones" class="btn btn-info me-2">🚦 Intersecciones</button>
          <button id="btnBorrar" class="btn btn-danger me-2">🗑️ Borrar</button>
          <button id="btnRandom" class="btn btn-warning me-3">🎲 Aleatorio</button>
          <label for="velocidadSlider" class="form-label me-2 mb-0">Velocidad:</label>
          <input type="range" class="form-range me-2" id="velocidadSlider" min="1" max="100" step="1" style="width: 100px;">
          <span id="velocidadValor" class="badge bg-primary">10</span>
          <label for="probabilidadSlider" class="form-label ms-3 me-2 mb-0">Generación:</label>
          <input type="range" class="form-range me-2" id="probabilidadSlider" min="0" max="100" step="1" style="width: 100px;">
          <span id="probabilidadValor" class="badge bg-primary">10</span>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ========== SISTEMA DE CARGA ==========
    (function() {
      const loadingScreen = document.getElementById('loadingScreen');
      const progressFill = document.getElementById('progressFill');
      const loadingStatus = document.getElementById('loadingStatus');

      let progress = 0;
      const statusMessages = [
        'Inicializando recursos...',
        'Cargando librerías...',
        'Preparando canvas...',
        'Generando calles...',
        'Calculando intersecciones...',
        'Creando conexiones...',
        'Iniciando simulación...',
        'Listo!'
      ];

      let messageIndex = 0;

      // Simular progreso de carga
      const progressInterval = setInterval(() => {
        progress += Math.random() * 15;

        if (progress >= 100) {
          progress = 100;
          clearInterval(progressInterval);
        }

        progressFill.style.width = progress + '%';

        // Cambiar mensaje según progreso
        const newMessageIndex = Math.floor((progress / 100) * statusMessages.length);
        if (newMessageIndex !== messageIndex && newMessageIndex < statusMessages.length) {
          messageIndex = newMessageIndex;
          loadingStatus.textContent = statusMessages[messageIndex];
        }
      }, 200);

      // Función para ocultar la pantalla de carga
      window.hideLoadingScreen = function() {
        clearInterval(progressInterval);
        progressFill.style.width = '100%';
        loadingStatus.textContent = 'Listo!';

        setTimeout(() => {
          loadingScreen.classList.add('fade-out');
          setTimeout(() => {
            loadingScreen.style.display = 'none';
          }, 500);
        }, 500);
      };

      // Ocultar pantalla cuando todo esté cargado
      window.addEventListener('load', () => {
        // Esperar un mínimo de 2 segundos para que se vean las instrucciones
        setTimeout(() => {
          // Verificar que los scripts principales estén cargados
          if (typeof iniciarSimulacion !== 'undefined') {
            hideLoadingScreen();
          } else {
            // Esperar un poco más si no está listo
            setTimeout(hideLoadingScreen, 1000);
          }
        }, 2000);
      });

      // Backup: ocultar después de 15 segundos máximo
      setTimeout(() => {
        if (loadingScreen && !loadingScreen.classList.contains('fade-out')) {
          console.warn('Forzando cierre de pantalla de carga');
          hideLoadingScreen();
        }
      }, 15000);
    })();

    // ========== MANEJO DE VISIBILIDAD DE SECCIONES ==========
    document.addEventListener('DOMContentLoaded', function() {
      const selectTipoObjeto = document.getElementById('selectTipoObjeto');
      const calleSelector = document.getElementById('calleSelector');
      const edificioSelector = document.getElementById('edificioSelector');
      const calleConfigFields = document.getElementById('calleConfigFields');
      const calleApplyButton = document.getElementById('calleApplyButton');
      const curvaModeSection = document.getElementById('curvaModeSection');

      if (selectTipoObjeto) {
        selectTipoObjeto.addEventListener('change', function() {
          const tipo = this.value;
          
          if (tipo === 'calle') {
            calleSelector.style.display = 'block';
            edificioSelector.style.display = 'none';
            calleConfigFields.style.display = 'block';
            calleApplyButton.style.display = 'block';
            curvaModeSection.style.display = 'block';
          } else if (tipo === 'edificio') {
            calleSelector.style.display = 'none';
            edificioSelector.style.display = 'block';
            calleConfigFields.style.display = 'none';
            calleApplyButton.style.display = 'none';
            curvaModeSection.style.display = 'none';
          } else {
            calleSelector.style.display = 'none';
            edificioSelector.style.display = 'none';
            calleConfigFields.style.display = 'none';
            calleApplyButton.style.display = 'none';
            curvaModeSection.style.display = 'none';
          }
        });
      }
    });
  </script>

  <script src="trafico.js"></script>
  <script src="editor.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>